<!doctype html><html lang=en>
<head>
<title>Snake Eyes: Scopes and IIFE - tamir.dev</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="The HTML5 Herald">
<meta name=author content="Tamir Bahar"><meta property="og:title" content="Snake Eyes: Scopes and IIFE">
<meta property="og:description" content="Where we steal good concepts from other languages to create questionable Python code">
<meta property="og:type" content="article">
<meta property="og:url" content="https://tmr232.github.io/blog/posts/snake-eyes-scopes-and-iife/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2019-12-27T00:00:00+00:00">
<meta property="article:modified_time" content="2019-12-27T00:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Snake Eyes: Scopes and IIFE">
<meta name=twitter:description content="Where we steal good concepts from other languages to create questionable Python code">
<meta name=generator content="Hugo 0.89.0">
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous>
<link rel=stylesheet href=https://tmr232.github.io/blog/fontawesome/css/all.min.css>
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda">
<link rel=stylesheet type=text/css href=https://tmr232.github.io/blog/css/styles.css></head>
<body>
<div id=container>
<header>
<h1>
<a href=https://tmr232.github.io/blog/>tamir.dev</a>
</h1>
<ul id=social-media>
<li>
<a href=https://github.com/tmr232 title=GitHub>
<i class="fab fa-github fa-lg"></i>
</a>
</li>
<li>
<a href=https://twitter.com/tmr232 title=Twitter>
<i class="fab fa-twitter fa-lg"></i>
</a>
</li>
<li>
<a href=https://stackoverflow.com/tmr232 title=StackOverflow>
<i class="fab fa-stack-overflow fa-lg"></i>
</a>
</li>
<li>
<a href=https://dev.to/tmr232 title=devto>
<i class="fab fa-dev fa-lg"></i>
</a>
</li>
</ul>
</header>
<nav>
<ul>
</ul>
</nav>
<main>
<article>
<h1>Snake Eyes: Scopes and IIFE</h1>
<aside>
<ul>
<li>
<time class=post-date datetime=2019-12-27T00:00:00Z>Dec 27, 2019</time>
</li>
<li>
<em>
<a href=https://tmr232.github.io/blog/tags/python>#python</a>
,
<a href=https://tmr232.github.io/blog/tags/misguided>#misguided</a>
,
<a href=https://tmr232.github.io/blog/tags/funny>#funny</a>
</em>
</li>
<li>4 minute read</li>
</ul>
</aside>
<p>One of my pet peeves is taking concepts from other languages and &ldquo;translating&rdquo; them to Python. Not because it makes good code, but because it&rsquo;s a challenge and it makes me happy.</p>
<p>This time, I&rsquo;ve gone after two simple concepts - nested code blocks and IIFE. Both serve similar purposes, and both are missing from Python.</p>
<p>In C++, blocks are often used to limits the lifetime of objects and keep them out of our way when we&rsquo;re done with them. In Python, lifetime is usually less of a concern (as we replace <a href=https://en.cppreference.com/w/cpp/language/raii>RAII</a> and <a href=https://en.cppreference.com/w/cpp/language/destructor>destructors</a> with <a href=https://docs.python.org/3/reference/datamodel.html#context-managers>context-managers</a>), but having variable names out of our way is desirable.</p>
<p><a href=https://en.wikipedia.org/wiki/Immediately_invoked_function_expression>IIFE</a> offers us a bit more in terms of functionality, as it both creates a scope for our operations, and allows us to get a value from that scope. This is useful both for simpler flow control, and for easily initializing const-qualified variables.</p>
<p>Python does not have any of those constructs. There is no way to create a nested code-block in Python (adding another level of indentation would just have it complain about unexpected-indent), and while lambdas exist, they only allow for a single expression, making them mostly irrelevant for IIFE. On the other hand, Python offers us two wonderful constructs that can be used virtually everywhere - classes and functions.</p>
<h2 id=classes--nested-blocks->Classes & Nested Blocks üß±üß±üß±</h2>
<p>In Python, both classes and functions can be nested. You can define a class inside a class, a function in a function, a class in a function or a function in a class. It is all the same. What&rsquo;s more - you can have flow-control in both function (well, obviously) and class bodies (meta-programming much?). Additionally, both nested functions and nested classes create new variable scopes, keeping their insides inside, and are also closures, capable of capturing values from their enclosing scopes. As such, they are the perfect tools for our language-bending shenanigans.</p>
<p>First, nested code blocks. I offer you the following solution:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>f</span>(x):
    print(<span style=color:#e6db74>&#39;Classes are great for creating blocks.&#39;</span>)
    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>_</span>:
        y <span style=color:#f92672>=</span> x <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>
        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;y = </span><span style=color:#e6db74>{</span>y<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)

    print(<span style=color:#e6db74>&#39;y is not defined here.&#39;</span>)
    y

f(<span style=color:#ae81ff>21</span>)
</code></pre></div><p>By defining a class, we create a new scope. Inside it, we can do whatever we want, knowing that the code will get execute inline and in order, and the results will not leak into the enclosing scope.</p>
<p>That said - there are some caveats. First, the class remains in scope, and so do all the variables defined in it. They cannot be garbage collected until the function terminates. You can verify it yourself by trying to access <code>_.y</code> in the above example. To remedy that, we need to get rid of the class, or at least its contents. There are many ways to achieve it:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e># Replace the class with a bool</span>
<span style=color:#a6e22e>@bool</span>
<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>_</span>:
    x <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
    print(x)


<span style=color:#75715e># Replace the class with None</span>
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>empty</span>(<span style=color:#f92672>*</span>args): <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>


<span style=color:#a6e22e>@empty</span>
<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>_</span>:
    x <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
    print(x)


<span style=color:#75715e># Use a metaclass to delete all the variables inside the class</span>
<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BlockMeta</span>(type):
    <span style=color:#66d9ef>def</span> __new__(cls, name, bases, dict_):
        <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>__new__(cls, name, bases, {})


<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Block</span>(metaclass<span style=color:#f92672>=</span>BlockMeta):
    <span style=color:#66d9ef>pass</span>


<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>_</span>(Block):
    x <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
    print(x)

</code></pre></div><p>I am personally torn between the meta-class approach, as it is explicit and clear, and the <code>@bool</code> approach, as it requires to additional boilerplate.</p>
<p>The second issue with classes as blocks is that while they can be nested freely, a nested class cannot access the variables of its nesting class, rendering block-nesting moot. I do not have a solution for that at present.</p>
<h2 id=functions--iife->Functions & IIFE üêçüêçüêç</h2>
<p>With a solution for nested blocks in hand, it is time to get proper IIFE in Python. For that, we&rsquo;ll naturally be using function. Along with those, we&rsquo;ll use a function&rsquo;s best friend - the decorator!</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>iife</span>(f):
    <span style=color:#66d9ef>return</span> f()

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>describe_number</span>(n):
    <span style=color:#a6e22e>@iife</span>
    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>message</span>():
        <span style=color:#66d9ef>if</span> n <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>:
            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>n<span style=color:#e6db74>}</span><span style=color:#e6db74> is smaller than 0&#39;</span>
        <span style=color:#66d9ef>elif</span> n <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>n<span style=color:#e6db74>}</span><span style=color:#e6db74> is larger than 0&#39;</span>
        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>n<span style=color:#e6db74>}</span><span style=color:#e6db74> is 0&#39;</span>

    print(message)

describe_number(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
describe_number(<span style=color:#ae81ff>0</span>)
describe_number(<span style=color:#ae81ff>1</span>)
</code></pre></div><p>Using the decorator, we immediately call the function, binding the function&rsquo;s name to the return value instead of the function itself. A function returning <code>None</code> (or without a return statement) will just bind the name to <code>None</code>.</p>
<p>While this looks a bit more messy, it can also double as a solution for nested blocks. And unlike the class solution - it can be freely nested.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>iife</span>(f):
    <span style=color:#66d9ef>return</span> f()


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>block</span>(f):
    f()


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>f</span>(x):
    print(<span style=color:#e6db74>&#39;Functions are great for creating blocks.&#39;</span>)

    <span style=color:#a6e22e>@block</span>
    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_</span>():
        my_x <span style=color:#f92672>=</span> x <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
        <span style=color:#a6e22e>@iife</span>
        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>y</span>():
            <span style=color:#66d9ef>return</span> my_x <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>

        <span style=color:#a6e22e>@block</span>
        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_</span>():
            print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;y = </span><span style=color:#e6db74>{</span>y<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)

    print(<span style=color:#e6db74>&#39;y is not defined here.&#39;</span>)
    y


f(<span style=color:#ae81ff>20</span>)

</code></pre></div><p>That&rsquo;s it for today. I hope you had some fun.</p>
</article>
<section class=post-nav>
<ul>
<li>
<a href=https://tmr232.github.io/blog/posts/recognizing-ducks/><i class="fa fa-chevron-circle-left"></i> Recognizing Ducks</a>
</li>
<li>
<a href=https://tmr232.github.io/blog/posts/snake-eyes-extension-methods/>Snake Eyes: Extension Methods <i class="fa fa-chevron-circle-right"></i> </a>
</li>
</ul>
</section>
</main>
<footer>
<ul>
<li>
<h6>Copyright ¬© 2021 - Tamir Bahar |
Rendered by <a href=https://gohugo.io title=Hugo>Hugo</a> |
<a href=https://tmr232.github.io/blog/index.xml>Subscribe </a></h6>
</li>
</ul>
</footer>
</div>
<script src=https://tmr232.github.io/blog/js/scripts.js></script>
</body>
</html>