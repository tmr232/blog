<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Invisible Codegen in Go | Tamir Bahar</title><meta name=keywords content><meta name=description content="Go, sorting, and hiding code-generation."><meta name=author content="Tamir Bahar"><link rel=canonical href=https://tamir.dev/posts/invisible-codegen-go/><link crossorigin=anonymous href=/assets/css/stylesheet.0b7a6a59f13c612205962144f1a8f43a859c4d814d43709a9e3e2b0e9353224b.css integrity="sha256-C3pqWfE8YSIFliFE8aj0OoWcTYFNQ3Canj4rDpNTIks=" rel="preload stylesheet" as=style><link rel=icon href=https://tamir.dev/images/profilepic.jpg><link rel=icon type=image/png sizes=16x16 href=https://tamir.dev/images/profilepic.jpg><link rel=icon type=image/png sizes=32x32 href=https://tamir.dev/images/profilepic.jpg><link rel=apple-touch-icon href=https://tamir.dev/images/profilepic.jpg><link rel=mask-icon href=https://tamir.dev/images/profilepic.jpg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=webmention href=https://webmention.io/tamir.dev/webmention><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Invisible Codegen in Go"><meta property="og:description" content="Go, sorting, and hiding code-generation."><meta property="og:type" content="article"><meta property="og:url" content="https://tamir.dev/posts/invisible-codegen-go/"><meta property="og:image" content="https://tamir.dev/images/profilepic.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-12-18T00:00:00+00:00"><meta property="article:modified_time" content="2024-12-18T00:00:00+00:00"><meta property="og:site_name" content="Tamir Bahar"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://tamir.dev/images/profilepic.jpg"><meta name=twitter:title content="Invisible Codegen in Go"><meta name=twitter:description content="Go, sorting, and hiding code-generation."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://tamir.dev/posts/"},{"@type":"ListItem","position":2,"name":"Invisible Codegen in Go","item":"https://tamir.dev/posts/invisible-codegen-go/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Invisible Codegen in Go","name":"Invisible Codegen in Go","description":"Go, sorting, and hiding code-generation.","keywords":[],"articleBody":"After giving some thought to the beauty of sorting in Python, I wanted to see how close to it I can get with Go. As always, when writing library code, we need to balance three competing axes: the readability of the application code using our library; the complexity of our library code; and the runtime-performance of the solution.\n‚ÄúNormal‚Äù Go In Go, the best way to achieve all three is usually to stick with ‚Äúnormal‚Äù Go code, and avoid any advanced trickery. In this case, unfortunately, this was not good enough.\n1 2 # The Python 'gold standard' sorted(people, key=attrgetter(\"age\", \"name\")) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 type Person struct { Name string Age int } people := []Person{ {\"Gopher\", 13}, {\"Alice\", 55}, {\"Bob\", 24}, {\"Alice\", 20}, } // Go's standard solution for comparison // See https://pkg.go.dev/cmp#example-Or-Sort slices.SortFunc(people, func(a, b Person) int { return cmp.Or( strings.Compare(a.Name, b.Name), cmp.Compare(a.Age, b.Age), ) }) Go‚Äôs solution works, it performs well, and has very low library complexity. But it leaves a lot to be desired on the readability front. It‚Äôs 4 lines, declares a function closure, and repeats every attribute name twice.\nReflection Since we can‚Äôt do much better with ‚Äúnormal‚Äù code, we turn to the next candidate - reflection. Go‚Äôs reflect library seems intentionally designed to make reflection a conscious choice; you can‚Äôt just ‚Äúfall into it‚Äù. And for good reason! My solution using reflection turned out to be 20 times slower than the ‚Äúnormal‚Äù solution, and using ~2000 allocations when the first solution used none. It did, however, provide us with a very readable call-site:\n1 slices.SortFunc(people, CmpByFields[Person](\"Name\", \"Age\")) This is more or less a direct translation of the Python syntax to Go, with the only exception being that [Person] type argument, as Go‚Äôs type deduction can‚Äôt do it automatically. Sadly, being very slow and very complex, it does not meet our standards.\nNow we have two solutions. One is fast and simple, but makes for a very verbose call-site. The other, while clean and elegant at the call-site, is slow and hard to maintain. To close that gap, we‚Äôre going to use another type of Go code - code generation.\nCode Generation We‚Äôre going to build it step-by-step, so that we know how all the parts interlink and interoperate.\nThe first step of any code-generation journey is, of course, manual generation. In this case, we can write several implementation of cmp for our Person type. They‚Äôll look something like this:\n1 2 func CmpByFields_Person_Name_Age(a, b Person) int func CmpByFields_Person_Age_Name(a, b Person) int This works, and we can generate those fairly easily, but this is not quite the syntax we‚Äôre going for.\nNext, we‚Äôll write a CmpByFields and use it to return the relevant function based on the arguments we get:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func CmpByFields[T any](fields ...string) func(a, b Person) int { if reflect.TypeOf(*new(T)) != reflect.TypeOf(*new(Person)) { panic(\"not implemented\") } if len(fields) != 2 { panic(\"not implemented\") } if fields[0] == \"Name\" \u0026\u0026 fields[1] == \"Age\" { return CmpByFields_Person_Name_Age } if fields[0] == \"Age\" \u0026\u0026 fields[1] == \"Name\" { return CmpByFields_Person_Age_Name } panic(\"not implemented\") } Yeah, that‚Äôs not great. And it will only get worse as we add more types and field names to sort by. So instead of this, we‚Äôll store them in a map and perform lookups:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 // The key must hold both the struct type and the field names. type mapKey struct { Type reflect.Type Fields string } func newMapKey[T any](fields ...string) mapKey { return mapKey{ Type: reflect.TypeOf(*new(T)), // Slices can't be used in map keys. Fields: strings.Join(fields, \", \"), } } var cmpMap = make(map[mapKey]any) func init() { cmpMap[newMapKey[Person](\"Name\", \"Age\")] = CmpByFields_Person_Name_Age cmpMap[newMapKey[Person](\"Age\", \"Name\")] = CmpByFields_Person_Age_Name } func CmpByFields[T any](fields ...string) func(T, T) int { key := newMapKey[T](fields...) if cmpFunc, ok := cmpMap[key]; ok { return cmpFunc.(func(T, T) int) } panic(\"not implemented\") } That‚Äôs a lot better. A proper lookup1 instead of ad-hoc if-statements. With this, it is time to start generating code!\nFor code-generation, we need to know a few things: what to generate, how to generate it, and where to put it. As we‚Äôve already written a couple of ‚Äúgenerated‚Äù functions by hand, we already know the ‚Äúhow‚Äù, and can convert it to code. For the ‚Äúhow‚Äù we need to know all the different ways the code uses CmpByFields to sort slices of structs. This requires static analysis of the code2, and the detection of all calls to CmpByFields, as well as the types and values used in those.\nWith ‚Äúhow‚Äù and ‚Äúwhat‚Äù known, we need to answer the ‚Äúwhere‚Äù. In our previous code, we had the init() function in the same file that called CmpByFields. Once we generate code, this can‚Äôt work as it will require the code-generation to modify our hand-written code, and we don‚Äôt want that. Instead, we‚Äôll generate a new file for every file we analyze. So for main.go, we‚Äôll generate main_codegen.go which will contain the comparator implementations and the init() function that are required for main.go3. Since all files in a directory are the same Go package, this‚Äôll work perfectly.\nPackaging We have managed to achieve our goal. Our code is highly readable at the call-site; it performs similarly to the ‚Äúnormal‚Äù code; and while the code-generation itself may be a little tricky, the generated code is as simple as can be. We can now use code-generation based sorting freely within our code. But there still is one problem. We can only do this within our code. since the code-generation depends on the CmpByFields function, it is not portable, and we should change that.\nAfter all the work we‚Äôve done, this is a simpler matter of moving some code around. We‚Äôll create a new package, called cmpgen. It will contain our CmpByFields function, as well as the lookup map and the map-key type. But in addition, it will include a Register function for registering new comparator-functions into the map:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 package cmpgen import ( \"fmt\" \"reflect\" \"slices\" \"strings\" ) type mapKey struct { Type reflect.Type Fields string } func newMapKey[T any](fields ...string) mapKey { return mapKey{ Type: reflect.TypeOf(*new(T)), Fields: strings.Join(fields, \", \"), } } var cmpMap = make(map[mapKey]any) func CmpByFields[T any](fields ...string) func(T, T) int { key := newMapKey[T](fields...) if cmpFunc, ok := cmpMap[key]; ok { return cmpFunc.(func(T, T) int) } panic(\"not implemented\") } func Register[T any](fn any, fields ...string) { registry[newMapKey[T](fields...)] = fn } By doing this, we‚Äôll have one central map for all the comparators, for all files we analyze. And all the init() functions will use Register to populate it. With this in place, we‚Äôll be able to use cmpgen.CmpByFields in any package we wish.\nInvisible Code-Generation Personally, I like referring to this as ‚Äúinvisible code generation‚Äù. When you read code that uses CmpByFields there is no indication of any code-generation. What‚Äôs more, you can start writing your code before you run the code-generation, and your IDE will be perfectly happy, giving you all the completion and highlights you need.\nIf you want to the entire code, or even use cmpgen.CmpByFields in your own projects, head over to the cmpgen repo.\nYes, we are using a bit of reflection her to compare struct types. But happens during the lookup phase, and not in the comparator passed to SortFunc, so the performance impact is minimal.¬†‚Ü©Ô∏é\nStatic analysis requires quite a bit of code, so I‚Äôll skip it here. If you‚Äôre interested, take a look at the collection of calls using the callector helper package.¬†‚Ü©Ô∏é\nThere are likely to be duplicate implementation in the generated code, as multiple files will sort the same way. This is not a problem because generation implementation for identical call-sites will be identical. The performance penalty for adding a duplicate key to a map will be truly negligible.¬†‚Ü©Ô∏é\n","wordCount":"1371","inLanguage":"en","datePublished":"2024-12-18T00:00:00Z","dateModified":"2024-12-18T00:00:00Z","author":{"@type":"Person","name":"Tamir Bahar"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://tamir.dev/posts/invisible-codegen-go/"},"publisher":{"@type":"Organization","name":"Tamir Bahar","logo":{"@type":"ImageObject","url":"https://tamir.dev/images/profilepic.jpg"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tamir.dev/ accesskey=h title="Tamir Bahar (Alt + H)">Tamir Bahar</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://tamir.dev/blogvent/ title=blogventüéÑ><span>blogventüéÑ</span></a></li><li><a href=https://tamir.dev/posts/ title=posts><span>posts</span></a></li><li><a href=https://tamir.dev/archives/ title=archives><span>archives</span></a></li><li><a href=https://tamir.dev/index.xml title=rss><span>rss</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" height="13"><g transform="scale(1)"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></g></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://tamir.dev/>Home</a>&nbsp;¬ª&nbsp;<a href=https://tamir.dev/posts/>Posts</a></div><h1 class=post-title>Invisible Codegen in Go</h1><div class=post-description>Go, sorting, and hiding code-generation.</div><div class=post-meta><span title='2024-12-18 00:00:00 +0000 UTC'>Dec 18, 2024</span>&nbsp;¬∑&nbsp;Tamir Bahar</div></header><div class=post-content><p>After giving some thought to the <a href=https://tamir.dev/posts/python-beautiful-sorting/>beauty of sorting in Python</a>, I wanted to see how close to it I can get with Go.
As always, when writing library code, we need to balance three competing axes: the readability of the application code using our library; the complexity of our library code; and the runtime-performance of the solution.</p><h2 id=normal-go><a href=#normal-go>&ldquo;Normal&rdquo; Go<span hidden class=anchor aria-hidden=true href=#normal-go>#</span></a></h2><p>In Go, the best way to achieve all three is usually to stick with &ldquo;normal&rdquo; Go code, and avoid any advanced trickery. In this case, unfortunately, this was not good enough.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># The Python &#39;gold standard&#39;</span>
</span></span><span style=display:flex><span>sorted(people, key<span style=color:#f92672>=</span>attrgetter(<span style=color:#e6db74>&#34;age&#34;</span>, <span style=color:#e6db74>&#34;name&#34;</span>))
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Person</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Name</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Age</span>  <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>people</span> <span style=color:#f92672>:=</span> []<span style=color:#a6e22e>Person</span>{
</span></span><span style=display:flex><span>	{<span style=color:#e6db74>&#34;Gopher&#34;</span>, <span style=color:#ae81ff>13</span>},
</span></span><span style=display:flex><span>	{<span style=color:#e6db74>&#34;Alice&#34;</span>, <span style=color:#ae81ff>55</span>},
</span></span><span style=display:flex><span>	{<span style=color:#e6db74>&#34;Bob&#34;</span>, <span style=color:#ae81ff>24</span>},
</span></span><span style=display:flex><span>	{<span style=color:#e6db74>&#34;Alice&#34;</span>, <span style=color:#ae81ff>20</span>},
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Go&#39;s standard solution for comparison
</span></span></span><span style=display:flex><span><span style=color:#75715e>// See https://pkg.go.dev/cmp#example-Or-Sort
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>slices</span>.<span style=color:#a6e22e>SortFunc</span>(<span style=color:#a6e22e>people</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>a</span>, <span style=color:#a6e22e>b</span> <span style=color:#a6e22e>Person</span>) <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cmp</span>.<span style=color:#a6e22e>Or</span>(
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Compare</span>(<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>Name</span>),
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>cmp</span>.<span style=color:#a6e22e>Compare</span>(<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Age</span>, <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>Age</span>),
</span></span><span style=display:flex><span>		)
</span></span><span style=display:flex><span>	})
</span></span></code></pre></td></tr></table></div></div><p>Go&rsquo;s solution works, it performs well, and has very low library complexity.
But it leaves a lot to be desired on the readability front. It&rsquo;s 4 lines, declares a function closure, and repeats every attribute name twice.</p><h2 id=reflection><a href=#reflection>Reflection<span hidden class=anchor aria-hidden=true href=#reflection>#</span></a></h2><p>Since we can&rsquo;t do much better with &ldquo;normal&rdquo; code, we turn to the next candidate - reflection.
Go&rsquo;s <code>reflect</code> library seems intentionally designed to make reflection a conscious choice; you can&rsquo;t just &ldquo;fall into it&rdquo;.
And for good reason!
<a href=https://gist.github.com/tmr232/e6321d0e025d34d6c8831c1cb300b3e0>My solution using reflection</a> turned out to be 20 times slower than the &ldquo;normal&rdquo; solution, and using ~2000 allocations when the first solution used none.
It did, however, provide us with a very readable call-site:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>slices</span>.<span style=color:#a6e22e>SortFunc</span>(<span style=color:#a6e22e>people</span>, <span style=color:#a6e22e>CmpByFields</span>[<span style=color:#a6e22e>Person</span>](<span style=color:#e6db74>&#34;Name&#34;</span>, <span style=color:#e6db74>&#34;Age&#34;</span>))
</span></span></code></pre></td></tr></table></div></div><p>This is more or less a direct translation of the Python syntax to Go, with the only exception being that <code>[Person]</code> type argument, as Go&rsquo;s type deduction can&rsquo;t do it automatically.
Sadly, being very slow and very complex, it does not meet our standards.</p><p>Now we have two solutions.
One is fast and simple, but makes for a very verbose call-site.
The other, while clean and elegant <em>at the call-site</em>, is slow and hard to maintain.
To close that gap, we&rsquo;re going to use another type of Go code - code generation.</p><h2 id=code-generation><a href=#code-generation>Code Generation<span hidden class=anchor aria-hidden=true href=#code-generation>#</span></a></h2><p>We&rsquo;re going to build it step-by-step, so that we know how all the parts interlink and interoperate.</p><p>The first step of any code-generation journey is, of course, manual generation.
In this case, we can write several implementation of <code>cmp</code> for our <code>Person</code> type.
They&rsquo;ll look something like this:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>CmpByFields_Person_Name_Age</span>(<span style=color:#a6e22e>a</span>, <span style=color:#a6e22e>b</span> <span style=color:#a6e22e>Person</span>) <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>CmpByFields_Person_Age_Name</span>(<span style=color:#a6e22e>a</span>, <span style=color:#a6e22e>b</span> <span style=color:#a6e22e>Person</span>) <span style=color:#66d9ef>int</span>
</span></span></code></pre></td></tr></table></div></div><p>This works, and we can generate those fairly easily, but this is not <em>quite</em> the syntax we&rsquo;re going for.</p><p>Next, we&rsquo;ll write a <code>CmpByFields</code> and use it to return the relevant function based on the arguments we get:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>CmpByFields</span>[<span style=color:#a6e22e>T</span> <span style=color:#a6e22e>any</span>](<span style=color:#a6e22e>fields</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>a</span>, <span style=color:#a6e22e>b</span> <span style=color:#a6e22e>Person</span>) <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>TypeOf</span>(<span style=color:#f92672>*</span>new(<span style=color:#a6e22e>T</span>)) <span style=color:#f92672>!=</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>TypeOf</span>(<span style=color:#f92672>*</span>new(<span style=color:#a6e22e>Person</span>)) {
</span></span><span style=display:flex><span>		panic(<span style=color:#e6db74>&#34;not implemented&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>fields</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#e6db74>&#34;not implemented&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>fields</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Name&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>fields</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Age&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>CmpByFields_Person_Name_Age</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>fields</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Age&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>fields</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Name&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>CmpByFields_Person_Age_Name</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	panic(<span style=color:#e6db74>&#34;not implemented&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Yeah, that&rsquo;s not great.
And it will only get worse as we add more types and field names to sort by.
So instead of this, we&rsquo;ll store them in a map and perform lookups:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// The key must hold both the struct type and the field names.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>mapKey</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Type</span>   <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>Type</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Fields</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newMapKey</span>[<span style=color:#a6e22e>T</span> <span style=color:#a6e22e>any</span>](<span style=color:#a6e22e>fields</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>string</span>) <span style=color:#a6e22e>mapKey</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>mapKey</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Type</span>: <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>TypeOf</span>(<span style=color:#f92672>*</span>new(<span style=color:#a6e22e>T</span>)),
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Slices can&#39;t be used in map keys.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>Fields</span>: <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>fields</span>, <span style=color:#e6db74>&#34;, &#34;</span>),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>cmpMap</span> = make(<span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>mapKey</span>]<span style=color:#a6e22e>any</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cmpMap</span>[<span style=color:#a6e22e>newMapKey</span>[<span style=color:#a6e22e>Person</span>](<span style=color:#e6db74>&#34;Name&#34;</span>, <span style=color:#e6db74>&#34;Age&#34;</span>)] = <span style=color:#a6e22e>CmpByFields_Person_Name_Age</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cmpMap</span>[<span style=color:#a6e22e>newMapKey</span>[<span style=color:#a6e22e>Person</span>](<span style=color:#e6db74>&#34;Age&#34;</span>, <span style=color:#e6db74>&#34;Name&#34;</span>)] = <span style=color:#a6e22e>CmpByFields_Person_Age_Name</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>CmpByFields</span>[<span style=color:#a6e22e>T</span> <span style=color:#a6e22e>any</span>](<span style=color:#a6e22e>fields</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>T</span>, <span style=color:#a6e22e>T</span>) <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>key</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>newMapKey</span>[<span style=color:#a6e22e>T</span>](<span style=color:#a6e22e>fields</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cmpFunc</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cmpMap</span>[<span style=color:#a6e22e>key</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cmpFunc</span>.(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>T</span>, <span style=color:#a6e22e>T</span>) <span style=color:#66d9ef>int</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	panic(<span style=color:#e6db74>&#34;not implemented&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>That&rsquo;s a lot better.
A proper lookup<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> instead of ad-hoc if-statements.
With this, it is time to start generating code!</p><p>For code-generation, we need to know a few things: what to generate, how to generate it, and where to put it.
As we&rsquo;ve already written a couple of &ldquo;generated&rdquo; functions by hand, we already know the &ldquo;how&rdquo;, and can convert it to code.
For the &ldquo;how&rdquo; we need to know all the different ways the code uses <code>CmpByFields</code> to sort slices of structs.
This requires static analysis of the code<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>, and the detection of all calls to <code>CmpByFields</code>, as well as the types and values used in those.</p><p>With &ldquo;how&rdquo; and &ldquo;what&rdquo; known, we need to answer the &ldquo;where&rdquo;.
In our previous code, we had the <code>init()</code> function in the same file that called <code>CmpByFields</code>.
Once we generate code, this can&rsquo;t work as it will require the code-generation to modify our hand-written code, and we don&rsquo;t want that.
Instead, we&rsquo;ll generate a new file for every file we analyze.
So for <code>main.go</code>, we&rsquo;ll generate <code>main_codegen.go</code> which will contain the comparator implementations and the <code>init()</code> function that are required for <code>main.go</code><sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>.
Since all files in a directory are the same Go package, this&rsquo;ll work perfectly.</p><h2 id=packaging><a href=#packaging>Packaging<span hidden class=anchor aria-hidden=true href=#packaging>#</span></a></h2><p>We have managed to achieve our goal.
Our code is highly readable at the call-site; it performs similarly to the &ldquo;normal&rdquo; code; and while the code-generation itself may be a little tricky, the generated code is as simple as can be.
We can now use code-generation based sorting freely within our code.
But there still is one problem.
We can only do this within <em>our</em> code.
since the code-generation depends on the <code>CmpByFields</code> function, it is not portable, and we should change that.</p><p>After all the work we&rsquo;ve done, this is a simpler matter of moving some code around.
We&rsquo;ll create a new package, called <code>cmpgen</code>.
It will contain our <code>CmpByFields</code> function, as well as the lookup map and the map-key type. But in addition, it will include a <code>Register</code> function for registering new comparator-functions into the map:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>cmpgen</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;reflect&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;slices&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;strings&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>mapKey</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Type</span>   <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>Type</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Fields</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newMapKey</span>[<span style=color:#a6e22e>T</span> <span style=color:#a6e22e>any</span>](<span style=color:#a6e22e>fields</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>string</span>) <span style=color:#a6e22e>mapKey</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>mapKey</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Type</span>: <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>TypeOf</span>(<span style=color:#f92672>*</span>new(<span style=color:#a6e22e>T</span>)),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Fields</span>: <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>fields</span>, <span style=color:#e6db74>&#34;, &#34;</span>),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>cmpMap</span> = make(<span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>mapKey</span>]<span style=color:#a6e22e>any</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>CmpByFields</span>[<span style=color:#a6e22e>T</span> <span style=color:#a6e22e>any</span>](<span style=color:#a6e22e>fields</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>T</span>, <span style=color:#a6e22e>T</span>) <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>key</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>newMapKey</span>[<span style=color:#a6e22e>T</span>](<span style=color:#a6e22e>fields</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cmpFunc</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cmpMap</span>[<span style=color:#a6e22e>key</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cmpFunc</span>.(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>T</span>, <span style=color:#a6e22e>T</span>) <span style=color:#66d9ef>int</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	panic(<span style=color:#e6db74>&#34;not implemented&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Register</span>[<span style=color:#a6e22e>T</span> <span style=color:#a6e22e>any</span>](<span style=color:#a6e22e>fn</span> <span style=color:#a6e22e>any</span>, <span style=color:#a6e22e>fields</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>registry</span>[<span style=color:#a6e22e>newMapKey</span>[<span style=color:#a6e22e>T</span>](<span style=color:#a6e22e>fields</span><span style=color:#f92672>...</span>)] = <span style=color:#a6e22e>fn</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>By doing this, we&rsquo;ll have one central map for all the comparators, for all files we analyze.
And all the <code>init()</code> functions will use <code>Register</code> to populate it.
With this in place, we&rsquo;ll be able to use <code>cmpgen.CmpByFields</code> in any package we wish.</p><h2 id=invisible-code-generation><a href=#invisible-code-generation>Invisible Code-Generation<span hidden class=anchor aria-hidden=true href=#invisible-code-generation>#</span></a></h2><p>Personally, I like referring to this as &ldquo;invisible code generation&rdquo;.
When you read code that uses <code>CmpByFields</code> there is no indication of any code-generation.
What&rsquo;s more, you can start writing your code <em>before</em> you run the code-generation, and your IDE will be perfectly happy, giving you all the completion and highlights you need.</p><p>If you want to the entire code, or even use <code>cmpgen.CmpByFields</code> in your own projects, head over to <a href=https://github.com/tmr232/cmpgen/>the cmpgen repo</a>.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Yes, we are using a bit of reflection her to compare <code>struct</code> types. But happens during the lookup phase, and not in the comparator passed to <code>SortFunc</code>, so the performance impact is minimal.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Static analysis requires quite a bit of code, so I&rsquo;ll skip it here. If you&rsquo;re interested, take a look at <a href=https://github.com/tmr232/cmpgen/blob/main/cmd/cmpgen/cmpgen.go#L112>the collection of calls</a> using the <a href=https://github.com/tmr232/cmpgen/blob/main/callector/callector.go><code>callector</code> helper package</a>.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>There are likely to be duplicate implementation in the generated code, as multiple files will sort the same way. This is not a problem because generation implementation for identical call-sites will be identical. The performance penalty for adding a duplicate key to a map will be truly negligible.&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags></ul><div style=display:flex;justify-content:center class=discuss><a href=https://github.com/tmr232/tamir.dev/discussions/15 target=_blank rel="noopener noreferrer me" title="Discuss this post">Discuss this post<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" height="1em" style="margin-bottom:-.2em;margin-left:.2em"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://tamir.dev/>Tamir Bahar</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>