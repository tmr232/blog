<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>A Functional-Style State Machine in C++, Part 2 | Tamir Bahar</title><meta name=keywords content><meta name=description content="First, an apology. The first part of this post was published on May 26. It is now September. I had most of the code for this part done by then. But finalizing the code took some more effort. Once that was done, explaining took a while. There were quite a few things I had to learn myself first. So now, months later, I present this humble offering to the Gods of C++ and template meta-programming."><meta name=author content><link rel=canonical href=https://tamir.dev/posts/a-functional-style-state-machine-in-cpp-part-2/><link crossorigin=anonymous href=/assets/css/stylesheet.45644aa474dc79df40198665054ee839f669de372852cf1df60cb49538828f48.css integrity="sha256-RWRKpHTced9AGYZlBU7oOfZp3jcoUs8d9gy0lTiCj0g=" rel="preload stylesheet" as=style><link rel=icon href=https://tamir.dev/images/profilepic.jpg><link rel=icon type=image/png sizes=16x16 href=https://tamir.dev/images/profilepic.jpg><link rel=icon type=image/png sizes=32x32 href=https://tamir.dev/images/profilepic.jpg><link rel=apple-touch-icon href=https://tamir.dev/images/profilepic.jpg><link rel=mask-icon href=https://tamir.dev/images/profilepic.jpg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="A Functional-Style State Machine in C++, Part 2"><meta property="og:description" content="First, an apology. The first part of this post was published on May 26. It is now September. I had most of the code for this part done by then. But finalizing the code took some more effort. Once that was done, explaining took a while. There were quite a few things I had to learn myself first. So now, months later, I present this humble offering to the Gods of C++ and template meta-programming."><meta property="og:type" content="article"><meta property="og:url" content="https://tamir.dev/posts/a-functional-style-state-machine-in-cpp-part-2/"><meta property="og:image" content="https://tamir.dev/images/profilepic.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-09-04T00:00:00+00:00"><meta property="article:modified_time" content="2017-09-04T00:00:00+00:00"><meta property="og:site_name" content="Tamir Bahar"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://tamir.dev/images/profilepic.jpg"><meta name=twitter:title content="A Functional-Style State Machine in C++, Part 2"><meta name=twitter:description content="First, an apology. The first part of this post was published on May 26. It is now September. I had most of the code for this part done by then. But finalizing the code took some more effort. Once that was done, explaining took a while. There were quite a few things I had to learn myself first. So now, months later, I present this humble offering to the Gods of C++ and template meta-programming."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://tamir.dev/posts/"},{"@type":"ListItem","position":2,"name":"A Functional-Style State Machine in C++, Part 2","item":"https://tamir.dev/posts/a-functional-style-state-machine-in-cpp-part-2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"A Functional-Style State Machine in C++, Part 2","name":"A Functional-Style State Machine in C\u002b\u002b, Part 2","description":"First, an apology. The first part of this post was published on May 26. It is now September. I had most of the code for this part done by then. But finalizing the code took some more effort. Once that was done, explaining took a while. There were quite a few things I had to learn myself first. So now, months later, I present this humble offering to the Gods of C++ and template meta-programming.","keywords":[],"articleBody":"First, an apology. The first part of this post was published on May 26. It is now September. I had most of the code for this part done by then. But finalizing the code took some more effort. Once that was done, explaining took a while. There were quite a few things I had to learn myself first. So now, months later, I present this humble offering to the Gods of C++ and template meta-programming.\nGeneralizing In Part 1 we created our State or SelfReturning class (provided below for reference). It works, but as you can see - required modifications whenever we change the function arguments or return types.\nCompilation\n1 2 3 4 5 6 7 8 9 10 11 struct SelfReturning { using RetType = std::pair\u003cSelfReturning, const Context\u003e; using FuncType = RetType(*)(const Context\u0026, Event); SelfReturning(FuncType func) : _func{func} {}; RetType operator()(const Context\u0026 ctx, Event evt) { return _func(ctx, evt); } FuncType _func; }; using State = SelfReturning; The first thing we want to do is get rid of this requirement. First, function arguments. Compilation\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 template \u003cclass... Args\u003e struct SelfReturning { using RetType = std::pair\u003cSelfReturning, const Context\u003e; using FuncType = RetType(*)(Args... args); // (1) SelfReturning(FuncType func) : _func{func} {}; RetType operator()(Args... args) { // (2) return _func(std::forward\u003cArgs\u003e(args)...); } FuncType _func; }; using State = SelfReturning\u003cconst Context\u0026, Event\u003e; Here we use variadic templates and perfect forwarding to forward all the function arguments directly to the target function. You can see that in (1) and (2) we use Args... and not the common Args\u0026\u0026.... This is because the types are defined by the class template and are not deduced on the function call.\nWith this behind us, we address the return type. Here we come to another recursive issue. While the return type std::pair depends on our SelfReturning type, SelfReturning itself depends on the return type. This means that just passing in the return type will not work (much like our original return-type issue). To solve it, we use a template-template parameter.\nCompilation\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 template \u003ctemplate \u003cclass T\u003e class Base, class... Args\u003e // (1) struct SelfReturning { using RetType = Base\u003cSelfReturning\u003e; //(2) using FuncType = RetType(*)(Args... args); SelfReturning(FuncType func) : _func{ func } {} RetType operator() (Args... args) { return _func(std::forward\u003cArgs\u003e(args)...); } FuncType _func; }; template \u003cclass T\u003e using PairWithCtx = std::pair\u003cT, const Context\u003e; // (3) using State = SelfReturning\u003cPairWithCtx, const Context\u0026, Event\u003e; In (1), we pass in the template for the return type. In (2), we instantiate the type with our SelfReturning class. As weâ€™ve seen before, C++ allows this type of recursion, so weâ€™re safe. In (3) we define our return-type template to be a pair with a const Context as the second member. Done.\nBut what if we want to only return the SelfReturning class? For that, we define a new template - an identity template.\n1 2 3 4 5 6 7 template \u003cclass T\u003e struct identity { using type = T; }; template \u003cclass T\u003e using identity_t = typename identity\u003cT\u003e::type; We define the identity struct to hold a type, and use the identity_t alias to access the type directly. This looks a bit odd, but C++ does not allow us to alias the template parameter directly. When isntatiating the identity_t template with a type, we get the safe type again. Using that, we can return SelfReturning directly.\n1 using State = SelfReturning\u003cidentity_t\u003e; Personally, though, I hate having to write down the trivial cases explicitly. So letâ€™s use some dirty tricks.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 template \u003ctemplate \u003cclass T\u003e class Base = identity_t, class... Args\u003e // (1) struct SelfReturning { using RetType = Base\u003cSelfReturning\u003e; using FuncType = RetType(*)(Args... args); SelfReturning(FuncType func) : _func{ func } {} RetType operator() (Args... args) { return _func(std::forward\u003cArgs\u003e(args)...); } FuncType _func; template \u003cclass... AltArgs\u003e using WithArgs = SelfReturning\u003cBase, AltArgs...\u003e; // (2) }; In (1) we simply add identity_t as the default argument for Base. This lets us write the most trivial case (return SelfReturning, take no arguments) as SelfReturning\u003c\u003e. Nice. However, if we put anything into this set of template arguments, it will override identity_t. Thatâ€™s what the code at (2) is for. We set WithArgs to be SelfReturning with whatever Base parameter it already has, thus only accepting template parameters for the arguments. Now we can write all of the following with ease. Compilation\n1 2 3 4 5 6 7 using Trivial = SelfReturning\u003c\u003e; using InPair = SelfReturning\u003cPairWithCtx\u003e; using TrivialWithArgs = SelfReturning\u003c\u003e::WithArgs\u003cContext\u0026, Event\u003e; using InPairWithArgs = SelfReturning\u003cPairWithCtx\u003e::WithArgs\u003cconst Context\u0026, Event\u003e; // Or alternatively using InPairWithArgs2 = SelfReturning\u003cPairWithCtx, const Context\u0026, Event\u003e; In Part 1 I promised generalizing the SelfReturning class and getting some compile time guarantees. Weâ€™ve accomplished our generalization goal, so itâ€™s time to get some safety in place.\nIncreasing Safety While our use of the switch statement to discern different events is nice and concise, it is also somewhat error prone. It is easy to miss a case (though that can be prevented using compiler errors) or accidentally mistake one event for another. The latter is especially true if we want to pass information along with our event notification. One easy way to avoid those mistakes is to resolve the choice using function overloading instead of switch statements. Consider the following\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 #include // (1) enum class EventType {A, B}; void Switch(EventType evt) { switch(evt) { case EventType::A: puts(\"A\"); return; case EventType::B: puts(\"B\"); return; } } // (2) struct EventA {}; struct EventB {}; void Overload(EventA) { puts(\"A\"); } void Overload(EventB) { puts(\"B\"); } In (1) we use a switch to discern the event type. It is easy to forget a return or a break. If we passed more data along, the signature for Switch would likely change to void Switch(EventType evt, void* data). Thatâ€™s definitely bad. In (2), we cannot mistake the types, and data can easily be passed inside the event structs. Sadly, the events are not different types, and C++ does not allow for heterogeneous containers. Or does it?\nEnter C++17â€™s âœ¨std::variantâœ¨.\nWhat is std::variant, you ask? Well, it is a union. A safe union! Safe meaning that you can only get a value from it if it really is there. No more type confusion; no more casting void pointers. But how do we get the values out of std::variant? Using std::visit, of course! Compilation, Execution\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 #include #include #include struct EventA {}; // (1) struct EventB {}; struct EventHandler { // (2) void operator() (EventA) { puts(\"A\"); } void operator() (EventB) { puts(\"B\"); } }; using event_t = std::variant\u003cEventA, EventB\u003e; int main() { std::vector\u003cevent_t\u003e events = {EventA{}, EventB{}}; for (auto\u0026 event : events) { std::visit(EventHandler{}, event); // (3) } return 0; } In (1) we define our new event types. This time they are different types, not just different values. In (2) we define our event handler. All we need is an function overload for every possible type, and a struct with multiple operator() methods is an easy way to do it. Now all that is left to do is call std::visit with our handler and an event. If we forget to handle an event type - the code does not compile! This way, we know that we always handle all event types, and never mix them up.\nNow, if you liked the previous part, you probably donâ€™t like writing a different handler class for every function. It completely ruins the locality of the code. But, we are using C++17, arenâ€™t we? Compilation, Execution\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 #include #include #include template\u003cclass... Ts\u003e struct overloaded : Ts... { using Ts::operator()...; }; // (1) template\u003cclass... Ts\u003e overloaded(Ts...) -\u003e overloaded\u003cTs...\u003e; struct EventA {}; struct EventB {}; using event_t = std::variant\u003cEventA, EventB\u003e; int main() { std::vector\u003cevent_t\u003e events = {EventA{}, EventB{}}; for (auto\u0026 event : events) { std::visit(overloaded { // (2) [] (EventA) { puts(\"A\"); }, [] (EventB) { puts(\"B\"); } }, event); } return 0; } If youâ€™re not familiar with C++17, there may be a lot to take in here. In (1) we define a class that takes multiple lambdas and overloads them. In (2) we instantiate that class to inline our event handling functions. The full explanation to this code is a bit long, so I wrote another post to explain it.\nApplied to the state-machine, it will look like this: Compilation, Execution\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 #include #include #include #include template\u003cclass... Ts\u003e struct overloaded : Ts... { using Ts::operator()...; }; template\u003cclass... Ts\u003e overloaded(Ts...) -\u003e overloaded\u003cTs...\u003e; struct EventA {}; struct EventB {}; using Event = std::variant\u003cEventA, EventB\u003e; struct Context { Context Inc() const { return Context{counter + 1}; } int counter = 0; }; template \u003cclass T\u003e struct identity { using type = T; }; template \u003cclass T\u003e using identity_t = typename identity\u003cT\u003e::type; template \u003ctemplate \u003cclass T\u003e class Base = identity_t, class... Args\u003e struct SelfReturning { using RetType = Base\u003cSelfReturning\u003e; using FuncType = RetType(*)(Args... args); SelfReturning(FuncType func) : _func{ func } {} RetType operator() (Args... args) { return _func(std::forward\u003cArgs\u003e(args)...); } FuncType _func; template \u003cclass... AltArgs\u003e using WithArgs = SelfReturning\u003cBase, AltArgs...\u003e; }; template \u003cclass T\u003e using PairWithCtx = std::pair\u003cT, const Context\u003e; using State = SelfReturning\u003cPairWithCtx\u003e::WithArgs\u003cconst Context\u0026, Event\u003e; State::RetType A(const Context\u0026, Event); State::RetType B(const Context\u0026, Event); State::RetType A(const Context\u0026 ctx, Event evt) { printf(\"State A, counter = %d\\n\", ctx.counter); return std::visit(overloaded{ [\u0026] (EventA) { return make_pair(A, ctx); }, [\u0026] (EventB) { return make_pair(B, ctx.Inc()); } }, evt); } State::RetType B(const Context\u0026 ctx, Event evt) { printf(\"State B, counter = %d\\n\", ctx.counter); return std::visit(overloaded{ [\u0026] (EventA) { return make_pair(A, ctx.Inc()); }, [\u0026] (EventB) { return make_pair(B, ctx); } }, evt); } int main() { State state = A; Context ctx{}; Event events[] = {EventB{}, EventA{}, EventB{}, EventA{}, }; for (auto evt : events) { std::tie(state, ctx) = state(ctx, evt); } return 0; } As you can see, the change is minimal.\nPassing In Data With that, it is time to address an issue I completely neglected in Part 1. Passing in data.\nOur current state-machine model is based on the idea that the events themselves are the only information the states need. This is naive. In many real-life scenarios, events carry data with them. Now, with std::variant, we can puts data into the different event types. All we need to do is add data-members to our event structs. We define our new, data-carrying events as follows:\n1 2 3 4 5 6 struct EventA { const char* msg{nullptr}; }; struct EventB { int number{0}; }; Nothing else needs to change. And now, in the state functions, we can easily access the event data:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 State::RetType A(const Context\u0026 ctx, Event evt) { printf(\"State A, counter = %d\\n\", ctx.counter); return std::visit(overloaded{ [\u0026] (EventA e) { if (e.msg != nullptr) { printf(\"A message = \\\"%s\\\"\", e.msg); } else { puts(\"A message = nullptr\"); } return make_pair(A, ctx); }, [\u0026] (EventB) { return make_pair(B, ctx.Inc()); } }, evt); } State::RetType B(const Context\u0026 ctx, Event evt) { printf(\"State B, counter = %d\\n\", ctx.counter); return std::visit(overloaded{ [\u0026] (EventA e) { return make_pair(A, ctx.Inc()); }, [\u0026] (EventB e) { printf(\"B number = %d\\n\", e.number); return make_pair(B, ctx); } }, evt); } Et voilÃ .\nPutting everything together now, we get the following code:\nCompilation,Execution\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 #include #include #include #include template\u003cclass... Ts\u003e struct overloaded : Ts... { using Ts::operator()...; }; template\u003cclass... Ts\u003e overloaded(Ts...) -\u003e overloaded\u003cTs...\u003e; struct EventA { const char* msg{nullptr}; }; struct EventB { int number{0}; }; using Event = std::variant\u003cEventA, EventB\u003e; struct Context { Context Inc() const { return Context{counter + 1}; } int counter = 0; }; template \u003cclass T\u003e struct identity { using type = T; }; template \u003cclass T\u003e using identity_t = typename identity\u003cT\u003e::type; template \u003ctemplate \u003cclass T\u003e class Base = identity_t, class... Args\u003e struct SelfReturning { using RetType = Base\u003cSelfReturning\u003e; using FuncType = RetType(*)(Args... args); SelfReturning(FuncType func) : _func{ func } {} RetType operator() (Args... args) { return _func(std::forward\u003cArgs\u003e(args)...); } FuncType _func; template \u003cclass... AltArgs\u003e using WithArgs = SelfReturning\u003cBase, AltArgs...\u003e; }; template \u003cclass T\u003e using PairWithCtx = std::pair\u003cT, const Context\u003e; using State = SelfReturning\u003cPairWithCtx\u003e::WithArgs\u003cconst Context\u0026, Event\u003e; State::RetType A(const Context\u0026, Event); State::RetType B(const Context\u0026, Event); State::RetType A(const Context\u0026 ctx, Event evt) { printf(\"State A, counter = %d\\n\", ctx.counter); return std::visit(overloaded{ [\u0026] (EventA e) { if (e.msg != nullptr) { printf(\"A message = \\\"%s\\\"\", e.msg); } else { puts(\"A message = nullptr\"); } return make_pair(A, ctx); }, [\u0026] (EventB) { return make_pair(B, ctx.Inc()); } }, evt); } State::RetType B(const Context\u0026 ctx, Event evt) { printf(\"State B, counter = %d\\n\", ctx.counter); return std::visit(overloaded{ [\u0026] (EventA e) { return make_pair(A, ctx.Inc()); }, [\u0026] (EventB e) { printf(\"B number = %d\\n\", e.number); return make_pair(B, ctx); } }, evt); } int main() { State state = A; Context ctx{}; Event events[] = {EventB{}, EventA{}, EventB{}, EventB{10}, EventA{}, EventA{\"Hello, world!\"}}; for (auto evt : events) { std::tie(state, ctx) = state(ctx, evt); } return 0; } Summary As promised, we have used some dark template magic to achieve:\nA nice generalization of SelfReturning, allowing customization of both return types and argument types; Better compile-time safety by replacing the switch statement with overload resolution; Passing data along with the events. Hopefully, a lot of fun along the way. ","wordCount":"2468","inLanguage":"en","datePublished":"2017-09-04T00:00:00Z","dateModified":"2017-09-04T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://tamir.dev/posts/a-functional-style-state-machine-in-cpp-part-2/"},"publisher":{"@type":"Organization","name":"Tamir Bahar","logo":{"@type":"ImageObject","url":"https://tamir.dev/images/profilepic.jpg"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tamir.dev/ accesskey=h title="Tamir Bahar (Alt + H)">Tamir Bahar</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://tamir.dev/blogvent/ title=blogventðŸŽ„><span>blogventðŸŽ„</span></a></li><li><a href=https://tamir.dev/posts/ title=posts><span>posts</span></a></li><li><a href=https://tamir.dev/archives/ title=archives><span>archives</span></a></li><li><a href=https://tamir.dev/index.xml title=rss><span>rss</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" height="13"><g transform="scale(1)"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></g></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://tamir.dev/>Home</a>&nbsp;Â»&nbsp;<a href=https://tamir.dev/posts/>Posts</a></div><h1 class=post-title>A Functional-Style State Machine in C++, Part 2</h1><div class=post-meta><span title='2017-09-04 00:00:00 +0000 UTC'>Sep 4, 2017</span></div></header><div class=post-content><p>First, an apology.
The first part of this post was published on May 26. It is now September. I had most of the code for this part done by then. But finalizing the code took some more effort. Once that was done, explaining took a while. There were quite a few things I had to learn myself first.
So now, months later, I present this humble offering to the Gods of C++ and template meta-programming.</p><hr><h2 id=generalizing><a href=#generalizing>Generalizing<span hidden class=anchor aria-hidden=true href=#generalizing>#</span></a></h2><p>In <a href=/posts/a-functional-style-state-machine-in-cpp/>Part 1</a> we created our <code>State</code> or <code>SelfReturning</code> class (provided below for reference). It works, but as you can see - required modifications whenever we change the function arguments or return types.</p><p><a href=https://godbolt.org/g/1XqEhY>Compilation</a></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>SelfReturning</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>using</span> RetType <span style=color:#f92672>=</span> std<span style=color:#f92672>::</span>pair<span style=color:#f92672>&lt;</span>SelfReturning, <span style=color:#66d9ef>const</span> Context<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>using</span> FuncType <span style=color:#f92672>=</span> RetType(<span style=color:#f92672>*</span>)(<span style=color:#66d9ef>const</span> Context<span style=color:#f92672>&amp;</span>, Event);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    SelfReturning(FuncType func) <span style=color:#f92672>:</span> _func{func} {};
</span></span><span style=display:flex><span>    RetType <span style=color:#a6e22e>operator</span>()(<span style=color:#66d9ef>const</span> Context<span style=color:#f92672>&amp;</span> ctx, Event evt) { <span style=color:#66d9ef>return</span> _func(ctx, evt); }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    FuncType _func;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> State <span style=color:#f92672>=</span> SelfReturning;
</span></span></code></pre></td></tr></table></div></div><p>The first thing we want to do is get rid of this requirement. First, function arguments.
<a href=https://godbolt.org/g/RNnzcc>Compilation</a></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span><span style=color:#960050;background-color:#1e0010>... </span><span style=color:#a6e22e>Args</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>SelfReturning</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>using</span> RetType <span style=color:#f92672>=</span> std<span style=color:#f92672>::</span>pair<span style=color:#f92672>&lt;</span>SelfReturning, <span style=color:#66d9ef>const</span> Context<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>using</span> FuncType <span style=color:#f92672>=</span> RetType(<span style=color:#f92672>*</span>)(Args... args);      <span style=color:#75715e>// (1)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    SelfReturning(FuncType func) <span style=color:#f92672>:</span> _func{func} {};
</span></span><span style=display:flex><span>    RetType <span style=color:#a6e22e>operator</span>()(Args... args) {              <span style=color:#75715e>// (2)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> _func(std<span style=color:#f92672>::</span>forward<span style=color:#f92672>&lt;</span>Args<span style=color:#f92672>&gt;</span>(args)...);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    FuncType _func;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> State <span style=color:#f92672>=</span> SelfReturning<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>const</span> Context<span style=color:#f92672>&amp;</span>, Event<span style=color:#f92672>&gt;</span>;
</span></span></code></pre></td></tr></table></div></div><p>Here we use <a href=http://en.cppreference.com/w/cpp/language/parameter_pack>variadic templates</a> and <a href=http://en.cppreference.com/w/cpp/utility/forward>perfect forwarding</a> to forward all the function arguments directly to the target function. You can see that in (1) and (2) we use <code>Args...</code> and not the common <code>Args&&...</code>. This is because the types are defined by the class template and are not deduced on the function call.</p><p>With this behind us, we address the return type.
Here we come to another recursive issue. While the return type <code>std::pair&lt;SelfReturning, const Context></code> depends on our <code>SelfReturning</code> type, <code>SelfReturning</code> itself depends on the return type. This means that just passing in the return type will not work (much like our original return-type issue). To solve it, we use a <a href=http://en.cppreference.com/w/cpp/language/template_parameters>template-template parameter</a>.</p><p><a href=https://godbolt.org/g/DVgRPx>Compilation</a></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>T</span><span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Base</span>, <span style=color:#66d9ef>class</span><span style=color:#960050;background-color:#1e0010>... </span><span style=color:#a6e22e>Args</span><span style=color:#f92672>&gt;</span> <span style=color:#75715e>// (1)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>SelfReturning</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>using</span> RetType <span style=color:#f92672>=</span> Base<span style=color:#f92672>&lt;</span>SelfReturning<span style=color:#f92672>&gt;</span>; <span style=color:#75715e>//(2)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>using</span> FuncType <span style=color:#f92672>=</span> RetType(<span style=color:#f92672>*</span>)(Args... args);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    SelfReturning(FuncType func) <span style=color:#f92672>:</span> _func{ func } {}
</span></span><span style=display:flex><span>    RetType <span style=color:#a6e22e>operator</span>() (Args... args) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> _func(std<span style=color:#f92672>::</span>forward<span style=color:#f92672>&lt;</span>Args<span style=color:#f92672>&gt;</span>(args)...);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    FuncType _func;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>T</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> PairWithCtx <span style=color:#f92672>=</span> std<span style=color:#f92672>::</span>pair<span style=color:#f92672>&lt;</span>T, <span style=color:#66d9ef>const</span> Context<span style=color:#f92672>&gt;</span>; <span style=color:#75715e>// (3)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> State <span style=color:#f92672>=</span> SelfReturning<span style=color:#f92672>&lt;</span>PairWithCtx, <span style=color:#66d9ef>const</span> Context<span style=color:#f92672>&amp;</span>, Event<span style=color:#f92672>&gt;</span>;
</span></span></code></pre></td></tr></table></div></div><p>In (1), we pass in the template for the return type. In (2), we instantiate the type with our <code>SelfReturning</code> class. As we&rsquo;ve seen before, C++ allows this type of recursion, so we&rsquo;re safe. In (3) we define our return-type template to be a pair with a <code>const Context</code> as the second member.
Done.</p><p>But what if we want to only return the <code>SelfReturning</code> class? For that, we define a new template - an identity template.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>T</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>identity</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>using</span> type <span style=color:#f92672>=</span> T;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>T</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> identity_t <span style=color:#f92672>=</span> <span style=color:#66d9ef>typename</span> identity<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;::</span>type;
</span></span></code></pre></td></tr></table></div></div><p>We define the <code>identity</code> struct to hold a type, and use the <code>identity_t</code> alias to access the type directly. This looks a bit odd, but C++ does not allow us to alias the template parameter directly. When isntatiating the <code>identity_t</code> template with a type, we get the safe type again. Using that, we can return <code>SelfReturning</code> directly.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>using</span> State <span style=color:#f92672>=</span> SelfReturning<span style=color:#f92672>&lt;</span>identity_t<span style=color:#f92672>&gt;</span>;
</span></span></code></pre></td></tr></table></div></div><p>Personally, though, I hate having to write down the trivial cases explicitly. So let&rsquo;s use some dirty tricks.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>T</span><span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Base</span> <span style=color:#f92672>=</span> identity_t, <span style=color:#66d9ef>class</span><span style=color:#960050;background-color:#1e0010>... </span><span style=color:#a6e22e>Args</span><span style=color:#f92672>&gt;</span> <span style=color:#75715e>// (1)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>SelfReturning</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>using</span> RetType <span style=color:#f92672>=</span> Base<span style=color:#f92672>&lt;</span>SelfReturning<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>using</span> FuncType <span style=color:#f92672>=</span> RetType(<span style=color:#f92672>*</span>)(Args... args);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    SelfReturning(FuncType func) <span style=color:#f92672>:</span> _func{ func } {}
</span></span><span style=display:flex><span>    RetType <span style=color:#a6e22e>operator</span>() (Args... args) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> _func(std<span style=color:#f92672>::</span>forward<span style=color:#f92672>&lt;</span>Args<span style=color:#f92672>&gt;</span>(args)...);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    FuncType _func;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span><span style=color:#960050;background-color:#1e0010>... </span><span style=color:#a6e22e>AltArgs</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>using</span> WithArgs <span style=color:#f92672>=</span> SelfReturning<span style=color:#f92672>&lt;</span>Base, AltArgs...<span style=color:#f92672>&gt;</span>; <span style=color:#75715e>// (2)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span></code></pre></td></tr></table></div></div><p>In (1) we simply add <code>identity_t</code> as the default argument for <code>Base</code>. This lets us write the most trivial case (return <code>SelfReturning</code>, take no arguments) as <code>SelfReturning&lt;></code>. Nice.
However, if we put anything into this set of template arguments, it will override <code>identity_t</code>. That&rsquo;s what the code at (2) is for. We set <code>WithArgs</code> to be <code>SelfReturning</code> with whatever <code>Base</code> parameter it already has, thus only accepting template parameters for the arguments. Now we can write all of the following with ease.
<a href=https://godbolt.org/g/xvtKaE>Compilation</a></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>using</span> Trivial <span style=color:#f92672>=</span> SelfReturning<span style=color:#f92672>&lt;&gt;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> InPair <span style=color:#f92672>=</span> SelfReturning<span style=color:#f92672>&lt;</span>PairWithCtx<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> TrivialWithArgs <span style=color:#f92672>=</span> SelfReturning<span style=color:#f92672>&lt;&gt;::</span>WithArgs<span style=color:#f92672>&lt;</span>Context<span style=color:#f92672>&amp;</span>, Event<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> InPairWithArgs <span style=color:#f92672>=</span> SelfReturning<span style=color:#f92672>&lt;</span>PairWithCtx<span style=color:#f92672>&gt;::</span>WithArgs<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>const</span> Context<span style=color:#f92672>&amp;</span>, Event<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>// Or alternatively
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>using</span> InPairWithArgs2 <span style=color:#f92672>=</span> SelfReturning<span style=color:#f92672>&lt;</span>PairWithCtx, <span style=color:#66d9ef>const</span> Context<span style=color:#f92672>&amp;</span>, Event<span style=color:#f92672>&gt;</span>;
</span></span></code></pre></td></tr></table></div></div><p>In <a href=/posts/a-functional-style-state-machine-in-cpp>Part 1</a> I promised generalizing the <code>SelfReturning</code> class and getting some compile time guarantees. We&rsquo;ve accomplished our generalization goal, so it&rsquo;s time to get some safety in place.</p><h2 id=increasing-safety><a href=#increasing-safety>Increasing Safety<span hidden class=anchor aria-hidden=true href=#increasing-safety>#</span></a></h2><p>While our use of the <code>switch</code> statement to discern different events is nice and concise, it is also somewhat error prone. It is easy to miss a case (though that can be prevented using compiler errors) or accidentally mistake one event for another. The latter is especially true if we want to pass information along with our event notification.
One easy way to avoid those mistakes is to resolve the choice using function overloading instead of switch statements. Consider the following</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;cstdio&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// (1)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>enum</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EventType</span> {A, B};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>Switch</span>(EventType evt) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span>(evt) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> EventType<span style=color:#f92672>::</span>A:
</span></span><span style=display:flex><span>            puts(<span style=color:#e6db74>&#34;A&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> EventType<span style=color:#f92672>::</span>B:
</span></span><span style=display:flex><span>            puts(<span style=color:#e6db74>&#34;B&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// (2)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>EventA</span> {};
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>EventB</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>Overload</span>(EventA) { puts(<span style=color:#e6db74>&#34;A&#34;</span>); }
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>Overload</span>(EventB) { puts(<span style=color:#e6db74>&#34;B&#34;</span>); }
</span></span></code></pre></td></tr></table></div></div><p>In (1) we use a <code>switch</code> to discern the event type. It is easy to forget a <code>return</code> or a <code>break</code>. If we passed more data along, the signature for <code>Switch</code> would likely change to <code>void Switch(EventType evt, void* data)</code>. That&rsquo;s definitely bad.
In (2), we cannot mistake the types, and data can easily be passed inside the event structs. Sadly, the events are not different types, and C++ does not allow for heterogeneous containers. Or does it?</p><p>Enter C++17&rsquo;s âœ¨<code>std::variant</code>âœ¨.</p><p>What is <code>std::variant</code>, you ask? Well, it is a <code>union</code>. A <em>safe</em> <code>union</code>! Safe meaning that you can only get a value from it if it really is there. No more type confusion; no more casting <code>void</code> pointers. But how do we get the values out of <code>std::variant</code>? Using <code>std::visit</code>, of course!
<a href=https://godbolt.org/g/EfBahi>Compilation</a>, <a href=http://coliru.stacked-crooked.com/a/95c37042037573ca>Execution</a></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;variant&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;vector&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;cstdio&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>EventA</span> {}; <span style=color:#75715e>// (1)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>EventB</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>EventHandler</span> {  <span style=color:#75715e>// (2)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>operator</span>() (EventA) { puts(<span style=color:#e6db74>&#34;A&#34;</span>); }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>operator</span>() (EventB) { puts(<span style=color:#e6db74>&#34;B&#34;</span>); }
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> event_t <span style=color:#f92672>=</span> std<span style=color:#f92672>::</span>variant<span style=color:#f92672>&lt;</span>EventA, EventB<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>vector<span style=color:#f92672>&lt;</span>event_t<span style=color:#f92672>&gt;</span> events <span style=color:#f92672>=</span> {EventA{}, EventB{}};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>auto</span><span style=color:#f92672>&amp;</span> event : events) {
</span></span><span style=display:flex><span>        std<span style=color:#f92672>::</span>visit(EventHandler{}, event); <span style=color:#75715e>// (3)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>In (1) we define our new event types. This time they are different types, not just different values. In (2) we define our event handler. All we need is an function overload for every possible type, and a struct with multiple <code>operator()</code> methods is an easy way to do it. Now all that is left to do is call <code>std::visit</code> with our handler and an event. If we forget to handle an event type - the code <a href=https://godbolt.org/g/Lzu3xV>does not compile!</a> This way, we <em>know</em> that we always handle all event types, and never mix them up.</p><p>Now, if you liked the previous part, you probably don&rsquo;t like writing a different handler class for every function. It completely ruins the locality of the code. But, we are using C++17, aren&rsquo;t we?
<a href=https://godbolt.org/g/bqsqE9>Compilation</a>, <a href=http://coliru.stacked-crooked.com/a/31074c40d4c9654d>Execution</a></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;variant&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;vector&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;cstdio&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span><span style=color:#960050;background-color:#1e0010>... </span><span style=color:#a6e22e>Ts</span><span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>overloaded</span> <span style=color:#f92672>:</span> Ts... { <span style=color:#66d9ef>using</span> Ts<span style=color:#f92672>::</span><span style=color:#66d9ef>operator</span>()...; }; <span style=color:#75715e>// (1)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>template</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span><span style=color:#960050;background-color:#1e0010>... </span><span style=color:#a6e22e>Ts</span><span style=color:#f92672>&gt;</span> overloaded(Ts...) <span style=color:#f92672>-&gt;</span> overloaded<span style=color:#f92672>&lt;</span>Ts...<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>EventA</span> {};
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>EventB</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> event_t <span style=color:#f92672>=</span> std<span style=color:#f92672>::</span>variant<span style=color:#f92672>&lt;</span>EventA, EventB<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>vector<span style=color:#f92672>&lt;</span>event_t<span style=color:#f92672>&gt;</span> events <span style=color:#f92672>=</span> {EventA{}, EventB{}};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>auto</span><span style=color:#f92672>&amp;</span> event : events) {
</span></span><span style=display:flex><span>        std<span style=color:#f92672>::</span>visit(overloaded {         <span style=color:#75715e>// (2)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            [] (EventA) { puts(<span style=color:#e6db74>&#34;A&#34;</span>); },
</span></span><span style=display:flex><span>            [] (EventB) { puts(<span style=color:#e6db74>&#34;B&#34;</span>); }
</span></span><span style=display:flex><span>        }, event);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>If you&rsquo;re not familiar with C++17, there may be a lot to take in here. In (1) we define a class that takes multiple lambdas and overloads them. In (2) we instantiate that class to inline our event handling functions.
The full explanation to this code is a bit long, so I wrote <a href=/posts/that-overloaded-trick-overloading-lambdas-in-cpp17>another post</a> to explain it.</p><p>Applied to the state-machine, it will look like this:
<a href=https://godbolt.org/g/4VNxEM>Compilation</a>, <a href=http://coliru.stacked-crooked.com/a/3bfd9a9220c60cb4>Execution</a></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;tuple&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;cstdio&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;cstdlib&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;variant&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span><span style=color:#960050;background-color:#1e0010>... </span><span style=color:#a6e22e>Ts</span><span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>overloaded</span> <span style=color:#f92672>:</span> Ts... { <span style=color:#66d9ef>using</span> Ts<span style=color:#f92672>::</span><span style=color:#66d9ef>operator</span>()...; };
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span><span style=color:#960050;background-color:#1e0010>... </span><span style=color:#a6e22e>Ts</span><span style=color:#f92672>&gt;</span> overloaded(Ts...) <span style=color:#f92672>-&gt;</span> overloaded<span style=color:#f92672>&lt;</span>Ts...<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>EventA</span> {};
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>EventB</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Event <span style=color:#f92672>=</span> std<span style=color:#f92672>::</span>variant<span style=color:#f92672>&lt;</span>EventA, EventB<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Context</span> {
</span></span><span style=display:flex><span>    Context <span style=color:#a6e22e>Inc</span>() <span style=color:#66d9ef>const</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Context{counter <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>};
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> counter <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>T</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>identity</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>using</span> type <span style=color:#f92672>=</span> T;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>T</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> identity_t <span style=color:#f92672>=</span> <span style=color:#66d9ef>typename</span> identity<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;::</span>type;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>T</span><span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Base</span> <span style=color:#f92672>=</span> identity_t, <span style=color:#66d9ef>class</span><span style=color:#960050;background-color:#1e0010>... </span><span style=color:#a6e22e>Args</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>SelfReturning</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>using</span> RetType <span style=color:#f92672>=</span> Base<span style=color:#f92672>&lt;</span>SelfReturning<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>using</span> FuncType <span style=color:#f92672>=</span> RetType(<span style=color:#f92672>*</span>)(Args... args);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    SelfReturning(FuncType func) <span style=color:#f92672>:</span> _func{ func } {}
</span></span><span style=display:flex><span>    RetType <span style=color:#a6e22e>operator</span>() (Args... args) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> _func(std<span style=color:#f92672>::</span>forward<span style=color:#f92672>&lt;</span>Args<span style=color:#f92672>&gt;</span>(args)...);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    FuncType _func;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span><span style=color:#960050;background-color:#1e0010>... </span><span style=color:#a6e22e>AltArgs</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>using</span> WithArgs <span style=color:#f92672>=</span> SelfReturning<span style=color:#f92672>&lt;</span>Base, AltArgs...<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>T</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> PairWithCtx <span style=color:#f92672>=</span> std<span style=color:#f92672>::</span>pair<span style=color:#f92672>&lt;</span>T, <span style=color:#66d9ef>const</span> Context<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> State <span style=color:#f92672>=</span> SelfReturning<span style=color:#f92672>&lt;</span>PairWithCtx<span style=color:#f92672>&gt;::</span>WithArgs<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>const</span> Context<span style=color:#f92672>&amp;</span>, Event<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>State<span style=color:#f92672>::</span>RetType A(<span style=color:#66d9ef>const</span> Context<span style=color:#f92672>&amp;</span>, Event);
</span></span><span style=display:flex><span>State<span style=color:#f92672>::</span>RetType B(<span style=color:#66d9ef>const</span> Context<span style=color:#f92672>&amp;</span>, Event);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>State<span style=color:#f92672>::</span>RetType A(<span style=color:#66d9ef>const</span> Context<span style=color:#f92672>&amp;</span> ctx, Event evt) {
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;State A, counter = %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, ctx.counter);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> std<span style=color:#f92672>::</span>visit(overloaded{
</span></span><span style=display:flex><span>        [<span style=color:#f92672>&amp;</span>] (EventA) { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>make_pair</span>(A, ctx); },
</span></span><span style=display:flex><span>        [<span style=color:#f92672>&amp;</span>] (EventB) { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>make_pair</span>(B, ctx.Inc()); }
</span></span><span style=display:flex><span>    }, evt);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>State<span style=color:#f92672>::</span>RetType B(<span style=color:#66d9ef>const</span> Context<span style=color:#f92672>&amp;</span> ctx, Event evt) {
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;State B, counter = %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, ctx.counter);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> std<span style=color:#f92672>::</span>visit(overloaded{
</span></span><span style=display:flex><span>        [<span style=color:#f92672>&amp;</span>] (EventA) { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>make_pair</span>(A, ctx.Inc()); },
</span></span><span style=display:flex><span>        [<span style=color:#f92672>&amp;</span>] (EventB) { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>make_pair</span>(B, ctx); }
</span></span><span style=display:flex><span>    }, evt);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    State state <span style=color:#f92672>=</span> A;
</span></span><span style=display:flex><span>    Context ctx{};
</span></span><span style=display:flex><span>    Event events[] <span style=color:#f92672>=</span> {EventB{}, EventA{}, EventB{}, EventA{}, };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>auto</span> evt : events) {
</span></span><span style=display:flex><span>        std<span style=color:#f92672>::</span>tie(state, ctx) <span style=color:#f92672>=</span> state(ctx, evt);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>As you can see, the change is minimal.</p><h2 id=passing-in-data><a href=#passing-in-data>Passing In Data<span hidden class=anchor aria-hidden=true href=#passing-in-data>#</span></a></h2><p>With that, it is time to address an issue I completely neglected in Part 1.
Passing in data.</p><p>Our current state-machine model is based on the idea that the events themselves are the only information the states need. This is naive. In many real-life scenarios, events carry data with them. Now, with <code>std::variant</code>, we can puts data into the different event types. All we need to do is add data-members to our event structs. We define our new, data-carrying events as follows:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>EventA</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> msg{<span style=color:#66d9ef>nullptr</span>};
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>EventB</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> number{<span style=color:#ae81ff>0</span>};
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div><p>Nothing else needs to change. And now, in the state functions, we can easily access the event data:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span>State<span style=color:#f92672>::</span>RetType A(<span style=color:#66d9ef>const</span> Context<span style=color:#f92672>&amp;</span> ctx, Event evt) {
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;State A, counter = %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, ctx.counter);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> std<span style=color:#f92672>::</span>visit(overloaded{
</span></span><span style=display:flex><span>        [<span style=color:#f92672>&amp;</span>] (EventA e) { 
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (e.msg <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nullptr</span>) {
</span></span><span style=display:flex><span>                printf(<span style=color:#e6db74>&#34;A message = </span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>%s</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#34;</span>, e.msg);
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                puts(<span style=color:#e6db74>&#34;A message = nullptr&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>make_pair</span>(A, ctx); 
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        [<span style=color:#f92672>&amp;</span>] (EventB) { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>make_pair</span>(B, ctx.Inc()); }
</span></span><span style=display:flex><span>    }, evt);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>State<span style=color:#f92672>::</span>RetType B(<span style=color:#66d9ef>const</span> Context<span style=color:#f92672>&amp;</span> ctx, Event evt) {
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;State B, counter = %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, ctx.counter);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> std<span style=color:#f92672>::</span>visit(overloaded{
</span></span><span style=display:flex><span>        [<span style=color:#f92672>&amp;</span>] (EventA e) { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>make_pair</span>(A, ctx.Inc()); },
</span></span><span style=display:flex><span>        [<span style=color:#f92672>&amp;</span>] (EventB e) { 
</span></span><span style=display:flex><span>            printf(<span style=color:#e6db74>&#34;B number = %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, e.number);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>make_pair</span>(B, ctx); 
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }, evt);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Et voilÃ .</p><p>Putting everything together now, we get the following code:</p><p><a href=https://godbolt.org/g/rR5udQ>Compilation</a>,<a href=http://coliru.stacked-crooked.com/a/273170beeb72c9a7>Execution</a></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">85
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">86
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">87
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">88
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">89
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">90
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">91
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">92
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">93
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;tuple&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;cstdio&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;cstdlib&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;variant&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span><span style=color:#960050;background-color:#1e0010>... </span><span style=color:#a6e22e>Ts</span><span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>overloaded</span> <span style=color:#f92672>:</span> Ts... { <span style=color:#66d9ef>using</span> Ts<span style=color:#f92672>::</span><span style=color:#66d9ef>operator</span>()...; };
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span><span style=color:#960050;background-color:#1e0010>... </span><span style=color:#a6e22e>Ts</span><span style=color:#f92672>&gt;</span> overloaded(Ts...) <span style=color:#f92672>-&gt;</span> overloaded<span style=color:#f92672>&lt;</span>Ts...<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>EventA</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> msg{<span style=color:#66d9ef>nullptr</span>};
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>EventB</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> number{<span style=color:#ae81ff>0</span>};
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Event <span style=color:#f92672>=</span> std<span style=color:#f92672>::</span>variant<span style=color:#f92672>&lt;</span>EventA, EventB<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Context</span> {
</span></span><span style=display:flex><span>    Context <span style=color:#a6e22e>Inc</span>() <span style=color:#66d9ef>const</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Context{counter <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>};
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> counter <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>T</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>identity</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>using</span> type <span style=color:#f92672>=</span> T;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>T</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> identity_t <span style=color:#f92672>=</span> <span style=color:#66d9ef>typename</span> identity<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;::</span>type;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>T</span><span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Base</span> <span style=color:#f92672>=</span> identity_t, <span style=color:#66d9ef>class</span><span style=color:#960050;background-color:#1e0010>... </span><span style=color:#a6e22e>Args</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>SelfReturning</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>using</span> RetType <span style=color:#f92672>=</span> Base<span style=color:#f92672>&lt;</span>SelfReturning<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>using</span> FuncType <span style=color:#f92672>=</span> RetType(<span style=color:#f92672>*</span>)(Args... args);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    SelfReturning(FuncType func) <span style=color:#f92672>:</span> _func{ func } {}
</span></span><span style=display:flex><span>    RetType <span style=color:#a6e22e>operator</span>() (Args... args) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> _func(std<span style=color:#f92672>::</span>forward<span style=color:#f92672>&lt;</span>Args<span style=color:#f92672>&gt;</span>(args)...);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    FuncType _func;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span><span style=color:#960050;background-color:#1e0010>... </span><span style=color:#a6e22e>AltArgs</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>using</span> WithArgs <span style=color:#f92672>=</span> SelfReturning<span style=color:#f92672>&lt;</span>Base, AltArgs...<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>T</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> PairWithCtx <span style=color:#f92672>=</span> std<span style=color:#f92672>::</span>pair<span style=color:#f92672>&lt;</span>T, <span style=color:#66d9ef>const</span> Context<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> State <span style=color:#f92672>=</span> SelfReturning<span style=color:#f92672>&lt;</span>PairWithCtx<span style=color:#f92672>&gt;::</span>WithArgs<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>const</span> Context<span style=color:#f92672>&amp;</span>, Event<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>State<span style=color:#f92672>::</span>RetType A(<span style=color:#66d9ef>const</span> Context<span style=color:#f92672>&amp;</span>, Event);
</span></span><span style=display:flex><span>State<span style=color:#f92672>::</span>RetType B(<span style=color:#66d9ef>const</span> Context<span style=color:#f92672>&amp;</span>, Event);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>State<span style=color:#f92672>::</span>RetType A(<span style=color:#66d9ef>const</span> Context<span style=color:#f92672>&amp;</span> ctx, Event evt) {
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;State A, counter = %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, ctx.counter);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> std<span style=color:#f92672>::</span>visit(overloaded{
</span></span><span style=display:flex><span>        [<span style=color:#f92672>&amp;</span>] (EventA e) { 
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (e.msg <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nullptr</span>) {
</span></span><span style=display:flex><span>                printf(<span style=color:#e6db74>&#34;A message = </span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>%s</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#34;</span>, e.msg);
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                puts(<span style=color:#e6db74>&#34;A message = nullptr&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>make_pair</span>(A, ctx); 
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        [<span style=color:#f92672>&amp;</span>] (EventB) { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>make_pair</span>(B, ctx.Inc()); }
</span></span><span style=display:flex><span>    }, evt);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>State<span style=color:#f92672>::</span>RetType B(<span style=color:#66d9ef>const</span> Context<span style=color:#f92672>&amp;</span> ctx, Event evt) {
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;State B, counter = %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, ctx.counter);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> std<span style=color:#f92672>::</span>visit(overloaded{
</span></span><span style=display:flex><span>        [<span style=color:#f92672>&amp;</span>] (EventA e) { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>make_pair</span>(A, ctx.Inc()); },
</span></span><span style=display:flex><span>        [<span style=color:#f92672>&amp;</span>] (EventB e) { 
</span></span><span style=display:flex><span>            printf(<span style=color:#e6db74>&#34;B number = %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, e.number);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>make_pair</span>(B, ctx); 
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }, evt);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    State state <span style=color:#f92672>=</span> A;
</span></span><span style=display:flex><span>    Context ctx{};
</span></span><span style=display:flex><span>    Event events[] <span style=color:#f92672>=</span> {EventB{}, EventA{}, EventB{}, EventB{<span style=color:#ae81ff>10</span>}, EventA{}, EventA{<span style=color:#e6db74>&#34;Hello, world!&#34;</span>}};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>auto</span> evt : events) {
</span></span><span style=display:flex><span>        std<span style=color:#f92672>::</span>tie(state, ctx) <span style=color:#f92672>=</span> state(ctx, evt);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=summary><a href=#summary>Summary<span hidden class=anchor aria-hidden=true href=#summary>#</span></a></h2><p>As promised, we have used some dark template magic to achieve:</p><ol><li>A nice generalization of <code>SelfReturning</code>, allowing customization of both return types and argument types;</li><li>Better compile-time safety by replacing the <code>switch</code> statement with overload resolution;</li><li>Passing data along with the events.</li><li>Hopefully, a lot of fun along the way.</li></ol></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://tamir.dev/>Tamir Bahar</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>