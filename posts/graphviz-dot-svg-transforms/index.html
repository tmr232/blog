<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Graphviz DOT & SVG Transforms | Tamir Bahar</title><meta name=keywords content><meta name=description content="Adventures in manipulating Graphviz SVG outputs."><meta name=author content="Tamir Bahar"><link rel=canonical href=https://tamir.dev/posts/graphviz-dot-svg-transforms/><link crossorigin=anonymous href=/assets/css/stylesheet.0b7a6a59f13c612205962144f1a8f43a859c4d814d43709a9e3e2b0e9353224b.css integrity="sha256-C3pqWfE8YSIFliFE8aj0OoWcTYFNQ3Canj4rDpNTIks=" rel="preload stylesheet" as=style><link rel=icon href=https://tamir.dev/images/profilepic.jpg><link rel=icon type=image/png sizes=16x16 href=https://tamir.dev/images/profilepic.jpg><link rel=icon type=image/png sizes=32x32 href=https://tamir.dev/images/profilepic.jpg><link rel=apple-touch-icon href=https://tamir.dev/images/profilepic.jpg><link rel=mask-icon href=https://tamir.dev/images/profilepic.jpg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=webmention href=https://webmention.io/tamir.dev/webmention><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Graphviz DOT & SVG Transforms"><meta property="og:description" content="Adventures in manipulating Graphviz SVG outputs."><meta property="og:type" content="article"><meta property="og:url" content="https://tamir.dev/posts/graphviz-dot-svg-transforms/"><meta property="og:image" content="https://tamir.dev/images/profilepic.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-01-13T00:00:00+00:00"><meta property="article:modified_time" content="2025-01-13T00:00:00+00:00"><meta property="og:site_name" content="Tamir Bahar"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://tamir.dev/images/profilepic.jpg"><meta name=twitter:title content="Graphviz DOT & SVG Transforms"><meta name=twitter:description content="Adventures in manipulating Graphviz SVG outputs."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://tamir.dev/posts/"},{"@type":"ListItem","position":2,"name":"Graphviz DOT \u0026 SVG Transforms","item":"https://tamir.dev/posts/graphviz-dot-svg-transforms/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Graphviz DOT \u0026 SVG Transforms","name":"Graphviz DOT \u0026 SVG Transforms","description":"Adventures in manipulating Graphviz SVG outputs.","keywords":[],"articleBody":"I usually think of SVGs as a ‚Äúsimple‚Äù graphical files, but that‚Äôs probably because I never had to edit them programmatically.\nI am currently working on adding overlay-notes to Function Graph Overview. The idea is that you use start- and end-comments in your code to define a region, and have that region reflected in the graph as a block surrounding the relevant nodes. Hopefully, this will allow better understanding, as whole regions of the graph can now be labelled. While the project uses Graphviz DOT to define and render the graphs themselves, I decided to add the overlay-notes via post-processing to minimize their effect on graph layout1.\nThis means I need to take the SVG output from Graphviz, and ‚Äújust‚Äù add the new graphics to it. This involves a couple of steps:\nDetermine the position and size of the notes Add them to the SVG Positioning our Notes One of the wonderful things about SVGs is that they can contain non-visual metadata. Specifically - when exporting to SVG, Graphviz can export node-IDs as SVG id attributes which we can access programmatically, matching the visual nodes with the CFG nodes we used to create them.\nI use svg.js to: get the graphical node positions; find their bounding-box; create the graphics and insert them into the SVG at the wrong place entirely. SVG Transforms You see, SVG elements can have a transform attribute, similar to a CSS transform, changing their position in the document. And Graphviz does indeed use them when exporting graphs2. To correct for this, we copy the transform from the graph element onto our new note elements:\n1 note.transform(graph.transform()); And get our next problem: SVG Viewbox SVG separates document-space from user-space. All of our graphical elements are positioned in document-space, and then we use a viewbox to specify the user‚Äôs view into the document.\nWe‚Äôve just added new elements to the document, so we must adjust the viewbox to include them. To do this, we calculate the bounding box of all our graphical elements (the graph and the notes), manually apply the transformation to the bounding-box, and then adjust the viewbox. But there‚Äôs another little catch.\nSVGs, like HTML, can use all sorts of units of length. Graphviz uses pt for the width and height of the svg element, but neglects the units for everything else (defaulting to px). This is a great choice by them, as it means the SVG can be specified and manipulated without considering units at all, then scaled using the width and height. So to maintain the original rendered scale of the SVG, we take the final viewport width and height in px, and use that value as the SVG‚Äôs new dimensions in pt (so if the viewbox is (100px, 200px), the SVG will be (100pt, 200pt)).\nSVG Background Now, there‚Äôs one last thing to consider - the document background. By default, any part of the SVG that does not display an element, is transparent. This means that to have a solid background, we need to add an element with that color. When we use the bgcolor attribute, Graphviz does this for us. As Graphviz groups graphs in SVG G elements, it puts the background element into the graphs group. This is all good behaviour, as it maintains a good SVG structure, but it is something we must consider when adding our notes.\nFirst, we must make sure our notes end up between the graph elements themselves and the background. For this purpose, we move the background element from the graph G to the top-level SVG. Additionally, having changed the viewbox, we must scale the background element to fill it.\nText Wrapping And with that, we‚Äôre done3.\nI tried using DOT clusters, but they impact the layout of the graph too significantly to be a real option.¬†‚Ü©Ô∏é\nI don‚Äôt know why they do it. But I definitely don‚Äôt wanna rewrite that code, so I‚Äôll just be happy they give me high-quality outputs and document my findings.¬†‚Ü©Ô∏é\nText-wrapping is not part of the SVG1.1 spec, so there is no easy fix here. To achieve it, we can either split it ourselves into lines; or embed an HTML P element inside the SVG. Preferably the first option.¬†‚Ü©Ô∏é\n","wordCount":"701","inLanguage":"en","datePublished":"2025-01-13T00:00:00Z","dateModified":"2025-01-13T00:00:00Z","author":{"@type":"Person","name":"Tamir Bahar"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://tamir.dev/posts/graphviz-dot-svg-transforms/"},"publisher":{"@type":"Organization","name":"Tamir Bahar","logo":{"@type":"ImageObject","url":"https://tamir.dev/images/profilepic.jpg"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tamir.dev/ accesskey=h title="Tamir Bahar (Alt + H)">Tamir Bahar</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://tamir.dev/blogvent/ title=blogventüéÑ><span>blogventüéÑ</span></a></li><li><a href=https://tamir.dev/posts/ title=posts><span>posts</span></a></li><li><a href=https://tamir.dev/archives/ title=archives><span>archives</span></a></li><li><a href=https://tamir.dev/index.xml title=rss><span>rss</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" height="13"><g transform="scale(1)"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></g></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://tamir.dev/>Home</a>&nbsp;¬ª&nbsp;<a href=https://tamir.dev/posts/>Posts</a></div><h1 class=post-title>Graphviz DOT & SVG Transforms</h1><div class=post-description>Adventures in manipulating Graphviz SVG outputs.</div><div class=post-meta><span title='2025-01-13 00:00:00 +0000 UTC'>Jan 13, 2025</span>&nbsp;¬∑&nbsp;Tamir Bahar</div></header><div class=post-content><p>I usually think of <a href=https://en.wikipedia.org/wiki/SVG>SVGs</a> as a &ldquo;simple&rdquo; graphical files, but that&rsquo;s probably because I never had to edit them programmatically.</p><p>I am <a href=https://github.com/tmr232/function-graph-overview/pull/63>currently working</a> on adding overlay-notes to <a href=https://tmr232.github.io/function-graph-overview/>Function Graph Overview</a>.
The idea is that you use start- and end-comments in your code to define a region, and have that region reflected in the graph as a block surrounding the relevant nodes.
Hopefully, this will allow better understanding, as whole regions of the graph can now be labelled.
<img src=demo.png alt="Side by side view of code with region comments and rendered graph with overlay notes"></p><p>While the project uses <a href=https://graphviz.org/>Graphviz DOT</a> to define and render the graphs themselves, I decided to add the overlay-notes via post-processing to minimize their effect on graph layout<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p><p>This means I need to take the SVG output from Graphviz, and &ldquo;just&rdquo; add the new graphics to it.
This involves a couple of steps:</p><ol><li>Determine the position and size of the notes</li><li>Add them to the SVG</li></ol><h3 id=positioning-our-notes><a href=#positioning-our-notes>Positioning our Notes<span hidden class=anchor aria-hidden=true href=#positioning-our-notes>#</span></a></h3><p>One of the wonderful things about SVGs is that they can contain non-visual metadata.
Specifically - when exporting to SVG, Graphviz can <a href=https://graphviz.org/docs/outputs/#ID>export node-IDs as SVG <code>id</code> attributes</a> which we can access programmatically, matching the visual nodes with the CFG nodes we used to create them.</p><p>I use <a href=https://github.com/svgdotjs/svg.js>svg.js</a> to: get the graphical node positions; find their bounding-box; create the graphics and insert them into the SVG at the wrong place entirely.
<img src=bad-transform.png alt="CFG with a note positioned outside the graph area"></p><h3 id=svg-transforms><a href=#svg-transforms>SVG Transforms<span hidden class=anchor aria-hidden=true href=#svg-transforms>#</span></a></h3><p>You see, SVG elements can have a <a href=https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/transform><code>transform</code> attribute</a>, similar to a CSS <code>transform</code>, changing their position in the document.
And Graphviz does indeed use them when exporting graphs<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>.
To correct for this, we copy the transform from the graph element onto our new note elements:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#a6e22e>note</span>.<span style=color:#a6e22e>transform</span>(<span style=color:#a6e22e>graph</span>.<span style=color:#a6e22e>transform</span>());
</span></span></code></pre></td></tr></table></div></div><p>And get our next problem:
<img src=viewbox.png alt="CFG with a note, the edge of the note is cropped out of the graph"></p><h3 id=svg-viewbox><a href=#svg-viewbox>SVG Viewbox<span hidden class=anchor aria-hidden=true href=#svg-viewbox>#</span></a></h3><p>SVG separates document-space from user-space.
All of our graphical elements are positioned in document-space, and then we use a <a href=https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/viewBox>viewbox</a> to specify the user&rsquo;s view into the document.</p><p>We&rsquo;ve just added new elements to the document, so we must adjust the viewbox to include them.
To do this, we calculate the bounding box of all our graphical elements (the graph <em>and</em> the notes), manually apply the transformation to the bounding-box, and then adjust the viewbox.
But there&rsquo;s another little catch.</p><p>SVGs, like HTML, can use all sorts of units of length.
Graphviz uses <code>pt</code> for the <code>width</code> and <code>height</code> of the <code>svg</code> element, but neglects the units for everything else (defaulting to <code>px</code>).
This is a great choice by them, as it means the SVG can be specified and manipulated without considering units at all, then scaled using the <code>width</code> and <code>height</code>.
So to maintain the original rendered scale of the SVG, we take the final viewport <code>width</code> and <code>height</code> in <code>px</code>, and use that value as the SVG&rsquo;s new dimensions in <code>pt</code> (so if the viewbox is <code>(100px, 200px)</code>, the SVG will be <code>(100pt, 200pt)</code>).</p><h3 id=svg-background><a href=#svg-background>SVG Background<span hidden class=anchor aria-hidden=true href=#svg-background>#</span></a></h3><p>Now, there&rsquo;s one last thing to consider - the document background.
By default, any part of the SVG that does not display an element, is transparent.
This means that to have a solid background, we need to add an element with that color.
When we use the <a href=https://graphviz.org/docs/attrs/bgcolor/><code>bgcolor</code> attribute</a>, Graphviz does this for us.
As Graphviz groups graphs in SVG <code>G</code> elements, it puts the background element into the graphs group.
This is all good behaviour, as it maintains a good SVG structure, but it is something we must consider when adding our notes.</p><p>First, we must make sure our notes end up between the graph elements themselves and the background.
For this purpose, we move the background element from the graph <code>G</code> to the top-level <code>SVG</code>.
Additionally, having changed the viewbox, we must scale the background element to fill it.</p><h3 id=text-wrapping><a href=#text-wrapping><del>Text Wrapping</del><span hidden class=anchor aria-hidden=true href=#text-wrapping>#</span></a></h3><p><img src=text-wrap.png alt="A properly rendered and positioned overlay-note on a CFG, with the note text extending beyond the background of the note."></p><p>And with that, we&rsquo;re done<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>I tried using DOT clusters, but they impact the layout of the graph too significantly to be a real option.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>I don&rsquo;t know why they do it. But I definitely don&rsquo;t wanna rewrite that code, so I&rsquo;ll just be happy they give me high-quality outputs and document my findings.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>Text-wrapping is not part of the SVG1.1 spec, so there is no easy fix here. To achieve it, we can either split it ourselves into lines; or embed an HTML <code>P</code> element inside the SVG. Preferably the first option.&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags></ul><div style=display:flex;justify-content:center class=discuss><a href=https://github.com/tmr232/tamir.dev/discussions/17 target=_blank rel="noopener noreferrer me" title="Discuss this post">Discuss this post<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" height="1em" style="margin-bottom:-.2em;margin-left:.2em"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://tamir.dev/>Tamir Bahar</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>