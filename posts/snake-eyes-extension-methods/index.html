<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Snake Eyes: Extension Methods | Tamir Bahar</title><meta name=keywords content="python,kotlin,misguided"><meta name=description content="Implementing Extension-Methods in Python"><meta name=author content><link rel=canonical href=https://tamir.dev/posts/snake-eyes-extension-methods/><link crossorigin=anonymous href=/assets/css/stylesheet.f89fe5ba0a1e1e3a66da8210c0add5c0528394d79616f1e033496028ca8dd450.css integrity="sha256-+J/lugoeHjpm2oIQwK3VwFKDlNeWFvHgM0lgKMqN1FA=" rel="preload stylesheet" as=style><link rel=icon href=https://tamir.dev/images/profilepic.jpg><link rel=icon type=image/png sizes=16x16 href=https://tamir.dev/images/profilepic.jpg><link rel=icon type=image/png sizes=32x32 href=https://tamir.dev/images/profilepic.jpg><link rel=apple-touch-icon href=https://tamir.dev/images/profilepic.jpg><link rel=mask-icon href=https://tamir.dev/images/profilepic.jpg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Snake Eyes: Extension Methods"><meta property="og:description" content="Implementing Extension-Methods in Python"><meta property="og:type" content="article"><meta property="og:url" content="https://tamir.dev/posts/snake-eyes-extension-methods/"><meta property="og:image" content="https://tamir.dev/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-03-06T00:00:00+00:00"><meta property="article:modified_time" content="2020-03-06T00:00:00+00:00"><meta property="og:site_name" content="Tamir Bahar"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://tamir.dev/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Snake Eyes: Extension Methods"><meta name=twitter:description content="Implementing Extension-Methods in Python"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://tamir.dev/posts/"},{"@type":"ListItem","position":2,"name":"Snake Eyes: Extension Methods","item":"https://tamir.dev/posts/snake-eyes-extension-methods/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Snake Eyes: Extension Methods","name":"Snake Eyes: Extension Methods","description":"Implementing Extension-Methods in Python","keywords":["python","kotlin","misguided"],"articleBody":"Today we set out to implement a feature I saw and liked in Kotlin - Extension Methods.\nYou can follow along with working code samples here, or get the code here\nExtension methods are a nice piece of syntactic-sugar that allow you to define free-functions and call them like instance methods. In Kotlin, it looks something like this:\n1 2 3 4 5 6 7 8 fun Square.draw() { drawSquare(this) } // ... val square = getSquare() square.draw() Now, since they are free, static functions, they follow the same rules. They are not part of the class, nor have access to private members. And they can only be called in a scope where they are visible. Adding them in your code does not affect other code. Additionally, true member functions, if they exist, take precedence over extension methods (this is especially important with generic extension methods).\nIn our code today, we‚Äôll try to mimic the features of extension methods as closely as possible. We‚Äôll use the following syntax:\n1 2 3 @extend(Square) def draw(square): draw_square(square) For extension methods, and the following implementation of Square in our code throughout:\n1 2 3 4 5 from dataclasses import dataclass @dataclass class Square: length: int Monkey Patching üôà Python is a very dynamic language. Among other things, it allows us to change the attributes of (non-builtin) types at run-time. This means that we can extend our Square class by adding a draw method to it at run-time.\n1 Square.draw = draw_square We‚Äôre now free to call square.draw(). Before we discuss the draw-backs, let‚Äôs implement it with the syntax we defined:\n1 2 3 4 5 6 7 8 def monkey_extend(cls): def _decorator(f): setattr(cls, f.__name__, f) return _decorator @monkey_extend(Square) def draw(square): draw_square(square) Let‚Äôs go over this. monkey_extend is a decorator with arguments. This is a common pattern where we use a decorator factory (monkey_extend) to create a new decorator (_decorator) as a closure, giving it access to the parameters passed to the factory (cls). Then, in the core of the decorator, we use setattr to do our monkey-patching.\nWhile this works, it has several issues:\nScope - once set, it can be used with any Square in any scope Precedence - it will override any existing Square.draw Dealing with precedence is easy (using hasattr to check for existing .draw) so we‚Äôll focus on the scoping first.\nDynamic Attribute Lookup ‚ú® The first thing we know is that we need our new attribute to be there in some cases, and be gone in others - we need dynamic resolution. To do that, we‚Äôll use __getattr__. In Python classes, __getattr__ is used in attribute lookup as a last resort, called when the other ways of looking up attributes came up empty. We‚Äôll write our __getattr__ along the following lines:\n1 2 3 4 5 6 def my_getattr(obj, name): if not has_extension(obj, name): raise AttributeError() if not is_in_scope(name): raise AttributeError() return our_extension The first check, has_extension, is basically checking whether the name we got matches the name of our extension method. Nothing to elaborate yet. Scoping, once again, remains the trickier part.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 import functools import inspect from collections import ChainMap def scoped_extend(cls): def _decorator(f): def _getattr(obj, name): # (2) if name != f.__name__: raise AttributeError() # (3) frame = inspect.stack()[1].frame scope = ChainMap(frame.f_locals, frame.f_globals) if scope.get(f.__name__) == f: raise AttributeError() # (4) return functools.partial(f, obj) # (1) cls.__getattr__ = _getattr return f return _decorator This is a bit much, so we‚Äôll go over it in detail.\nAs a basis, we used the same decorator-with-parameters pattern here. We have scoped_extend take the class we want to extend, then return _decorator to get the job done. But instead of setting the attribute we want to extend, we monkey-patch cls‚Äôs __getattr__ to our implementation (See (1)). This will override any existing implementation of __getattr__, but we‚Äôll get to that later. For now, we‚Äôll focus on our implementation of __getattr__.\nIn (2) we implemented has_extnesion - we simply compare the name we got to the name of our extension method. Then, in (3), comes some Python magic. Python allows us to inspect the running program, to see where we were called from and what variables were in scope in that code. To do that, we use the inspect module. We use inspect.stack() to get the call-stack for the current execution, then access the second frame ([1]) to get our caller. This will be where getattr(obj, name) is invoked or obj.name is used. We use .frame to get the execution frame, and .f_locals and f_globals to get the local and global variables available in that scope. They are equivalent to calling globals() or locals() in the relevant frame.\nWith the scope at hand, we perform a lookup to see whether the extension method we defined is in that scope. To make sure we have our extension method, we get it by name, then ensure that it is truly our method.\nFinally, in (4), when we know our method should be active, we bind it to the instance of the extended class and return it.\nBetter Scoping While our scope retrieval code works, it‚Äôs better to put it in a function rather than use it inline:\n1 2 3 def _is_in_scope(name, value): frame = inspect.stack()[2].frame return ChainMap(frame.f_locals, frame.f_globals).get(name) == value But, oh, we have to increment the stack index to 2 since we‚Äôre deeper in the callstack. This is risky. Instead, we‚Äôll use the following trick to get the frame:\n1 2 3 4 5 6 7 8 9 def _get_first_external_stack_frame(): for frameinfo in inspect.stack(): if frameinfo.filename == __file__: continue return frameinfo.frame def _is_in_scope(name, value): frame = _get_first_external_stack_frame() return ChainMap(frame.f_locals, frame.f_globals).get(name) == value Instead of counting the frames in our code, changing them with every change - we‚Äôll use the module system. We know that all of our scaffolding is in the same module, but the usage is not. This allows us to easily traverse the stack until we find code that does not belong in our module. That is our calling code.\nSince you‚Äôre probably wondering - yes. You need to change _get_first_external_stack_frame() if you want to put it in a different module. Implementing it is left as an exercise to the reader.\nPreserving __getattr__ As mentioned before, our current implementation overrides any existing __getattr__ function for the class. Lucky for us, fixing it is easy:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 def no_override_extend(cls): def _decorator(f): def _default(_obj, _name): raise AttributeError() original_getattr = getattr(cls, '__getattr__', _default) def _getattr(obj, name): with suppress(AttributeError): return original_getattr(obj, name) if name != f.__name__: raise AttributeError() if not _is_in_scope(f): raise AttributeError() return functools.partial(f, obj) cls.__getattr__ = _getattr return f return _decorator In (1) we get the original __getattr__ method, to be stored for later usage. We use the _default function to avoid an extra if later. In (2) we use the saved __getattr__, making sure that we only proceed to our code if it raised an AttributeError exception.\nInterlude üêç With no_override_extend we have our first ‚Äúto-spec‚Äù implementation of extension methods. We have both scoping and precedence down. It is time to celebrate and rest. But our quest is not done yet.\nWhile our code works well for a proof-of-concept, there are still significant usability issues with it. Since the extension methods we create have nice and clean names, it is likely that we‚Äôll want to use those names for other things. Unfortunately, once we do that, we‚Äôll override the existing extension methods and they will no longer work:\n1 2 3 4 5 6 7 8 9 10 @extend(Square) def draw(square): draw_square(square) def draw(): print(\"Drawing is awesome!\") # ... square.draw() # This will fail, as `draw` has been replaced in this scope. Indirection üîÄ The Fundemental Theorem of Software Engineering (FTSE) says that any problem can be solved by adding another level of indirection. Let‚Äôs see how this applies to our problem.\nAs mentioned in the interlude, our main issue is that of naming. Our extension method is bound to a name, and that name can be overriden in the scope that defines it. If that happens, we lose our extension method. To solve that, we‚Äôll add another level of indirection - a scope that can safely hold our extension methods and protect them from being overriden. If you read our previous post you might recall that classes are wonderful for scopes. So we‚Äôll use a class.\nOur new syntax will look like this:\n1 2 3 4 @extension class ExtensionMethods(Square): def draw(self): draw_square(self) While we‚Äôre still using a decorator, you may notice that it takes no parameters. Instead, we use the extended type as the base type for our extension class. This allows us to write the extensions like any other subclass, with standard Python syntax, and then use the decorator to install the extensions in it.\nSince we‚Äôve already gone over the principles behind the construction of the decorator, let‚Äôs jump straight to the code and focus on the differences from the previous version:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 def extension(scope_cls): def _default(_obj, _name): raise AttributeError() # (1) cls = scope_cls.__base__ original_getattr = getattr(cls, '__getattr__', _default) def _getattr(obj, name): with suppress(AttributeError): return original_getattr(obj, name) # (2) if not hasattr(scope_cls, name): raise AttributeError() # (3) if not _is_in_scope(scope_cls): raise AttributeError() # (4) f = getattr(scope_cls, name) return functools.partial(f, obj) cls.__getattr__ = _getattr return scope_cls First, you can see that there is no nested decorator - only the main one. And, as we mentioned before, we use inheritance to indicate which type we‚Äôre extending. So in (1) we access the base-class of our extension class to get the class we‚Äôre extending. Then, in (2) we check whether the requested attribute exists in our extension class. As you can see, the changes are pretty simple and straight-forward. In (3) we make the most important change - we check for the extension class in the scope, not the extension methods. This is the core of this change! And lastly, in (4), we get the required attribute from out extension class.\nAnd with that, we‚Äôre done.\nFinal Words I hope you enjoyed this article. Regardless of that, I hope you never use it in production code.\n","wordCount":"1751","inLanguage":"en","datePublished":"2020-03-06T00:00:00Z","dateModified":"2020-03-06T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://tamir.dev/posts/snake-eyes-extension-methods/"},"publisher":{"@type":"Organization","name":"Tamir Bahar","logo":{"@type":"ImageObject","url":"https://tamir.dev/images/profilepic.jpg"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tamir.dev/ accesskey=h title="Tamir Bahar (Alt + H)">Tamir Bahar</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://tamir.dev/posts/ title=posts><span>posts</span></a></li><li><a href=https://tamir.dev/archives/ title=archives><span>archives</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://tamir.dev/>Home</a>&nbsp;¬ª&nbsp;<a href=https://tamir.dev/posts/>Posts</a></div><h1 class=post-title>Snake Eyes: Extension Methods</h1><div class=post-description>Implementing Extension-Methods in Python</div><div class=post-meta><span title='2020-03-06 00:00:00 +0000 UTC'>2020-03-06</span></div></header><div class=post-content><p>Today we set out to implement a feature I saw and liked in Kotlin - <a href=https://kotlinlang.org/docs/reference/extensions.html>Extension Methods</a>.</p><p>You can follow along with working code samples <a href=https://repl.it/@TamirBahar/python-extension-methods>here</a>, or get the code <a href=https://github.com/tmr232/python-extension-methods>here</a></p><p>Extension methods are a nice piece of syntactic-sugar that allow you to define free-functions and call them like instance methods. In Kotlin, it looks something like this:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>Square</span>.draw() {
</span></span><span style=display:flex><span>    drawSquare(<span style=color:#66d9ef>this</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> square = getSquare()
</span></span><span style=display:flex><span>square.draw()
</span></span></code></pre></td></tr></table></div></div><p>Now, since they are free, static functions, they follow the same rules. They are not part of the class, nor have access to private members. And they can only be called in a scope where they are visible. Adding them in your code does not affect other code. Additionally, true member functions, if they exist, take precedence over extension methods (this is especially important with generic extension methods).</p><p>In our code today, we&rsquo;ll try to mimic the features of extension methods as closely as possible. We&rsquo;ll use the following syntax:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@extend</span>(Square)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>draw</span>(square):
</span></span><span style=display:flex><span>    draw_square(square)
</span></span></code></pre></td></tr></table></div></div><p>For extension methods, and the following implementation of <code>Square</code> in our code throughout:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> dataclasses <span style=color:#f92672>import</span> dataclass
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@dataclass</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Square</span>:
</span></span><span style=display:flex><span>    length: int
</span></span></code></pre></td></tr></table></div></div><h2 id=monkey-patching->Monkey Patching üôà<a hidden class=anchor aria-hidden=true href=#monkey-patching->#</a></h2><p>Python is a very dynamic language. Among other things, it allows us to change the attributes of (non-builtin) types at run-time. This means that we can extend our <code>Square</code> class by adding a <code>draw</code> method to it at run-time.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>Square<span style=color:#f92672>.</span>draw <span style=color:#f92672>=</span> draw_square
</span></span></code></pre></td></tr></table></div></div><p>We&rsquo;re now free to call <code>square.draw()</code>. Before we discuss the draw-backs, let&rsquo;s implement it with the syntax we defined:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>monkey_extend</span>(cls):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_decorator</span>(f):
</span></span><span style=display:flex><span>        setattr(cls, f<span style=color:#f92672>.</span>__name__, f)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> _decorator
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@monkey_extend</span>(Square)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>draw</span>(square):
</span></span><span style=display:flex><span>    draw_square(square)
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s go over this. <code>monkey_extend</code> is a decorator with arguments. This is a common pattern where we use a decorator factory (<code>monkey_extend</code>) to create a new decorator (<code>_decorator</code>) as a closure, giving it access to the parameters passed to the factory (<code>cls</code>). Then, in the core of the decorator, we use <code>setattr</code> to do our monkey-patching.</p><p>While this works, it has several issues:</p><ol><li>Scope - once set, it can be used with any <code>Square</code> in any scope</li><li>Precedence - it will override any existing <code>Square.draw</code></li></ol><p>Dealing with precedence is easy (using <code>hasattr</code> to check for existing <code>.draw</code>) so we&rsquo;ll focus on the scoping first.</p><h2 id=dynamic-attribute-lookup->Dynamic Attribute Lookup ‚ú®<a hidden class=anchor aria-hidden=true href=#dynamic-attribute-lookup->#</a></h2><p>The first thing we know is that we need our new attribute to be there in some cases, and be gone in others - we need dynamic resolution. To do that, we&rsquo;ll use <a href=https://docs.python.org/3/reference/datamodel.html#object.__getattr__><code>__getattr__</code></a>. In Python classes, <code>__getattr__</code> is used in attribute lookup as a last resort, called when the other ways of looking up attributes came up empty. We&rsquo;ll write our <code>__getattr__</code> along the following lines:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>my_getattr</span>(obj, name):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> has_extension(obj, name):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>AttributeError</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> is_in_scope(name):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>AttributeError</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> our_extension
</span></span></code></pre></td></tr></table></div></div><p>The first check, <code>has_extension</code>, is basically checking whether the name we got matches the name of our extension method. Nothing to elaborate yet. Scoping, once again, remains the trickier part.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> functools
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> inspect
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> collections <span style=color:#f92672>import</span> ChainMap
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>scoped_extend</span>(cls):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_decorator</span>(f):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_getattr</span>(obj, name):
</span></span><span style=display:flex><span>            <span style=color:#75715e># (2)</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> name <span style=color:#f92672>!=</span> f<span style=color:#f92672>.</span>__name__:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>AttributeError</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># (3)</span>
</span></span><span style=display:flex><span>            frame <span style=color:#f92672>=</span> inspect<span style=color:#f92672>.</span>stack()[<span style=color:#ae81ff>1</span>]<span style=color:#f92672>.</span>frame
</span></span><span style=display:flex><span>            scope <span style=color:#f92672>=</span> ChainMap(frame<span style=color:#f92672>.</span>f_locals, frame<span style=color:#f92672>.</span>f_globals)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> scope<span style=color:#f92672>.</span>get(f<span style=color:#f92672>.</span>__name__) <span style=color:#f92672>==</span> f:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>AttributeError</span>()
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#75715e># (4)</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> functools<span style=color:#f92672>.</span>partial(f, obj)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>        <span style=color:#75715e># (1)</span>
</span></span><span style=display:flex><span>        cls<span style=color:#f92672>.</span>__getattr__ <span style=color:#f92672>=</span> _getattr
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> f
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> _decorator
</span></span></code></pre></td></tr></table></div></div><p>This is a bit much, so we&rsquo;ll go over it in detail.</p><p>As a basis, we used the same decorator-with-parameters pattern here. We have <code>scoped_extend</code> take the class we want to extend, then return <code>_decorator</code> to get the job done. But instead of setting the attribute we want to extend, we monkey-patch <code>cls</code>&rsquo;s <code>__getattr__</code> to our implementation (See <strong>(1)</strong>). This will override any existing implementation of <code>__getattr__</code>, but we&rsquo;ll get to that later. For now, we&rsquo;ll focus on our implementation of <code>__getattr__</code>.</p><p>In <strong>(2)</strong> we implemented <code>has_extnesion</code> - we simply compare the name we got to the name of our extension method. Then, in <strong>(3)</strong>, comes some Python magic. Python allows us to inspect the running program, to see where we were called from and what variables were in scope in that code. To do that, we use the <a href=https://docs.python.org/3/library/inspect.html><code>inspect</code></a> module. We use <code>inspect.stack()</code> to get the call-stack for the current execution, then access the second frame (<code>[1]</code>) to get our caller. This will be where <code>getattr(obj, name)</code> is invoked or <code>obj.name</code> is used. We use <code>.frame</code> to get the execution frame, and <code>.f_locals</code> and <code>f_globals</code> to get the local and global variables available in that scope. They are equivalent to calling <code>globals()</code> or <code>locals()</code> in the relevant frame.</p><p>With the scope at hand, we perform a lookup to see whether the extension method we defined is in that scope. To make sure we have our extension method, we get it by name, then ensure that it is truly our method.</p><p>Finally, in <strong>(4)</strong>, when we know our method should be active, we bind it to the instance of the extended class and return it.</p><h3 id=better-scoping>Better Scoping<a hidden class=anchor aria-hidden=true href=#better-scoping>#</a></h3><p>While our scope retrieval code works, it&rsquo;s better to put it in a function rather than use it inline:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_is_in_scope</span>(name, value):
</span></span><span style=display:flex><span>    frame <span style=color:#f92672>=</span> inspect<span style=color:#f92672>.</span>stack()[<span style=color:#ae81ff>2</span>]<span style=color:#f92672>.</span>frame
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> ChainMap(frame<span style=color:#f92672>.</span>f_locals, frame<span style=color:#f92672>.</span>f_globals)<span style=color:#f92672>.</span>get(name) <span style=color:#f92672>==</span> value
</span></span></code></pre></td></tr></table></div></div><p>But, oh, we have to increment the stack index to <code>2</code> since we&rsquo;re deeper in the callstack. This is risky. Instead, we&rsquo;ll use the following trick to get the frame:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_get_first_external_stack_frame</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> frameinfo <span style=color:#f92672>in</span> inspect<span style=color:#f92672>.</span>stack():
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> frameinfo<span style=color:#f92672>.</span>filename <span style=color:#f92672>==</span> __file__:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> frameinfo<span style=color:#f92672>.</span>frame
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_is_in_scope</span>(name, value):
</span></span><span style=display:flex><span>    frame <span style=color:#f92672>=</span> _get_first_external_stack_frame()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> ChainMap(frame<span style=color:#f92672>.</span>f_locals, frame<span style=color:#f92672>.</span>f_globals)<span style=color:#f92672>.</span>get(name) <span style=color:#f92672>==</span> value
</span></span></code></pre></td></tr></table></div></div><p>Instead of counting the frames in our code, changing them with every change - we&rsquo;ll use the module system. We know that all of our scaffolding is in the same module, but the usage is not. This allows us to easily traverse the stack until we find code that does not belong in our module. <em>That</em> is our calling code.</p><p>Since you&rsquo;re probably wondering - yes. You need to change <code>_get_first_external_stack_frame()</code> if you want to put it in a different module. Implementing it is left as an exercise to the reader.</p><h2 id=preserving-__getattr__>Preserving <code>__getattr__</code><a hidden class=anchor aria-hidden=true href=#preserving-__getattr__>#</a></h2><p>As mentioned before, our current implementation overrides any existing <code>__getattr__</code> function for the class. Lucky for us, fixing it is easy:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>no_override_extend</span>(cls):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_decorator</span>(f):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_default</span>(_obj, _name):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>AttributeError</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        original_getattr <span style=color:#f92672>=</span> getattr(cls, <span style=color:#e6db74>&#39;__getattr__&#39;</span>, _default)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_getattr</span>(obj, name):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>with</span> suppress(<span style=color:#a6e22e>AttributeError</span>):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> original_getattr(obj, name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> name <span style=color:#f92672>!=</span> f<span style=color:#f92672>.</span>__name__:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>AttributeError</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> _is_in_scope(f):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>AttributeError</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> functools<span style=color:#f92672>.</span>partial(f, obj)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        cls<span style=color:#f92672>.</span>__getattr__ <span style=color:#f92672>=</span> _getattr
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> f
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> _decorator
</span></span></code></pre></td></tr></table></div></div><p>In <strong>(1)</strong> we get the original <code>__getattr__</code> method, to be stored for later usage. We use the <code>_default</code> function to avoid an extra <code>if</code> later. In <strong>(2)</strong> we use the saved <code>__getattr__</code>, making sure that we only proceed to our code if it raised an <code>AttributeError</code> exception.</p><h2 id=interlude->Interlude üêç<a hidden class=anchor aria-hidden=true href=#interlude->#</a></h2><p>With <code>no_override_extend</code> we have our first &ldquo;to-spec&rdquo; implementation of extension methods. We have both scoping and precedence down. It is time to celebrate and rest. But our quest is not done yet.</p><p>While our code works well for a proof-of-concept, there are still significant usability issues with it. Since the extension methods we create have nice and clean names, it is likely that we&rsquo;ll want to use those names for other things. Unfortunately, once we do that, we&rsquo;ll override the existing extension methods and they will no longer work:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@extend</span>(Square)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>draw</span>(square):
</span></span><span style=display:flex><span>    draw_square(square)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>draw</span>():
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;Drawing is awesome!&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>square<span style=color:#f92672>.</span>draw()  <span style=color:#75715e># This will fail, as `draw` has been replaced in this scope.</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=indirection->Indirection üîÄ<a hidden class=anchor aria-hidden=true href=#indirection->#</a></h2><p>The <a href=https://en.wikipedia.org/wiki/Fundamental_theorem_of_software_engineering>Fundemental Theorem of Software Engineering (FTSE)</a> says that any problem can be solved by adding another level of indirection. Let&rsquo;s see how this applies to our problem.</p><p>As mentioned in the interlude, our main issue is that of naming. Our extension method is bound to a name, and that name can be overriden in the scope that defines it. If that happens, we lose our extension method. To solve that, we&rsquo;ll add another level of indirection - a scope that can safely hold our extension methods and protect them from being overriden. If you read our <a href=/posts/snake-eyes-scopes-and-iife>previous post</a> you might recall that classes are wonderful for scopes. So we&rsquo;ll use a class.</p><p>Our new syntax will look like this:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@extension</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ExtensionMethods</span>(Square):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>draw</span>(self):
</span></span><span style=display:flex><span>        draw_square(self)
</span></span></code></pre></td></tr></table></div></div><p>While we&rsquo;re still using a decorator, you may notice that it takes no parameters. Instead, we use the extended type as the base type for our extension class. This allows us to write the extensions like any other subclass, with standard Python syntax, and then use the decorator to install the extensions in it.</p><p>Since we&rsquo;ve already gone over the principles behind the construction of the decorator, let&rsquo;s jump straight to the code and focus on the differences from the previous version:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>extension</span>(scope_cls):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_default</span>(_obj, _name):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>AttributeError</span>()
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># (1)</span>
</span></span><span style=display:flex><span>    cls <span style=color:#f92672>=</span> scope_cls<span style=color:#f92672>.</span>__base__
</span></span><span style=display:flex><span>    original_getattr <span style=color:#f92672>=</span> getattr(cls, <span style=color:#e6db74>&#39;__getattr__&#39;</span>, _default)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_getattr</span>(obj, name):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> suppress(<span style=color:#a6e22e>AttributeError</span>):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> original_getattr(obj, name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># (2)</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> hasattr(scope_cls, name):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>AttributeError</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># (3)</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> _is_in_scope(scope_cls):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>AttributeError</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># (4)</span>
</span></span><span style=display:flex><span>        f <span style=color:#f92672>=</span> getattr(scope_cls, name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> functools<span style=color:#f92672>.</span>partial(f, obj)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    cls<span style=color:#f92672>.</span>__getattr__ <span style=color:#f92672>=</span> _getattr
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> scope_cls
</span></span></code></pre></td></tr></table></div></div><p>First, you can see that there is no nested decorator - only the main one. And, as we mentioned before, we use inheritance to indicate which type we&rsquo;re extending. So in <strong>(1)</strong> we access the base-class of our extension class to get the class we&rsquo;re extending. Then, in <strong>(2)</strong> we check whether the requested attribute exists in our extension class. As you can see, the changes are pretty simple and straight-forward. In <strong>(3)</strong> we make the most important change - we check for the extension class in the scope, not the extension methods. This is the core of this change! And lastly, in <strong>(4)</strong>, we get the required attribute from out extension class.</p><p>And with that, we&rsquo;re done.</p><h2 id=final-words>Final Words<a hidden class=anchor aria-hidden=true href=#final-words>#</a></h2><p>I hope you enjoyed this article. Regardless of that, I hope you never use it in production code.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://tamir.dev/tags/python/>python</a></li><li><a href=https://tamir.dev/tags/kotlin/>kotlin</a></li><li><a href=https://tamir.dev/tags/misguided/>misguided</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://tamir.dev/>Tamir Bahar</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>