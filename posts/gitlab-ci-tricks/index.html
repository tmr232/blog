<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>GitLab CI Tricks | Tamir Bahar</title><meta name=keywords content><meta name=description content="A collection of useful hacks for the GitLab CI"><meta name=author content="Tamir Bahar"><link rel=canonical href=https://tamir.dev/posts/gitlab-ci-tricks/><link crossorigin=anonymous href=/assets/css/stylesheet.947e59c82c22a5677e549390ae88cc5edb5379cfdf5e7014c0320119c8985496.css integrity="sha256-lH5ZyCwipWd+VJOQrojMXttTec/fXnAUwDIBGciYVJY=" rel="preload stylesheet" as=style><link rel=icon href=https://tamir.dev/images/profilepic.jpg><link rel=icon type=image/png sizes=16x16 href=https://tamir.dev/images/profilepic.jpg><link rel=icon type=image/png sizes=32x32 href=https://tamir.dev/images/profilepic.jpg><link rel=apple-touch-icon href=https://tamir.dev/images/profilepic.jpg><link rel=mask-icon href=https://tamir.dev/images/profilepic.jpg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="GitLab CI Tricks"><meta property="og:description" content="A collection of useful hacks for the GitLab CI"><meta property="og:type" content="article"><meta property="og:url" content="https://tamir.dev/posts/gitlab-ci-tricks/"><meta property="og:image" content="https://tamir.dev/images/profilepic.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-03-10T00:00:00+00:00"><meta property="article:modified_time" content="2021-03-10T00:00:00+00:00"><meta property="og:site_name" content="Tamir Bahar"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://tamir.dev/images/profilepic.jpg"><meta name=twitter:title content="GitLab CI Tricks"><meta name=twitter:description content="A collection of useful hacks for the GitLab CI"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://tamir.dev/posts/"},{"@type":"ListItem","position":2,"name":"GitLab CI Tricks","item":"https://tamir.dev/posts/gitlab-ci-tricks/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"GitLab CI Tricks","name":"GitLab CI Tricks","description":"A collection of useful hacks for the GitLab CI","keywords":[],"articleBody":"In writing our CI setup at Vdoo, we came across some interesting challenges. Having solved them and used the solutions for quite a while, we decided it is best to share, and hopefully save others some time and effort solving similar problems.\nOf course, there are alternative solutions to the challenges we have dealt with, and some solutions are probably superior to ours. We are happy to hear about such solutions and to improve our own.\nAs for the code presented in this post - it was extracted from our CI and cleaned up a bit. As such, it is missing some necessary boilerplate. It will not work as-is, and some work will be required to adapt it to your CI. That said, it should clearly lay out the solutions. (You can think of it as slide-ware.)\nLFS-Check All transitions can be bumpy. For us, the transition from storing binary files as regular git blobs to storing them using LFS was one such bumpy transition.\nWe made sure to include all the LFS-relevant files \u0026 patterns in a .gitattributes file, but ensuring everyone (including people who only occasionally work on the relevant repo) properly setup their environments for LFS took some time. In the mean-time, we kept getting files that should be in LFS committed and pushed as regular files in Merge-Requests.\nTo circumvent that, we set up a simple check at the start of our CI process to ensure all relevant files are indeed stored in LFS.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 lfs-check: only: refs: - merge_requests script: - git lfs install - git add --renormalize -u - | if ! git diff --cached --name-only --exit-code ; then echo echo echo \"==============================\" echo \"# Please renormalize files #\" echo \"==============================\" echo echo \"git add -u --renormalize\" echo \"git commit --amend\" exit 1 fi When people pushed the files the wrong way - the CI would fail with an informative error and instructions.\nRequired Commit Every so often a change is made to the code, rendering the code before the change unworkable or irrelevant. This can happen for many reasons. Here are some examples:\nA bug was fixed in the CI. This is all too common when forgetting to properly lock your dependencies (including recursive ones!) A very time-consuming update was made (re-training an ML model, anyone?) The change is significant and will make rebasing a pain A significant bug was fixed, making tests on the previous versions mostly irrelevant Once you introduce such a change to your code, you want people to know about it, and you want to stop wasting cycles on it.\nTo achieve this goal, we created a required-commit mechanism in our CI. For the CI to work, the required-commit must be an ancestor of the current commit. If it isn’t - the CI fails with a descriptive error \u0026 instructions for fixing the issue.\nOnce we have a new required-commit, we inform all developers in a dedicated Slack channel and update the CI to match. This ensures that even if a developer misses the notification on Slack, the CI will let them know what needs to be done.\nThe solution consists of a simple CI job:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 required-commit: only: refs: - merge_requests script: - apt-get update - | if ! git merge-base --is-ancestor ${REQUIRED_COMMIT:-HEAD} HEAD ; then echo echo echo \"=============================\" echo \"# Rebase Required #\" echo \"=============================\" echo echo \"Your base commit is out of date.\" echo \"Please update to ${REQUIRED_COMMIT} or later.\" echo \"The easiest fix is to rebase-onto or merge-from origin/main.\" echo echo exit 1 fi And a custom variable defined in the CI settings (see Create a custom variable in the UI):\nConditionally Building Job Docker Images Some of our code is deployed via Docker images. As such - we want our CI to build and test those images. Some tests require running a Docker container and communicating with it, but some tests (especially unit- and integration-tests) are easier to run inside the said containers. To accommodate the latter, we use our Docker images as the base images for the CI test jobs.\nThis is easy enough to do in the CI. In our case, however, building the Docker images takes a very long time. In trying to reduce this time, we split our build into two parts. The first - a long compilation phase, building some rarely-changing code; the second - installation of our fast-changing Python code \u0026 all relevant dependencies.\nNoticing the split between the fast-changing and rarely-changing parts of our build, we decided to split it in half, only building the first part when there’s an actual change to it.\nTo do that, however, we have to conditionally build the Docker image for the first half, and in the second half use either the preexisting first half or the newly built one.\nThe Solution - Build, Proxy, Promote Our solution uses a model consisting of multiple CI jobs handling different parts.\nBuild jobs - responsible for building docker images. Either conditionally (for the first part) or consistently (for the second part). Proxy jobs - responsible for handling the conditional nature of the build jobs, providing the next job with the relevant tag for the Docker images - either :latest or the current commit. Promote jobs - responsible for tagging the newly built images with :latest and pushing them. They run last. For our use-case, we used the following setup:\nConditional Build job to build the rarely-changing code Proxy job to yield the relevant tags Build job to build \u0026 install the fast-changing code Test job, to test the newly build code Promote job, pushing the newly build images as :latest if the tests passed To implement it, we created the following .yml configuration, representing the build-proxy-promote model, and used include:file to bring it into our .gitlab-ci.yml.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 # This file allows creating a prebuild-proxy-(build)-promote workflow with ease. # # The idea is that that in the prebuild step we build less-frequently-changed # docker images than in the build step. This allows us to significantly speed # up CI times. # # Setting Up # ========== # # A basic setup consists of the following: # # 1\\. Prebuild (extends .bpp:build) - build docker images if relevant files changed # 2\\. Proxy (extends .bpp:proxy) - allows the rest of the CI to know whether Prebuild created new images or not # 3\\. Build [Optional] (extends .bpp:build) - builds extra, more-frequently-changing images. # This is not a conditional step! # 4\\. Use (custom step) - here we actually use the images we created! # 5\\. Promote (extends .bpp:promote) - if required, pushes the newly built images to the project's repository. # # These 5 steps should be in 5 different, consecutive stages for things to work. # The prebuild step, being conditional, should not have any other step requiring it. # All other steps (that need the prebuilt images) should require the proxy step instead, # and use the ${PROXY_TAG} to as a label to the relevant docker images. .bpp:build: variables: # The names of all the docker images we want to pull from our registry TO_PULL: \"\" # The tag to use for pulling the images. This will usually be ${PROXY_TAG} PULL_TAG: \"\" # The name of the image and path of the dockerfile for building docker images. # The root path for the dockers will be the root of the project # Format the variable as follows: # # \u003e- # \"some_name the/relevant/path/Dockerfile\" # \"some_other_name another/relevant/path/Dockerfile\" # # Note that the quotes are significant! TO_BUILD: \"\" # The names of the images we want to push. # They will all be pushed with the ${CI_COMMIT_SHA} tag. TO_PUSH: \"\" script: - docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY_IMAGE} - export DOCKER_BUILDKIT=1 # This cannot be in the `variables` field since users overwrite it. - | for IMAGE_NAME in ${TO_PULL} do echo \"***********************************\" echo \"Pulling ${IMAGE_NAME}\" echo \"-----------------------------------\" echo \"docker pull ${CI_REGISTRY_IMAGE}/${IMAGE_NAME}:${PULL_TAG}\" echo \"DOCKER_BUILDKIT=1 docker tag \\ ${CI_REGISTRY_IMAGE}/${IMAGE_NAME}:${PULL_TAG} \\ ${CI_REGISTRY_IMAGE}/${IMAGE_NAME}:latest\" echo \"***********************************\" docker pull ${CI_REGISTRY_IMAGE}/${IMAGE_NAME}:${PULL_TAG} docker tag \\ ${CI_REGISTRY_IMAGE}/${IMAGE_NAME}:${PULL_TAG} \\ ${CI_REGISTRY_IMAGE}/${IMAGE_NAME}:latest done - | eval \"ARRAY=($TO_BUILD)\" for ITEM in \"${ARRAY[@]}\" do MY_NAME=${ITEM% *} MY_PATH=${ITEM#* } echo \"***********************************\" echo \"Building ${MY_NAME} from ${MY_PATH}\" echo \"-----------------------------------\" echo \"DOCKER_BUILDKIT=1 docker build \\ --build-arg BUILDKIT_INLINE_CACHE=1 \\ -t ${CI_REGISTRY_IMAGE}/${MY_NAME} \\ -t ${CI_REGISTRY_IMAGE}/${MY_NAME}:${CI_COMMIT_SHA} \\ -f ${MY_PATH} \\ --label \"commit_sha=${CI_COMMIT_SHA}\" \\ .\" echo \"***********************************\" docker build \\ --build-arg BUILDKIT_INLINE_CACHE=1 \\ -t ${CI_REGISTRY_IMAGE}/${MY_NAME} \\ -t ${CI_REGISTRY_IMAGE}/${MY_NAME}:${CI_COMMIT_SHA} \\ -f ${MY_PATH} \\ --label \"commit_sha=${CI_COMMIT_SHA}\" \\ . done - | for IMAGE_NAME in $TO_PUSH do echo \"***********************************\" echo \"Pushing ${IMAGE_NAME}\" echo \"-----------------------------------\" echo \"DOCKER_BUILDKIT=1 docker push ${CI_REGISTRY_IMAGE}/${IMAGE_NAME}:${CI_COMMIT_SHA}\" echo \"***********************************\" docker push ${CI_REGISTRY_IMAGE}/${IMAGE_NAME}:${CI_COMMIT_SHA} done .bpp:proxy: variables: # The names of jobs we want to proxy - if any of them succeeded, we proxy. BUILD_JOBS: \"\" script: - PROXY_TAG=latest - apt-get -qq update - apt-get -qq install jq # Get the successful jobs for the current pipeline - \u003e- curl --header \"PRIVATE-TOKEN:${GITLAB_TOKEN}\" \"${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/pipelines/${CI_PIPELINE_ID}/jobs?scope[]=success\" \u003e jobs.json # Compare the job names from the pipeline with the provided job names - EXECUTED=$(comm -12 \u003c(jq -r '.[].name' jobs.json | sort) \u003c(echo ${BUILD_JOBS} | tr ' ' '\\n' | sort)) # If a build job was executed, we need to set the proxy tag to the current commit sha. - | if [ ! -z \"$EXECUTED\" ] then PROXY_TAG=${CI_COMMIT_SHA} fi - echo \"PROXY_TAG=${PROXY_TAG}\" \u003e\u003e deploy.env # Print out the proxy tag - for debug purposes - echo \"PROXY_TAG=${PROXY_TAG}\" artifacts: # To get the proxy tag, you need to get the artifacts from this job. # The proxy tag will be ${PROXY_TAG} reports: dotenv: deploy.env .bpp:promote: variables: # The names of the images you wish to promote. # They need to have been built \u0026 pushed by a previous build step. TO_PROMOTE: \"\" script: - | if [ \"${PROXY_TAG}\" = \"latest\" ]; then echo \"Nothing to promote.\" else echo \"Promoting docker image.\" docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY_IMAGE} for IMAGE in ${TO_PROMOTE} ; do docker pull ${CI_REGISTRY_IMAGE}/${IMAGE}:${CI_COMMIT_SHA} docker tag ${CI_REGISTRY_IMAGE}/${IMAGE}:${CI_COMMIT_SHA} ${CI_REGISTRY_IMAGE}/${IMAGE}:latest docker push ${CI_REGISTRY_IMAGE}/${IMAGE}:latest done fi ","wordCount":"1842","inLanguage":"en","datePublished":"2021-03-10T00:00:00Z","dateModified":"2021-03-10T00:00:00Z","author":{"@type":"Person","name":"Tamir Bahar"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://tamir.dev/posts/gitlab-ci-tricks/"},"publisher":{"@type":"Organization","name":"Tamir Bahar","logo":{"@type":"ImageObject","url":"https://tamir.dev/images/profilepic.jpg"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tamir.dev/ accesskey=h title="Tamir Bahar (Alt + H)">Tamir Bahar</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://tamir.dev/blogvent/ title=blogvent🎄><span>blogvent🎄</span></a></li><li><a href=https://tamir.dev/posts/ title=posts><span>posts</span></a></li><li><a href=https://tamir.dev/archives/ title=archives><span>archives</span></a></li><li><a href=https://tamir.dev/index.xml title=rss><span>rss</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" height="13"><g transform="scale(1)"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></g></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://tamir.dev/>Home</a>&nbsp;»&nbsp;<a href=https://tamir.dev/posts/>Posts</a></div><h1 class=post-title>GitLab CI Tricks</h1><div class=post-description>A collection of useful hacks for the GitLab CI</div><div class=post-meta><span title='2021-03-10 00:00:00 +0000 UTC'>Mar 10, 2021</span>&nbsp;·&nbsp;Tamir Bahar</div></header><div class=post-content><p>In writing our CI setup at Vdoo, we came across some interesting challenges. Having solved them and used the solutions for quite a while, we decided it is best to share, and hopefully save others some time and effort solving similar problems.</p><p>Of course, there are alternative solutions to the challenges we have dealt with, and some solutions are probably superior to ours. We are happy to hear about such solutions and to improve our own.</p><p>As for the code presented in this post - it was extracted from our CI and cleaned up a bit. As such, it is missing some necessary boilerplate. It will not work as-is, and some work will be required to adapt it to your CI. That said, it should clearly lay out the solutions. (You can think of it as slide-ware.)</p><h2 id=lfs-check><a href=#lfs-check>LFS-Check<span hidden class=anchor aria-hidden=true href=#lfs-check>#</span></a></h2><p>All transitions can be bumpy. For us, the transition from storing binary files as regular git blobs to storing them using LFS was one such bumpy transition.</p><p>We made sure to include all the LFS-relevant files & patterns in a .gitattributes file, but ensuring everyone (including people who only occasionally work on the relevant repo) properly setup their environments for LFS took some time. In the mean-time, we kept getting files that should be in LFS committed and pushed as regular files in Merge-Requests.</p><p>To circumvent that, we set up a simple check at the start of our CI process to ensure all relevant files are indeed stored in LFS.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>lfs-check</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>only</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>refs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>merge_requests</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>git lfs install</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>git add --renormalize -u</span>
</span></span><span style=display:flex><span>    - |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      if ! git diff --cached --name-only --exit-code ; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo &#34;==============================&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo &#34;#  Please renormalize files  #&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo &#34;==============================&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo &#34;git add -u --renormalize&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo &#34;git commit --amend&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        exit 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      fi</span>      
</span></span></code></pre></td></tr></table></div></div><p>When people pushed the files the wrong way - the CI would fail with an informative error and instructions.</p><h2 id=required-commit><a href=#required-commit>Required Commit<span hidden class=anchor aria-hidden=true href=#required-commit>#</span></a></h2><p>Every so often a change is made to the code, rendering the code before the change unworkable or irrelevant. This can happen for many reasons. Here are some examples:</p><ol><li>A bug was fixed in the CI. This is all too common when forgetting to properly lock your dependencies (including recursive ones!)</li><li>A very time-consuming update was made (re-training an ML model, anyone?)</li><li>The change is significant and will make rebasing a pain</li><li>A significant bug was fixed, making tests on the previous versions mostly irrelevant</li></ol><p>Once you introduce such a change to your code, you want people to know about it, and you want to stop wasting cycles on it.</p><p>To achieve this goal, we created a required-commit mechanism in our CI. For the CI to work, the required-commit must be an ancestor of the current commit. If it isn&rsquo;t - the CI fails with a descriptive error & instructions for fixing the issue.</p><p>Once we have a new required-commit, we inform all developers in a dedicated Slack channel and update the CI to match. This ensures that even if a developer misses the notification on Slack, the CI will let them know what needs to be done.</p><p>The solution consists of a simple CI job:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>required-commit</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>only</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>refs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>merge_requests</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>apt-get update</span>
</span></span><span style=display:flex><span>    - |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      if ! git merge-base --is-ancestor ${REQUIRED_COMMIT:-HEAD} HEAD ; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo &#34;=============================&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo &#34;#      Rebase Required      #&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo &#34;=============================&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo &#34;Your base commit is out of date.&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo &#34;Please update to ${REQUIRED_COMMIT} or later.&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo &#34;The easiest fix is to rebase-onto or merge-from origin/main.&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        exit 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      fi</span>      
</span></span></code></pre></td></tr></table></div></div><p>And a custom variable defined in the CI settings (see <a href=https://docs.gitlab.com/ee/ci/variables/#create-a-custom-variable-in-the-ui>Create a custom variable in the UI</a>):</p><p><img src=/images/gitlab-ci-tricks.png alt="alt text"></p><h2 id=conditionally-building-job-docker-images><a href=#conditionally-building-job-docker-images>Conditionally Building Job Docker Images<span hidden class=anchor aria-hidden=true href=#conditionally-building-job-docker-images>#</span></a></h2><p>Some of our code is deployed via Docker images. As such - we want our CI to build and test those images. Some tests require running a Docker container and communicating with it, but some tests (especially unit- and integration-tests) are easier to run inside the said containers. To accommodate the latter, we use our Docker images as the base images for the CI test jobs.</p><p>This is easy enough to do in the CI. In our case, however, building the Docker images takes a very long time. In trying to reduce this time, we split our build into two parts. The first - a long compilation phase, building some rarely-changing code; the second - installation of our fast-changing Python code & all relevant dependencies.</p><p>Noticing the split between the fast-changing and rarely-changing parts of our build, we decided to split it in half, only building the first part when there&rsquo;s an actual change to it.</p><p>To do that, however, we have to conditionally build the Docker image for the first half, and in the second half use either the preexisting first half or the newly built one.</p><h3 id=the-solution---build-proxy-promote><a href=#the-solution---build-proxy-promote>The Solution - Build, Proxy, Promote<span hidden class=anchor aria-hidden=true href=#the-solution---build-proxy-promote>#</span></a></h3><p>Our solution uses a model consisting of multiple CI jobs handling different parts.</p><ol><li><strong>Build</strong> jobs - responsible for building docker images. Either conditionally (for the first part) or consistently (for the second part).</li><li><strong>Proxy</strong> jobs - responsible for handling the conditional nature of the build jobs, providing the next job with the relevant tag for the Docker images - either <code>:latest</code> or the current commit.</li><li><strong>Promote</strong> jobs - responsible for tagging the newly built images with <code>:latest</code> and pushing them. They run last.</li></ol><p>For our use-case, we used the following setup:</p><ol><li>Conditional <strong>Build</strong> job to build the rarely-changing code</li><li><strong>Proxy</strong> job to yield the relevant tags</li><li><strong>Build</strong> job to build & install the fast-changing code</li><li><strong>Test</strong> job, to test the newly build code</li><li><strong>Promote</strong> job, pushing the newly build images as <code>:latest</code> if the tests passed</li></ol><p>To implement it, we created the following <code>.yml</code> configuration, representing the build-proxy-promote model, and used <a href=https://docs.gitlab.com/ee/ci/yaml/#includefile><code>include:file</code></a> to bring it into our <code>.gitlab-ci.yml</code>.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">149
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">150
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># This file allows creating a prebuild-proxy-(build)-promote workflow with ease.  </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#  </span>
</span></span><span style=display:flex><span><span style=color:#75715e># The idea is that that in the prebuild step we build less-frequently-changed  </span>
</span></span><span style=display:flex><span><span style=color:#75715e># docker images than in the build step. This allows us to significantly speed  </span>
</span></span><span style=display:flex><span><span style=color:#75715e># up CI times.  </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#  </span>
</span></span><span style=display:flex><span><span style=color:#75715e># Setting Up  </span>
</span></span><span style=display:flex><span><span style=color:#75715e># ==========  </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#  </span>
</span></span><span style=display:flex><span><span style=color:#75715e># A basic setup consists of the following:  </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#  </span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1\. Prebuild (extends .bpp:build)  - build docker images if relevant files changed  </span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2\. Proxy (extends .bpp:proxy) - allows the rest of the CI to know whether Prebuild created new images or not  </span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3\. Build [Optional] (extends .bpp:build) - builds extra, more-frequently-changing images.  </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#                                             This is not a conditional step!  </span>
</span></span><span style=display:flex><span><span style=color:#75715e># 4\. Use (custom step) - here we actually use the images we created!  </span>
</span></span><span style=display:flex><span><span style=color:#75715e># 5\. Promote (extends .bpp:promote) - if required, pushes the newly built images to the project&#39;s repository.  </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#  </span>
</span></span><span style=display:flex><span><span style=color:#75715e># These 5 steps should be in 5 different, consecutive stages for things to work.  </span>
</span></span><span style=display:flex><span><span style=color:#75715e># The prebuild step, being conditional, should not have any other step requiring it.  </span>
</span></span><span style=display:flex><span><span style=color:#75715e># All other steps (that need the prebuilt images) should require the proxy step instead,  </span>
</span></span><span style=display:flex><span><span style=color:#75715e># and use the ${PROXY_TAG} to as a label to the relevant docker images.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>.bpp:build</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>variables</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># The names of all the docker images we want to pull from our registry</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>TO_PULL</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># The tag to use for pulling the images. This will usually be ${PROXY_TAG}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>PULL_TAG</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># The name of the image and path of the dockerfile for building docker images.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># The root path for the dockers will be the root of the project</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Format the variable as follows:</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#     &gt;-</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#       &#34;some_name the/relevant/path/Dockerfile&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#       &#34;some_other_name another/relevant/path/Dockerfile&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Note that the quotes are significant!</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>TO_BUILD</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># The names of the images we want to push.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># They will all be pushed with the ${CI_COMMIT_SHA} tag.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>TO_PUSH</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY_IMAGE}</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>export DOCKER_BUILDKIT=1</span> <span style=color:#75715e># This cannot be in the `variables` field since users overwrite it.</span>
</span></span><span style=display:flex><span>    - |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      for IMAGE_NAME in ${TO_PULL}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      do
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;***********************************&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;Pulling ${IMAGE_NAME}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;-----------------------------------&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;docker pull ${CI_REGISTRY_IMAGE}/${IMAGE_NAME}:${PULL_TAG}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;DOCKER_BUILDKIT=1 docker tag \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                ${CI_REGISTRY_IMAGE}/${IMAGE_NAME}:${PULL_TAG} \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                ${CI_REGISTRY_IMAGE}/${IMAGE_NAME}:latest&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;***********************************&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          docker pull ${CI_REGISTRY_IMAGE}/${IMAGE_NAME}:${PULL_TAG}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          docker tag \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              ${CI_REGISTRY_IMAGE}/${IMAGE_NAME}:${PULL_TAG} \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              ${CI_REGISTRY_IMAGE}/${IMAGE_NAME}:latest
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      done</span>      
</span></span><span style=display:flex><span>    - |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      eval &#34;ARRAY=($TO_BUILD)&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      for ITEM in &#34;${ARRAY[@]}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      do
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          MY_NAME=${ITEM% *}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          MY_PATH=${ITEM#* }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;***********************************&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;Building ${MY_NAME} from ${MY_PATH}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;-----------------------------------&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;DOCKER_BUILDKIT=1 docker build \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              --build-arg BUILDKIT_INLINE_CACHE=1 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              -t ${CI_REGISTRY_IMAGE}/${MY_NAME} \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              -t ${CI_REGISTRY_IMAGE}/${MY_NAME}:${CI_COMMIT_SHA} \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              -f ${MY_PATH} \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              --label &#34;commit_sha=${CI_COMMIT_SHA}&#34; \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              .&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;***********************************&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          docker build \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              --build-arg BUILDKIT_INLINE_CACHE=1 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              -t ${CI_REGISTRY_IMAGE}/${MY_NAME} \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              -t ${CI_REGISTRY_IMAGE}/${MY_NAME}:${CI_COMMIT_SHA} \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              -f ${MY_PATH} \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      		  --label &#34;commit_sha=${CI_COMMIT_SHA}&#34; \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              .
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      done</span>      
</span></span><span style=display:flex><span>    - |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      for IMAGE_NAME in $TO_PUSH
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      do
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;***********************************&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;Pushing ${IMAGE_NAME}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;-----------------------------------&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;DOCKER_BUILDKIT=1 docker push ${CI_REGISTRY_IMAGE}/${IMAGE_NAME}:${CI_COMMIT_SHA}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;***********************************&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          docker push ${CI_REGISTRY_IMAGE}/${IMAGE_NAME}:${CI_COMMIT_SHA}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      done</span>      
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>.bpp:proxy</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>variables</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># The names of jobs we want to proxy - if any of them succeeded, we proxy.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>BUILD_JOBS</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>PROXY_TAG=latest</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>apt-get -qq update</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>apt-get -qq install jq</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Get the successful jobs for the current pipeline</span>
</span></span><span style=display:flex><span>    - &gt;-<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      curl
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      --header &#34;PRIVATE-TOKEN:${GITLAB_TOKEN}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/pipelines/${CI_PIPELINE_ID}/jobs?scope[]=success&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &gt; jobs.json</span>      
</span></span><span style=display:flex><span>    <span style=color:#75715e># Compare the job names from the pipeline with the provided job names</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>EXECUTED=$(comm -12 &lt;(jq -r &#39;.[].name&#39; jobs.json | sort) &lt;(echo ${BUILD_JOBS} | tr &#39; &#39; &#39;\n&#39; | sort))</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># If a build job was executed, we need to set the proxy tag to the current commit sha.</span>
</span></span><span style=display:flex><span>    - |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      if [ ! -z &#34;$EXECUTED&#34; ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          PROXY_TAG=${CI_COMMIT_SHA}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      fi</span>      
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>echo &#34;PROXY_TAG=${PROXY_TAG}&#34; &gt;&gt; deploy.env</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Print out the proxy tag - for debug purposes</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>echo &#34;PROXY_TAG=${PROXY_TAG}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>artifacts</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># To get the proxy tag, you need to get the artifacts from this job.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># The proxy tag will be ${PROXY_TAG}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>reports</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>dotenv</span>: <span style=color:#ae81ff>deploy.env</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>.bpp:promote</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>variables</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># The names of the images you wish to promote.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># They need to have been built &amp; pushed by a previous build step.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>TO_PROMOTE</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    - |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      if [ &#34;${PROXY_TAG}&#34; = &#34;latest&#34; ]; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;Nothing to promote.&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      else
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;Promoting docker image.&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY_IMAGE}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          for IMAGE in ${TO_PROMOTE} ; do
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              docker pull ${CI_REGISTRY_IMAGE}/${IMAGE}:${CI_COMMIT_SHA}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              docker tag ${CI_REGISTRY_IMAGE}/${IMAGE}:${CI_COMMIT_SHA} ${CI_REGISTRY_IMAGE}/${IMAGE}:latest
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              docker push ${CI_REGISTRY_IMAGE}/${IMAGE}:latest
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          done
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      fi</span>      
</span></span></code></pre></td></tr></table></div></div></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://tamir.dev/>Tamir Bahar</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>