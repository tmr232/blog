<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Goats in the command line | Tamir Bahar</title><meta name=keywords content="go,cli"><meta name=description content="Experimenting with CLI interfaces in Go"><meta name=author content><link rel=canonical href=https://tamir.dev/posts/goat-codegen-initial/><link crossorigin=anonymous href=/assets/css/stylesheet.f89fe5ba0a1e1e3a66da8210c0add5c0528394d79616f1e033496028ca8dd450.css integrity="sha256-+J/lugoeHjpm2oIQwK3VwFKDlNeWFvHgM0lgKMqN1FA=" rel="preload stylesheet" as=style><link rel=icon href=https://tamir.dev/images/profilepic.jpg><link rel=icon type=image/png sizes=16x16 href=https://tamir.dev/images/profilepic.jpg><link rel=icon type=image/png sizes=32x32 href=https://tamir.dev/images/profilepic.jpg><link rel=apple-touch-icon href=https://tamir.dev/images/profilepic.jpg><link rel=mask-icon href=https://tamir.dev/images/profilepic.jpg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Goats in the command line"><meta property="og:description" content="Experimenting with CLI interfaces in Go"><meta property="og:type" content="article"><meta property="og:url" content="https://tamir.dev/posts/goat-codegen-initial/"><meta property="og:image" content="https://tamir.dev/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-02T00:00:00+00:00"><meta property="article:modified_time" content="2022-06-02T00:00:00+00:00"><meta property="og:site_name" content="Tamir Bahar"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://tamir.dev/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Goats in the command line"><meta name=twitter:description content="Experimenting with CLI interfaces in Go"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://tamir.dev/posts/"},{"@type":"ListItem","position":2,"name":"Goats in the command line","item":"https://tamir.dev/posts/goat-codegen-initial/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Goats in the command line","name":"Goats in the command line","description":"Experimenting with CLI interfaces in Go","keywords":["go","cli"],"articleBody":"This is more of a sharing-my-thoughts or work-in-progress post than a technical tutorial, so be warned üòâ\nMotivation As a Python programmer, I get to experience the joy of using Typer when creating CLI tools.\nIt allows for zero-boilerplate CLI apps using type annotations:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 import typer def app(name:str, goodbye:bool=False): if goodbye: print(f\"Goodbye, {name}.\") else: print(f\"Hello, {name}!\") def main(): typer.run(app) if __name__ == '__main__': main() Then, when I run it:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 $ python app.py --help Usage: app.py [OPTIONS] NAME Arguments: NAME [required] Options: --goodbye / --no-goodbye [default: no-goodbye] --install-completion [bash|zsh|fish|powershell|pwsh] Install completion for the specified shell. --show-completion [bash|zsh|fish|powershell|pwsh] Show completion for the specified shell, to copy it or customize the installation. --help Show this message and exit. As far as I‚Äôm concerned, this is absolutely amazing. I already use type annotations quite often, so Typer is literally zero boilerplate.\nIn Go, however, the situation is more involved. There are multiple flag parsing libraries (flag, Cobra, urfave/cli), but all of them require some extra code for things to work. You need to define your flags, at the very least. They are great libraries. But coming from Python - I want more. Or less, depending on how you look at it. I want the following to just work:\n1 2 3 4 5 6 7 8 9 10 11 12 func app(name string, goodbye bool) { if goodbye { fmt.Printf(\"Goodbye, %s.\\n\", name) } else { fmt.Printf(\"Hello, %s!\\n\", name) } } func main() { goat.Run(app) } And‚Ä¶ Now it does.\nGoat üêê Goat, or Go Approximation of Typer, is my work-in-progress very-experimental solution to that!\nWith goat, the code in the sample above works. Well, as long as you add a //go:generate line to it üòâ\nYou see, Go doesn‚Äôt want you doing crazy things at compile time, or using runtime reflection, or at any place where it‚Äôs hard for the user to look at the code and see what it actually does. That‚Äôs great and all, but we want to create hacky don‚Äôt-look-behind-the-curtain code. So, with Go being Go, we use code generation.\nHandwritten Before we can generate code - we need to know what to generate. In our case (as I said - it‚Äôs a work in progress, so we‚Äôre being quite specific‚Ä¶) we need the following:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 func app(name string, goodbye bool) { if goodbye { fmt.Printf(\"Goodbye, %s.\\n\", name) } else { fmt.Printf(\"Hello, %s!\\n\", name) } } func appWrapper() { var name string var goodbye bool __goatApp := \u0026cli.App{ Flags: []cli.Flag{ \u0026cli.StringFlag{ Name: \"name\", Destination: \u0026name, Required: true, }, \u0026cli.BoolFlag{ Name: \"goodbye\", Destination: \u0026goodbye, }, }, Action: func(c *cli.Context) { app(name, goodbye) }, } __err := __goatApp.Run(os.Args) if __err != nil { log.Fatal(__err) } } (here we‚Äôre using urfave/cli because it‚Äôs the one I‚Äôm most familiar with, and because it doesn‚Äôt use globals.)\nGeneration To generate the code, we use the packages package. It is the easiest interface I know to parsing complete packages and getting the relevant type information. That, in turn, allows us to get the argument information and generate the code.\nbool parameters become Boolean flags, string parameters become string flags, and so on. To know which is the relevant ‚Äúapp‚Äù, we check the call to goat.Run. The code can be a bit tricky, but the logic is very straightforward.\nAs for the physical location of the code - we create a new file in the same package (read: directory) and go handles the rest for us, as long as there are no naming conflicts.\nOnly one issue remains - how to connect the goat.Run call to the appWrapper function.\nPlumbing We currently have 3 building blocks:\nfunc app(string, bool), our application function func appWrapper(), our generated wrapper function, using the flag parsing library func main(), our program‚Äôs entrypoint, calling goat.Run(app). We need to make goat.Run(app) call appWrapper instead, somehow. The problem being - our goat package (where the goat.Run method is defined) does not know about appWrapper. To fix that, we‚Äôll introduce them.\nTo do that, we‚Äôll have our app register appWrapper as the wrapper for app before running func main(). Luckily for us, Go allows for dynamic initialization using func init(). init() is a special function. You can define as many as you want, and they run during initialization. That is, before func main().\nOur generated init is as follows:\n1 2 3 func init() { goat.Register(app, appWrapper) } And that‚Äôs it.\nOur goat package is super simple as well:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // This is our registry - mapping functions to their wrappers var registry map[reflect.Value]func() // We initialize it to an empty map, to prevent our code from crashing func init() { registry = make(map[reflect.Value]func()) } // Register wrappers using the register function func Register(app any, wrapper func()) { registry[reflect.ValueOf(app)] = wrapper } func Run(f any) { // All that `goat.Run` has to do is lookup the wrapper and call it registry[reflect.ValueOf(f)]() } As for the reflect.ValueOf calls - functions in Go are not hashable, and cannot be used as map keys (that‚Äôs a sensible choice). That said, we need to hash them. So as a workaround, we use reflection to query the value of the function. reflect.Value objects are hashable, so it all works out in the end.\nTry It Yourself The code is online at tmr232/goat.\nBut, again, it is a work-in-progress and very experimental. It might break or change at any moment.\n","wordCount":"968","inLanguage":"en","datePublished":"2022-06-02T00:00:00Z","dateModified":"2022-06-02T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://tamir.dev/posts/goat-codegen-initial/"},"publisher":{"@type":"Organization","name":"Tamir Bahar","logo":{"@type":"ImageObject","url":"https://tamir.dev/images/profilepic.jpg"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tamir.dev/ accesskey=h title="Tamir Bahar (Alt + H)">Tamir Bahar</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://tamir.dev/posts/ title=posts><span>posts</span></a></li><li><a href=https://tamir.dev/archives/ title=archives><span>archives</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Goats in the command line</h1><div class=post-description>Experimenting with CLI interfaces in Go</div><div class=post-meta><span title='2022-06-02 00:00:00 +0000 UTC'>June 2, 2022</span></div></header><div class=post-content><p>This is more of a sharing-my-thoughts or work-in-progress post than a technical tutorial, so be warned üòâ</p><h2 id=motivation>Motivation<a hidden class=anchor aria-hidden=true href=#motivation>#</a></h2><p>As a Python programmer, I get to experience the joy of using <a href=https://typer.tiangolo.com/>Typer</a> when creating CLI tools.</p><p>It allows for zero-boilerplate CLI apps using type annotations:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> typer
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>app</span>(name:str, goodbye:bool<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> goodbye:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Goodbye, </span><span style=color:#e6db74>{</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>.&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Hello, </span><span style=color:#e6db74>{</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>!&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    typer<span style=color:#f92672>.</span>run(app)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    main()
</span></span></code></pre></td></tr></table></div></div><p>Then, when I run it:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python app.py --help
</span></span><span style=display:flex><span>Usage: app.py <span style=color:#f92672>[</span>OPTIONS<span style=color:#f92672>]</span> NAME
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Arguments:
</span></span><span style=display:flex><span>  NAME  <span style=color:#f92672>[</span>required<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Options:
</span></span><span style=display:flex><span>  --goodbye / --no-goodbye        <span style=color:#f92672>[</span>default: no-goodbye<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  --install-completion <span style=color:#f92672>[</span>bash|zsh|fish|powershell|pwsh<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>                                  Install completion <span style=color:#66d9ef>for</span> the specified shell.
</span></span><span style=display:flex><span>  --show-completion <span style=color:#f92672>[</span>bash|zsh|fish|powershell|pwsh<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>                                  Show completion <span style=color:#66d9ef>for</span> the specified shell, to
</span></span><span style=display:flex><span>                                  copy it or customize the installation.
</span></span><span style=display:flex><span>  --help                          Show this message and exit.
</span></span></code></pre></td></tr></table></div></div><p>As far as I&rsquo;m concerned, this is absolutely amazing.
I already use type annotations quite often, so <a href=https://typer.tiangolo.com/>Typer</a> is literally zero boilerplate.</p><p>In Go, however, the situation is more involved.
There are multiple flag parsing libraries (<a href=https://pkg.go.dev/flag>flag</a>, <a href=https://cobra.dev/>Cobra</a>, <a href=https://cli.urfave.org/>urfave/cli</a>), but all of them require some extra code for things to work.
You need to define your flags, at the very least.
They are great libraries.
But coming from Python - I want more. Or less, depending on how you look at it.
I want the following to just work:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>app</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>goodbye</span> <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>goodbye</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Goodbye, %s.\n&#34;</span>, <span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Hello, %s!\n&#34;</span>, <span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>goat</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>And&mldr; Now it does.</p><h2 id=goat->Goat üêê<a hidden class=anchor aria-hidden=true href=#goat->#</a></h2><p><a href=https://github.com/tmr232/goat>Goat</a>, or <strong>Go</strong> <strong>A</strong>pproximation of <strong>T</strong>yper, is my work-in-progress very-experimental solution to that!</p><p>With goat, the code in the sample above <em>works</em>. Well, as long as you add a <code>//go:generate</code> line to it üòâ</p><p>You see, Go doesn&rsquo;t want you doing crazy things at compile time, or using runtime reflection,
or at any place where it&rsquo;s hard for the user to look at the code and see what it actually does.
That&rsquo;s great and all, but we <em>want</em> to create hacky don&rsquo;t-look-behind-the-curtain code.
So, with Go being Go, we use code generation.</p><h2 id=handwritten>Handwritten<a hidden class=anchor aria-hidden=true href=#handwritten>#</a></h2><p>Before we can generate code - we need to know what to generate.
In our case (as I said - it&rsquo;s a work in progress, so we&rsquo;re being quite specific&mldr;) we need the following:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>app</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>goodbye</span> <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>goodbye</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Goodbye, %s.\n&#34;</span>, <span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Hello, %s!\n&#34;</span>, <span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>appWrapper</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>goodbye</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>__goatApp</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cli</span>.<span style=color:#a6e22e>App</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Flags</span>: []<span style=color:#a6e22e>cli</span>.<span style=color:#a6e22e>Flag</span>{
</span></span><span style=display:flex><span>            <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cli</span>.<span style=color:#a6e22e>StringFlag</span>{
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>Name</span>:        <span style=color:#e6db74>&#34;name&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>Destination</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>name</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>Required</span>:    <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cli</span>.<span style=color:#a6e22e>BoolFlag</span>{
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>Name</span>:        <span style=color:#e6db74>&#34;goodbye&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>Destination</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>goodbye</span>,
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Action</span>: <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>cli</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>app</span>(<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>goodbye</span>)
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>__err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>__goatApp</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>__err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>__err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>(here we&rsquo;re using <a href=https://cli.urfave.org/>urfave/cli</a> because it&rsquo;s the one I&rsquo;m most familiar with, and because it doesn&rsquo;t use globals.)</p><h2 id=generation>Generation<a hidden class=anchor aria-hidden=true href=#generation>#</a></h2><p>To generate the code, we use the <a href=https://pkg.go.dev/golang.org/x/tools/go/packages>packages</a> package.
It is the easiest interface I know to parsing complete packages and getting the relevant type information.
That, in turn, allows us to get the argument information and generate the code.</p><p><code>bool</code> parameters become Boolean flags, <code>string</code> parameters become string flags, and so on.
To know which is the relevant &ldquo;app&rdquo;, we check the call to <code>goat.Run</code>.
The code can be a bit tricky, but the logic is very straightforward.</p><p>As for the physical location of the code - we create a new file in the same package (read: directory) and go handles the rest for us, as long as there are no naming conflicts.</p><p>Only one issue remains - how to connect the <code>goat.Run</code> call to the <code>appWrapper</code> function.</p><h2 id=plumbing>Plumbing<a hidden class=anchor aria-hidden=true href=#plumbing>#</a></h2><p>We currently have 3 building blocks:</p><ol><li><code>func app(string, bool)</code>, our application function</li><li><code>func appWrapper()</code>, our generated wrapper function, using the flag parsing library</li><li><code>func main()</code>, our program&rsquo;s entrypoint, calling <code>goat.Run(app)</code>.</li></ol><p>We need to make <code>goat.Run(app)</code> call <code>appWrapper</code> instead, somehow.
The problem being - our <code>goat</code> package (where the <code>goat.Run</code> method is defined) does not know about <code>appWrapper</code>.
To fix that, we&rsquo;ll introduce them.</p><p>To do that, we&rsquo;ll have our app register <code>appWrapper</code> as the wrapper for <code>app</code> <em>before</em> running <code>func main()</code>.
Luckily for us, Go allows for dynamic initialization using <code>func init()</code>.
<code>init()</code> is a special function. You can define as many as you want, and they run during initialization.
That is, before <code>func main()</code>.</p><p>Our generated <code>init</code> is as follows:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>goat</span>.<span style=color:#a6e22e>Register</span>(<span style=color:#a6e22e>app</span>, <span style=color:#a6e22e>appWrapper</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>And that&rsquo;s it.</p><p>Our <code>goat</code> package is super simple as well:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// This is our registry - mapping functions to their wrappers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>registry</span> <span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>Value</span>]<span style=color:#66d9ef>func</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// We initialize it to an empty map, to prevent our code from crashing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>registry</span> = make(<span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>Value</span>]<span style=color:#66d9ef>func</span>())
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Register wrappers using the register function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Register</span>(<span style=color:#a6e22e>app</span> <span style=color:#a6e22e>any</span>, <span style=color:#a6e22e>wrapper</span> <span style=color:#66d9ef>func</span>()) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>registry</span>[<span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>ValueOf</span>(<span style=color:#a6e22e>app</span>)] = <span style=color:#a6e22e>wrapper</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>f</span> <span style=color:#a6e22e>any</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// All that `goat.Run` has to do is lookup the wrapper and call it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>registry</span>[<span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>ValueOf</span>(<span style=color:#a6e22e>f</span>)]()
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>As for the <code>reflect.ValueOf</code> calls - functions in Go are not hashable, and cannot be used as map keys (that&rsquo;s a sensible choice).
That said, we <em>need</em> to hash them. So as a workaround, we use reflection to query the value of the function.
<code>reflect.Value</code> objects <em>are</em> hashable, so it all works out in the end.</p><h2 id=try-it-yourself>Try It Yourself<a hidden class=anchor aria-hidden=true href=#try-it-yourself>#</a></h2><p>The code is online at <a href=https://github.com/tmr232/goat>tmr232/goat</a>.</p><p>But, again, it is a work-in-progress and very experimental. It might break or change at any moment.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://tamir.dev/tags/go/>go</a></li><li><a href=https://tamir.dev/tags/cli/>cli</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://tamir.dev/>Tamir Bahar</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>