<!doctype html><html lang=en>
<head>
<title>TIL Python attribute lookup order is tricky - tamir.dev</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="The HTML5 Herald">
<meta name=author content="Tamir Bahar"><meta property="og:title" content="TIL Python attribute lookup order is tricky">
<meta property="og:description" content="This post is brought to you in the spirit of converting tweetstorms to blogposts. to the tweetstorm
Surprise! üéÅ In Python, if property access raises AttributeError, and the class implemented getattr, it will get called with the property name.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://www.tamir.dev/posts/til-python-attribute-lookup-order-is-tricky/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-06-03T00:00:00+00:00">
<meta property="article:modified_time" content="2020-06-03T00:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="TIL Python attribute lookup order is tricky">
<meta name=twitter:description content="This post is brought to you in the spirit of converting tweetstorms to blogposts. to the tweetstorm
Surprise! üéÅ In Python, if property access raises AttributeError, and the class implemented getattr, it will get called with the property name.">
<meta name=generator content="Hugo 0.89.0">
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous>
<link rel=stylesheet href=https://www.tamir.dev/fontawesome/css/all.min.css>
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda">
<link rel=stylesheet type=text/css href=https://www.tamir.dev/css/styles.css></head>
<body>
<div id=container>
<header>
<h1>
<a href=https://www.tamir.dev/>tamir.dev</a>
</h1>
<ul id=social-media>
<li>
<a href=https://github.com/tmr232 title=GitHub>
<i class="fab fa-github fa-lg"></i>
</a>
</li>
<li>
<a href=https://twitter.com/tmr232 title=Twitter>
<i class="fab fa-twitter fa-lg"></i>
</a>
</li>
<li>
<a href=https://stackoverflow.com/users/3337893/tmr232 title=StackOverflow>
<i class="fab fa-stack-overflow fa-lg"></i>
</a>
</li>
<li>
<a href=https://dev.to/tmr232 title=devto>
<i class="fab fa-dev fa-lg"></i>
</a>
</li>
</ul>
</header>
<nav>
<ul>
</ul>
</nav>
<main>
<article>
<h1>TIL Python attribute lookup order is tricky</h1>
<aside>
<ul>
<li>
<time class=post-date datetime=2020-06-03T00:00:00Z>Jun 3, 2020</time>
</li>
<li>4 minute read</li>
</ul>
</aside>
<p><em>This post is brought to you in the spirit of converting tweetstorms to blogposts.
<a href=https://twitter.com/tmr232/status/1268244709723582467>to the tweetstorm</a></em></p>
<h2 id=surprise->Surprise! üéÅ</h2>
<p>In Python, if property access raises AttributeError, and the class implemented <strong>getattr</strong>, it will get called with the property name.
This results in some very cryptic errors.</p>
<p>If you run the following code (<a href=https://repl.it/repls/PresentBitterUnit>repl</a>):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Thing</span>:
    name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Thing&#34;</span>


<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NameProvider</span>:
    <span style=color:#66d9ef>def</span> __init__(self, name):
        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name

    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_name</span>(self):
        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>nam


<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ThingWrapper</span>:
    <span style=color:#66d9ef>def</span> __init__(self, thing, name_provider):
        self<span style=color:#f92672>.</span>thing <span style=color:#f92672>=</span> thing
        self<span style=color:#f92672>.</span>name_provider <span style=color:#f92672>=</span> name_provider

    <span style=color:#a6e22e>@property</span>
    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>name</span>(self):
        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>name_provider<span style=color:#f92672>.</span>get_name()

    <span style=color:#66d9ef>def</span> __getattr__(self, name):
        <span style=color:#66d9ef>return</span> getattr(self<span style=color:#f92672>.</span>thing, name)


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
    thing <span style=color:#f92672>=</span> Thing()
    name_provider <span style=color:#f92672>=</span> NameProvider(name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Not Thing&#34;</span>)

    thing_wrapper <span style=color:#f92672>=</span> ThingWrapper(thing, name_provider)

    print(thing<span style=color:#f92672>.</span>name)
    print(thing_wrapper<span style=color:#f92672>.</span>name)


<span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
    main()

</code></pre></div><p>You&rsquo;ll get a surprising result:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>Thing
Thing
</code></pre></div><p>You might have expected <code>"Not Thing"</code> as the second line, or maybe an exception to be raised from <code>NameProvider.get_name()</code> due to the typo there (<code>self.nam</code> instead of <code>self.name</code>). But instead, we got the name attribute from our <code>Thing</code> instance.</p>
<h2 id=analysis->Analysis üîé</h2>
<p>If you&rsquo;ve every used <code>__getattr__()</code> you know that it is called when the named attribute was not found using other lookup mechanisms. That said, it might not be clear to you that this includes properties raising <code>AttributeError</code> exceptions. It definitely wasn&rsquo;t clear to me.</p>
<p>That is, it was unclear to me despite being clearly stated in the <a href=https://docs.python.org/3/reference/datamodel.html#object.__getattr__>documentation for <strong>getattr</strong>()</a></p>
<blockquote>
<p><strong><code>object.__getattr__(self, name)</code></strong>
Called when the default attribute access fails with an <code>AttributeError</code> (either <code>__getattribute__()</code> raises an <code>AttributeError</code> because name is not an instance attribute or an attribute in the class tree for self; or <code>__get__()</code> of a name property raises <code>AttributeError</code>). This method should either return the (computed) attribute value or raise an <code>AttributeError</code> exception.</p>
</blockquote>
<p>Beside being surprising, there are 2 main issues here:</p>
<ol>
<li>Any code down the stack from the property can effectively change attribute lookup for the class by throwing an <code>AttributeError</code>. In the above example - a typo in <code>NameProvider</code> caused an attribute to be taken from <code>Thing</code> instead, against the programmer&rsquo;s obvious intention.</li>
<li>The exception is silenced. There is no way for the programmer to catch the exception outside the property getter. This makes the errors <em>very</em> hard to track down. This also means that whenever you add <code>__getattr__()</code> to a class, you&rsquo;re silencing all <code>AttributeError</code> exceptions that were previously thrown from properties.</li>
</ol>
<p>Like anything in Python, you can hack around the issue. In this case - with fancy decorators!</p>
<h2 id=solution->Solution? üêç</h2>
<p>Consider the following code (<a href=https://repl.it/repls/IntentionalIgnorantLinuxpc>repl</a>):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ExceptionCatcher</span>:
    <span style=color:#66d9ef>def</span> __init__(self, f):
        self<span style=color:#f92672>.</span>f <span style=color:#f92672>=</span> f
        self<span style=color:#f92672>.</span>exception <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>

    <span style=color:#66d9ef>def</span> __call__(self, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
        <span style=color:#66d9ef>try</span>:
            <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>f(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
        <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
            self<span style=color:#f92672>.</span>exception <span style=color:#f92672>=</span> e
            <span style=color:#66d9ef>raise</span>
        <span style=color:#66d9ef>else</span>:
            self<span style=color:#f92672>.</span>exception <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>store_exception</span>(f):
    <span style=color:#66d9ef>return</span> ExceptionCatcher(f)


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>load_exception</span>(f):
    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_raise_property_exception</span>(instance, name):
        <span style=color:#66d9ef>try</span>:
            class_attr <span style=color:#f92672>=</span> getattr(instance<span style=color:#f92672>.</span>__class__, name)
            <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> isinstance(class_attr, property):
                <span style=color:#66d9ef>return</span>
            exception <span style=color:#f92672>=</span> class_attr<span style=color:#f92672>.</span>fget<span style=color:#f92672>.</span>exception
        <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>AttributeError</span>:
            <span style=color:#66d9ef>return</span>

        <span style=color:#66d9ef>if</span> exception:
            <span style=color:#66d9ef>raise</span> exception

    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_wrapper</span>(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
        _raise_property_exception(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
        <span style=color:#66d9ef>return</span> f(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)

    <span style=color:#66d9ef>return</span> _wrapper


<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ThingWrapper</span>:
    <span style=color:#66d9ef>def</span> __init__(self, thing, name_provider):
        self<span style=color:#f92672>.</span>thing <span style=color:#f92672>=</span> thing
        self<span style=color:#f92672>.</span>name_provider <span style=color:#f92672>=</span> name_provider

    <span style=color:#a6e22e>@property</span>
    <span style=color:#a6e22e>@store_exception</span>
    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>name</span>(self):
        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>name_provider<span style=color:#f92672>.</span>get_name()

    <span style=color:#a6e22e>@load_exception</span>
    <span style=color:#66d9ef>def</span> __getattr__(self, name):
        <span style=color:#66d9ef>return</span> getattr(self<span style=color:#f92672>.</span>thing, name)
</code></pre></div><p>If you run this version, you&rsquo;ll get the following exception:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#a6e22e>AttributeError</span>: <span style=color:#e6db74>&#39;NameProvider&#39;</span> object has no attribute <span style=color:#e6db74>&#39;nam&#39;</span>
</code></pre></div><p>This matches our expectations far better.</p>
<p>This result is achieved in two steps. First, we store all the exceptions thrown from <code>name()</code> so that we can throw them again if needed. Then, before calling <code>__getattr__()</code>, we check if we got there due to a property raising an exception. If we did - we just re-raise that exception.</p>
<p>The rest is implementation details, and I probably missed something there (you might notice that I corrected a bug when converting the tweets to this post - in the previous version, I forget to reset the exception storage after successful property retrieval).</p>
<p>While this solution works, and may be useful for detecting similar bugs, I would probably avoid using it in production code. Instead, I&rsquo;d be happy to have some standard Python construct to provide this functionality.</p>
</article>
<section class=post-nav>
<ul>
<li>
<a href=https://www.tamir.dev/posts/snake-eyes-extension-methods/><i class="fa fa-chevron-circle-left"></i> Snake Eyes: Extension Methods</a>
</li>
<li>
<a href=https://www.tamir.dev/posts/finding-a-memory-leak-in-my-python-code/>Finding a memory-leak in my Python code <i class="fa fa-chevron-circle-right"></i> </a>
</li>
</ul>
</section>
</main>
<footer>
<ul>
<li>
<h6>Copyright ¬© 2021 - Tamir Bahar |
Rendered by <a href=https://gohugo.io title=Hugo>Hugo</a> |
<a href=https://www.tamir.dev/index.xml>Subscribe </a></h6>
</li>
</ul>
</footer>
</div>
<script src=https://www.tamir.dev/js/scripts.js></script>
</body>
</html>