<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Snake Eyes: C++ Scoped enums | Tamir Bahar</title><meta name=keywords content="python,C++,misguided"><meta name=description content="Implementing C++ Scoped Enums in Python"><meta name=author content><link rel=canonical href=https://tamir.dev/posts/snake-eyes-cpp-scoped-enums/><link crossorigin=anonymous href=/assets/css/stylesheet.45644aa474dc79df40198665054ee839f669de372852cf1df60cb49538828f48.css integrity="sha256-RWRKpHTced9AGYZlBU7oOfZp3jcoUs8d9gy0lTiCj0g=" rel="preload stylesheet" as=style><link rel=icon href=https://tamir.dev/images/profilepic.jpg><link rel=icon type=image/png sizes=16x16 href=https://tamir.dev/images/profilepic.jpg><link rel=icon type=image/png sizes=32x32 href=https://tamir.dev/images/profilepic.jpg><link rel=apple-touch-icon href=https://tamir.dev/images/profilepic.jpg><link rel=mask-icon href=https://tamir.dev/images/profilepic.jpg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Snake Eyes: C++ Scoped enums"><meta property="og:description" content="Implementing C++ Scoped Enums in Python"><meta property="og:type" content="article"><meta property="og:url" content="https://tamir.dev/posts/snake-eyes-cpp-scoped-enums/"><meta property="og:image" content="https://tamir.dev/images/profilepic.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-24T00:00:00+00:00"><meta property="article:modified_time" content="2023-04-24T00:00:00+00:00"><meta property="og:site_name" content="Tamir Bahar"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://tamir.dev/images/profilepic.jpg"><meta name=twitter:title content="Snake Eyes: C++ Scoped enums"><meta name=twitter:description content="Implementing C++ Scoped Enums in Python"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://tamir.dev/posts/"},{"@type":"ListItem","position":2,"name":"Snake Eyes: C++ Scoped enums","item":"https://tamir.dev/posts/snake-eyes-cpp-scoped-enums/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Snake Eyes: C++ Scoped enums","name":"Snake Eyes: C\u002b\u002b Scoped enums","description":"Implementing C++ Scoped Enums in Python","keywords":["python","C++","misguided"],"articleBody":"Often, we write code to complete a task. Other times, we write code to learn something new. But there are also those rare occasions where our goals are simpler. When we have a dumb idea stuck in our head, and the only way to get it out is to code it. Or when we just want to see, to prove to ourselves, that we can write a certain piece of code.\nThis post is about one of those wonderful occasions. Specifically - I had to see whether I can implement C++ Scoped Enumerations in Python. And, since you’re reading this post, it’s fair to assume that I succeeded.\nC++ Scoped Enumerations If you’re not a C++ programmer (good for you!) you may be wondering - what are scoped enumerations?\nWell, first and foremost - they are enumerations. A nice syntactic sugar to define a group of named, constant integer values. They look like this:\n1 2 3 4 5 enum class Colors { Red, Green, Blue }; (Here Colors::Red is 0, Colors::Green is 1, and Colors::Blue is 2.)\nSecondly, they are scoped. This might seem obvious to anyone not coming from C (or older C++), but this means that the names only exist under the enumeration that defines them. You can write Colors::Red to get the Red value, but just writing Red somewhere won’t get it. Yes, this seems obvious, but it wasn’t the case until C++11.\nThat’s about it.\nOf course, we can talk about the fact that they are a form of a strong typdef, and disallow implicit conversions, and more… But we’re to bury implement enums not to praise them.\nScoped Enums in Python Why implement this in Python, you might ask. After all, we have enum.Enum, and that’s plenty good:\n1 2 3 4 class Colors(Enum): Red = auto() Green = auto() Blue = auto() And, well, you’re right. There’s no reason to do it. It’s a bad idea. But… It’s plenty fun to try.\nSo in this post we’ll make sure we can write the following example, and then go even further.\nSimple Enums 1 2 3 4 class Colors(ScopedEnum): Red Green Blue This is our first goal. We want to make sure that Colors.Red would be 0, Colors.Green is 1, and Colors.Blue is 2.\nThis might look like an impasse, if we try to access Red before defining it, we get a NameError exception. But Python is a very versatile language, and while it does its best to make well-behaved code act reasonably, it also allows for some very fun behaviour when you abuse its mechanisms.\nAmong those fun-to-abuse mechanisms, we have metaclasses. By implementing the __prepare__ method in our metaclass (read about it in the Python docs and on Brett Cannon’s blog), we can specify the namespace object to use when constructing the actual class (instead of the default dict). This means that during class construction, every name lookup will go through our object.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 class Namespace(dict): def __init__(self): super().__init__() self.last_value = -1 def __getitem__(self, name): # Ignore some special names Python uses and we don't care about if name.startswith(\"__\") and name.endswith(\"__\"): return super().__getitem__(name) self.last_value += 1 self[name] = self.last_value return class ScopedEnumMeta(type): @classmethod def __prepare__(metacls, name, bases): return Namespace() class ScopedEnum(metaclass=ScopedEnumMeta): pass By creating our own implementation of __getitem__, we can define any new variable we encounter. Thus avoiding the NameError, and defining all the members we wanted.\nAssigning Literals The next step would be allowing a bit more control for the programmer. You see, some C++ programmers want to set explicit values in their enumerations:\n1 2 3 4 5 enum class Numbers { One = 1, Five = 5, Six }; And if C++ can do it, so should Python:\n1 2 3 4 class Numbers(ScopedEnum): One = 1 Five = 5 Six To do this, we need to extend our Namespace implementation. You see, if we run it now, we get:\n1 2 \u003e\u003e\u003e print(Numbers.One, Numbers.Five, Numbers.Six) 1 5 0 That’s because we forgot to update our last_value member on assignment. To do that, we’ll add some code into __setitem__ as well:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 class Namespace(dict): def __init__(self): super().__init__() self.last_value = -1 def __getitem__(self, name): if name.startswith(\"__\") and name.endswith(\"__\"): return super().__getitem__(name) self.last_value += 1 self[name] = self.last_value return def __setitem__(self, name, value): # Ignore special names if name.startswith(\"__\") and name.endswith(\"__\"): return super().__setitem__(name, value) self.last_value = value return super().__setitem__(name, value) Assigning Constants The next natural step in our progression is to allow assigning various constants into our enumeration. This includes global values, as well as members previously defined in the same enum.\n1 2 3 4 5 enum class Error { MyError, MyOtherError, SomeOsError = SOME_OS_ERROR } Or in Python:\n1 2 3 4 class Error(ScopedEnum): MyError MyOtherError SomeOsError = SOME_OS_ERROR If we try to print the values now, we get a weird result:\n1 2 \u003e\u003e\u003e print(Error.MyError, Error.MyOtherError, Error.SomeOsError, Error.SOME_OS_ERROR) 0 1 None 2 There are two problems here. Let’s understand them together, and see what they mean for our next steps.\nFor one thing, SomeOsError is None instead of the value of SOME_OS_ERROR. For another, we have SOME_OS_ERROR as a member variable! How did that happen?\nIf we look at our enum class definition, we can classify name usages as reads and writes:\n1 2 3 4 5 class Error(ScopedEnum): MyError # read MyOtherError # read # write read SomeOsError = SOME_OS_ERROR For every read, we call __getitem__, and for every __write__ we call __setitem__. So, step by step:\nWe try to read MyError, calling __getitem__ and defining it We do the same for MyOtherError We call __getitem__ with \"SOME_OS_ERROR\", defining the member We assign None (the value we return from __getitem__) into SomeOsError. With that, we know what went wrong. But fixing it is going to be a bit tricky.\nDetecting Member Definitions So far, we treated every read, or __getitem__ call, as a member definition. As soon as we allow assigning from existing variables, however, this falls apart. We need to find a new logic to it, a way to differentiate the places where a read means a new member, from where a read just means “this is the right-hand-side of an assignment”.\nLet’s consider some representative cases:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 X = ... class E1(ScopedEnum): A class E2(ScopedEnum): A B = A class E3(ScopedEnum): A = X class E4(ScopedEnum): A B = X + A E1 A is read once, and is a member definition E2 A is read twice; once in a definition and once in an assignment B is assigned to E3 A is assigned to X is read once, in an assignment E4 A is read twice; once in a definition and once in an assignment B is assigned to X is read once, in an assignment From this, we can deduce some rules. The first is straightforward - if a name is assigned to, we need to create that variable. The second is trickier. We need to count the number of times a variable is read, and the number of times it is used in an assignment. If the number of reads is larger than the number of usages in assignments, we need to define it.\nThis means that we need to go line-by-line, counting, before we know what names we actually define. This will require post-processing, which we’ll get to later. But first, we must learn to count!\nCounting Names Essentially, there are two different types of name-reads in our enums. One defines a new member, and one is used in an assignment:\n1 2 3 class E(ScopedEnum): A # A is read, defines a new member B = A # A is read, used in an assignment into B To correctly define members, we need to tell those cases apart. While it’s easy to see the difference, the mechanics of code evaluation make it a bit tricker. For reads, regardless of their being a member-definition or a use-in-assignment, we get a call to __getitem__. For every assignment, regardless of it’s inputs, we get a call to __setitem__.\nTo properly visualize this, we can write a “logging namespace”:\n1 2 3 4 5 6 7 8 9 10 11 12 13 class LoggingNamespace(dict): def __getitem__(self, name): if name.startswith(\"__\") and name.endswith(\"__\"): return super().__getitem__(name) print(f\"__getitem__({name!r})\") def __setitem__(self, name, value): # Ignore special names if name.startswith(\"__\") and name.endswith(\"__\"): return super().__setitem__(name, value) print(f\"__setitem__({name!r}, {value!r})\") And get the following result:\n1 2 3 __getitem__(\"A\") __getitem__(\"A\") __setitem__(\"B\", None) As we can see - the __setitem__ calls only give us the name of the target variable. We may be tempted to say this is enough, but consider the following code:\n1 2 3 A = 1 class E1(ScopedEnum): B = A + A This is a valid enum definition, and it gives the exact same get-set sequence. We need more information.\nThe missing piece, as visible in the output, is the variable inputs into assignments. We need to have the names of all the variables used in an assignment visible to us when we call __setitem__.\nPlaceholders The value passed into __setitem__ is going to be controlled by:\nThe values we return from __getitem__ calls in out namespace The literals used in the assignments The operations used to combine the above. And constrained by the need to produce the correct result, and not just a list of names.\nAmong those 3 inputs (__getitem__ results, literals, operations) we have full control over __getitem__ results. With that, we need to somehow preserve both the names provided and the values calculated. We’re going to do this by cheating.\nWe’re going to change our __getitem__ to return a special object - a placeholder object - that holds the name of the variable we read. We don’t need (and actually can’t) return the “true” value of the named variable, as that requires telling definitions and assignments apart. In addition to holding the name, our placeholder objects will also implement all the operators we want to allow in our enum definitions. Once more - we can’t calculate actual values. Instead, we’ll construct a tree of operations.\nA simplistic implementation of a placeholder, allowing only addition, will look something like this:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 import operator from typing import Any from dataclasses import dataclass @dataclass class Placeholder: names: list[str] lhs: Any op: Any rhs: Any def __add__(self, other): names = self.names[:] if isinstance(other, Placeholder): names += other.names return Placeholder(names, self, operator.add, other) def __radd__(self, other): names = self.names if isinstance(other, Placeholder): names = other.names[:] + names return Placeholder(names, other, operator.add, self) Note that we are maintaining a list of names, as we want to be able to count occurrences. Additionally, be mindful of the reverse order in __add__ and __radd__, as it is critical for calculating the correct values later.\nLiterals will always appear in an operation, so always within .lhs or .rhs. Named variables, however, need a “trick”. So we’ll represent them by assigning the name to the .lhs, and None as the operator.\nWith the placeholder mechanism in place, we can now tell which reads go to define new members, and which are assignment uses. This allows us to translate any sequence of calls to __getitem__ followed by a call to __setitem__ (or not, if we reached the end of the enum definition) into a sequence of member definitions and assignments.\nPost Processing A part that I only alluded to before, is that we’re about to have a post-processing step. Due to the way we differentiate member definitions from assignments, we cannot define our members “as-we-go”. Instead, our __getitem__ and __setitem__ implementations only collect information, without creating any new variables. When the class definition is done, our ScopedEnumMeta.__new__ method will be called, and we’ll get our namespace object as an input. At that point, we’ll be able to convert the information we collected into a proper enum.\n1 2 3 4 5 6 7 8 class ScopedEnumMeta(type): @classmethod def __prepare__(metacls, name, bases): return Namespace() def __new__(cls, name, bases, namespace): classdict = populate_enum(namespace.member_info) return type.__new__(cls, name, bases, classdict) Calculating Values There are 2 types of members we need to handle. The first type is member definitions. They will work just as they did before - take the last assigned value, and increment it by one.\n1 2 3 4 5 6 7 8 9 def populate_enum(member_info): last_value = -1 members = {} for member in member_info: if isinstance(member, Definition) last_value += 1 members[member.name] = last_value continue The second type - assignments - are a bit more involved. An assignment can either be a regular value (if only literals were used), or it can be a Placeholder. If it is a placeholder, we need to traverse our tree of operations, and calculate a value:\n1 2 3 4 5 6 7 8 def calculate(value): if not isinstance(value, Placeholder): return value return value.op( calculate(value.lhs), calculate(value.rhs), ) But we’re missing a piece - recall that the operation for named variables is None, and the stored value is a name, not an actual value. To get those, we need to do an extra step, and perform a lookup:\n1 2 3 4 5 6 7 8 9 10 11 def calculate(value, namespace): if not isinstance(value, Placeholder): return value if value.op is None: return namespace[value.names[0]] return value.op( calculate(value.lhs, namespace), calculate(value.rhs, namespace), ) As for getting the namespace - we’ll have to use the inspect module and peek at our parent stack-frames. But I won’t get into this here.\nAnd with this, we’re done.\nRead the full implementation here.\nParting Words Python is a wonderful language. It allows us to ask whether we can, without worrying about whether we should. In this post, I shared the implementation details and some of the thought process of implementing C++ Scoped Enums in Python. I hope you found this entertaining, and maybe learned a thing or two. And I sincerely hope you’ll never use this in any production code.\n","wordCount":"2383","inLanguage":"en","datePublished":"2023-04-24T00:00:00Z","dateModified":"2023-04-24T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://tamir.dev/posts/snake-eyes-cpp-scoped-enums/"},"publisher":{"@type":"Organization","name":"Tamir Bahar","logo":{"@type":"ImageObject","url":"https://tamir.dev/images/profilepic.jpg"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tamir.dev/ accesskey=h title="Tamir Bahar (Alt + H)">Tamir Bahar</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://tamir.dev/blogvent/ title=blogvent🎄><span>blogvent🎄</span></a></li><li><a href=https://tamir.dev/posts/ title=posts><span>posts</span></a></li><li><a href=https://tamir.dev/archives/ title=archives><span>archives</span></a></li><li><a href=https://tamir.dev/index.xml title=rss><span>rss</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" height="13"><g transform="scale(1)"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></g></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://tamir.dev/>Home</a>&nbsp;»&nbsp;<a href=https://tamir.dev/posts/>Posts</a></div><h1 class=post-title>Snake Eyes: C++ Scoped enums</h1><div class=post-description>Implementing C++ Scoped Enums in Python</div><div class=post-meta><span title='2023-04-24 00:00:00 +0000 UTC'>Apr 24, 2023</span></div></header><div class=post-content><p>Often, we write code to complete a task.
Other times, we write code to learn something new.
But there are also those rare occasions where our goals are simpler.
When we have a dumb idea stuck in our head, and the only way to get it out is to code it.
Or when we just want to see, to prove to ourselves, that we can write a certain piece of code.</p><p>This post is about one of those wonderful occasions.
Specifically - I had to see whether I can implement <a href=https://en.cppreference.com/w/cpp/language/enum#Scoped_enumerations>C++ Scoped Enumerations</a> in Python.
And, since you&rsquo;re reading this post, it&rsquo;s fair to assume that I succeeded.</p><h2 id=c-scoped-enumerations><a href=#c-scoped-enumerations>C++ Scoped Enumerations<span hidden class=anchor aria-hidden=true href=#c-scoped-enumerations>#</span></a></h2><p>If you&rsquo;re not a C++ programmer (good for you!) you may be wondering - what are scoped enumerations?</p><p>Well, first and foremost - they are enumerations.
A nice syntactic sugar to define a group of named, constant integer values.
They look like this:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Colors</span> {
</span></span><span style=display:flex><span>	Red,
</span></span><span style=display:flex><span>	Green,
</span></span><span style=display:flex><span>	Blue
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div><p>(Here <code>Colors::Red</code> is <code>0</code>, <code>Colors::Green</code> is <code>1</code>, and <code>Colors::Blue</code> is <code>2</code>.)</p><p>Secondly, they are <em>scoped</em>.
This might seem obvious to anyone not coming from C (or older C++),
but this means that the names only exist under the enumeration that defines them.
You can write <code>Colors::Red</code> to get the <code>Red</code> value, but just writing <code>Red</code> somewhere won&rsquo;t get it.
Yes, this seems obvious, but it wasn&rsquo;t the case until C++11.</p><p>That&rsquo;s about it.</p><p>Of course, we can talk about the fact that they are a form of a strong typdef, and disallow implicit conversions, and more&mldr;
But we&rsquo;re to <del>bury</del> implement enums not to praise them.</p><h2 id=scoped-enums-in-python><a href=#scoped-enums-in-python>Scoped Enums in Python<span hidden class=anchor aria-hidden=true href=#scoped-enums-in-python>#</span></a></h2><p>Why implement this in Python, you might ask.
After all, we have <code>enum.Enum</code>, and that&rsquo;s plenty good:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Colors</span>(Enum):
</span></span><span style=display:flex><span>	Red <span style=color:#f92672>=</span> auto()
</span></span><span style=display:flex><span>	Green <span style=color:#f92672>=</span> auto()
</span></span><span style=display:flex><span>	Blue <span style=color:#f92672>=</span> auto()
</span></span></code></pre></td></tr></table></div></div><p>And, well, you&rsquo;re right.
There&rsquo;s no reason to do it.
It&rsquo;s a bad idea.
But&mldr; It&rsquo;s plenty fun to try.</p><p>So in this post we&rsquo;ll make sure we can write the following example, and then go even further.</p><h2 id=simple-enums><a href=#simple-enums>Simple Enums<span hidden class=anchor aria-hidden=true href=#simple-enums>#</span></a></h2><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Colors</span>(ScopedEnum):
</span></span><span style=display:flex><span>	Red
</span></span><span style=display:flex><span>	Green
</span></span><span style=display:flex><span>	Blue
</span></span></code></pre></td></tr></table></div></div><p>This is our first goal.
We want to make sure that <code>Colors.Red</code> would be <code>0</code>, <code>Colors.Green</code> is <code>1</code>, and <code>Colors.Blue</code> is <code>2</code>.</p><p>This might look like an impasse, if we try to access <code>Red</code> before defining it, we get a <code>NameError</code> exception.
But Python is a very versatile language, and while it does its best to make well-behaved code act reasonably, it also allows for some very fun behaviour when you abuse its mechanisms.</p><p>Among those fun-to-abuse mechanisms, we have <a href=https://docs.python.org/3/reference/datamodel.html#metaclasses>metaclasses</a>.
By implementing the <code>__prepare__</code> method in our metaclass (read about it in the <a href=https://docs.python.org/3/reference/datamodel.html#preparing-the-class-namespace>Python docs</a> and on <a href=https://docs.python.org/3/reference/datamodel.html#preparing-the-class-namespace>Brett Cannon&rsquo;s blog</a>), we can specify the namespace object to use when constructing the actual class (instead of the default <code>dict</code>).
This means that during class construction, every name lookup will go through our object.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Namespace</span>(dict):
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>		super()<span style=color:#f92672>.</span>__init__()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		self<span style=color:#f92672>.</span>last_value <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>def</span> __getitem__(self, name):
</span></span><span style=display:flex><span>		<span style=color:#75715e># Ignore some special names Python uses and we don&#39;t care about</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> name<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#34;__&#34;</span>) <span style=color:#f92672>and</span> name<span style=color:#f92672>.</span>endswith(<span style=color:#e6db74>&#34;__&#34;</span>):  
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>__getitem__(name)
</span></span><span style=display:flex><span>			
</span></span><span style=display:flex><span>		self<span style=color:#f92672>.</span>last_value <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>		self[name] <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>last_value
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ScopedEnumMeta</span>(type):
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@classmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __prepare__(metacls, name, bases):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Namespace()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ScopedEnum</span>(metaclass<span style=color:#f92672>=</span>ScopedEnumMeta):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span></code></pre></td></tr></table></div></div><p>By creating our own implementation of <code>__getitem__</code>, we can define any new variable we encounter.
Thus avoiding the <code>NameError</code>, and defining all the members we wanted.</p><h2 id=assigning-literals><a href=#assigning-literals>Assigning Literals<span hidden class=anchor aria-hidden=true href=#assigning-literals>#</span></a></h2><p>The next step would be allowing a bit more control for the programmer.
You see, some C++ programmers want to set explicit values in their enumerations:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Numbers</span> {
</span></span><span style=display:flex><span>	One <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>	Five <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>	Six
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div><p>And if C++ can do it, so should Python:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Numbers</span>(ScopedEnum):
</span></span><span style=display:flex><span>	One <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	Five <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>	Six
</span></span></code></pre></td></tr></table></div></div><p>To do this, we need to extend our <code>Namespace</code> implementation.
You see, if we run it now, we get:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> print(Numbers<span style=color:#f92672>.</span>One, Numbers<span style=color:#f92672>.</span>Five, Numbers<span style=color:#f92672>.</span>Six)
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>0</span>
</span></span></code></pre></td></tr></table></div></div><p>That&rsquo;s because we forgot to update our <code>last_value</code> member on assignment.
To do that, we&rsquo;ll add some code into <code>__setitem__</code> as well:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Namespace</span>(dict):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        super()<span style=color:#f92672>.</span>__init__()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>last_value <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __getitem__(self, name):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> name<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#34;__&#34;</span>) <span style=color:#f92672>and</span> name<span style=color:#f92672>.</span>endswith(<span style=color:#e6db74>&#34;__&#34;</span>):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>__getitem__(name)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>last_value <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        self[name] <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>last_value
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __setitem__(self, name, value):
</span></span><span style=display:flex><span>	    <span style=color:#75715e># Ignore special names</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> name<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#34;__&#34;</span>) <span style=color:#f92672>and</span> name<span style=color:#f92672>.</span>endswith(<span style=color:#e6db74>&#34;__&#34;</span>):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>__setitem__(name, value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>last_value <span style=color:#f92672>=</span> value
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>__setitem__(name, value)
</span></span></code></pre></td></tr></table></div></div><h2 id=assigning-constants><a href=#assigning-constants>Assigning Constants<span hidden class=anchor aria-hidden=true href=#assigning-constants>#</span></a></h2><p>The next natural step in our progression is to allow assigning various constants into our enumeration.
This includes global values, as well as members previously defined in the same enum.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Error</span> {
</span></span><span style=display:flex><span>	MyError,
</span></span><span style=display:flex><span>	MyOtherError,
</span></span><span style=display:flex><span>	SomeOsError <span style=color:#f92672>=</span> SOME_OS_ERROR
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Or in Python:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Error</span>(ScopedEnum):
</span></span><span style=display:flex><span>	MyError
</span></span><span style=display:flex><span>	MyOtherError
</span></span><span style=display:flex><span>	SomeOsError <span style=color:#f92672>=</span> SOME_OS_ERROR
</span></span></code></pre></td></tr></table></div></div><p>If we try to print the values now, we get a weird result:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> print(Error<span style=color:#f92672>.</span>MyError, Error<span style=color:#f92672>.</span>MyOtherError, Error<span style=color:#f92672>.</span>SomeOsError, Error<span style=color:#f92672>.</span>SOME_OS_ERROR)
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>None</span> <span style=color:#ae81ff>2</span>
</span></span></code></pre></td></tr></table></div></div><p>There are two problems here.
Let&rsquo;s understand them together, and see what they mean for our next steps.</p><p>For one thing, <code>SomeOsError</code> is <code>None</code> instead of the value of <code>SOME_OS_ERROR</code>.
For another, we have <code>SOME_OS_ERROR</code> as a member variable!
How did that happen?</p><p>If we look at our enum class definition, we can classify name usages as reads and writes:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Error</span>(ScopedEnum):
</span></span><span style=display:flex><span>	MyError <span style=color:#75715e># read</span>
</span></span><span style=display:flex><span>	MyOtherError <span style=color:#75715e># read</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># write         read</span>
</span></span><span style=display:flex><span>	SomeOsError <span style=color:#f92672>=</span> SOME_OS_ERROR
</span></span></code></pre></td></tr></table></div></div><p>For every read, we call <code>__getitem__</code>, and for every <code>__write__</code> we call <code>__setitem__</code>.
So, step by step:</p><ol><li>We try to read <code>MyError</code>, calling <code>__getitem__</code> and defining it</li><li>We do the same for <code>MyOtherError</code></li><li>We call <code>__getitem__</code> with <code>"SOME_OS_ERROR"</code>, defining the member</li><li>We assign <code>None</code> (the value we return from <code>__getitem__</code>) into <code>SomeOsError</code>.</li></ol><p>With that, we know what went wrong.
But fixing it is going to be a bit tricky.</p><h2 id=detecting-member-definitions><a href=#detecting-member-definitions>Detecting Member Definitions<span hidden class=anchor aria-hidden=true href=#detecting-member-definitions>#</span></a></h2><p>So far, we treated every read, or <code>__getitem__</code> call, as a member definition.
As soon as we allow assigning from existing variables, however, this falls apart.
We need to find a new logic to it, a way to differentiate the places where a read means a new member,
from where a read just means &ldquo;this is the right-hand-side of an assignment&rdquo;.</p><p>Let&rsquo;s consider some representative cases:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>X <span style=color:#f92672>=</span> <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>E1</span>(ScopedEnum):
</span></span><span style=display:flex><span>	A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>E2</span>(ScopedEnum):
</span></span><span style=display:flex><span>	A
</span></span><span style=display:flex><span>	B <span style=color:#f92672>=</span> A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>E3</span>(ScopedEnum):
</span></span><span style=display:flex><span>	A <span style=color:#f92672>=</span> X
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>E4</span>(ScopedEnum):
</span></span><span style=display:flex><span>	A
</span></span><span style=display:flex><span>	B <span style=color:#f92672>=</span> X <span style=color:#f92672>+</span> A
</span></span></code></pre></td></tr></table></div></div><ul><li><code>E1</code><ul><li><code>A</code> is read once, and is a member definition</li></ul></li><li>E2<ul><li><code>A</code> is read twice; once in a definition and once in an assignment</li><li><code>B</code> is assigned to</li></ul></li><li>E3<ul><li><code>A</code> is assigned to</li><li><code>X</code> is read once, in an assignment</li></ul></li><li>E4<ul><li><code>A</code> is read twice; once in a definition and once in an assignment</li><li><code>B</code> is assigned to</li><li><code>X</code> is read once, in an assignment</li></ul></li></ul><p>From this, we can deduce some rules.
The first is straightforward - if a name is assigned to, we need to create that variable.
The second is trickier.
We need to count the number of times a variable is read, and the number of times it is used in an assignment.
If the number of reads is <em>larger</em> than the number of usages in assignments, we need to define it.</p><p>This means that we need to go line-by-line, counting, before we know what names we actually define.
This will require post-processing, which we&rsquo;ll get to later.
But first, we must learn to count!</p><h2 id=counting-names><a href=#counting-names>Counting Names<span hidden class=anchor aria-hidden=true href=#counting-names>#</span></a></h2><p>Essentially, there are two different types of name-reads in our enums.
One defines a new member, and one is used in an assignment:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>E</span>(ScopedEnum):
</span></span><span style=display:flex><span>	A      <span style=color:#75715e># A is read, defines a new member</span>
</span></span><span style=display:flex><span>	B <span style=color:#f92672>=</span> A  <span style=color:#75715e># A is read, used in an assignment into B</span>
</span></span></code></pre></td></tr></table></div></div><p>To correctly define members, we need to tell those cases apart.
While it&rsquo;s easy to <em>see</em> the difference, the mechanics of code evaluation make it a bit tricker.
For reads, regardless of their being a member-definition or a use-in-assignment, we get a call to <code>__getitem__</code>.
For every assignment, regardless of it&rsquo;s inputs, we get a call to <code>__setitem__</code>.</p><p>To properly visualize this, we can write a &ldquo;logging namespace&rdquo;:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LoggingNamespace</span>(dict):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __getitem__(self, name):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> name<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#34;__&#34;</span>) <span style=color:#f92672>and</span> name<span style=color:#f92672>.</span>endswith(<span style=color:#e6db74>&#34;__&#34;</span>):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>__getitem__(name)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>		print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;__getitem__(</span><span style=color:#e6db74>{</span>name<span style=color:#e6db74>!r}</span><span style=color:#e6db74>)&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __setitem__(self, name, value):
</span></span><span style=display:flex><span>	    <span style=color:#75715e># Ignore special names</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> name<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#34;__&#34;</span>) <span style=color:#f92672>and</span> name<span style=color:#f92672>.</span>endswith(<span style=color:#e6db74>&#34;__&#34;</span>):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>__setitem__(name, value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;__setitem__(</span><span style=color:#e6db74>{</span>name<span style=color:#e6db74>!r}</span><span style=color:#e6db74>, </span><span style=color:#e6db74>{</span>value<span style=color:#e6db74>!r}</span><span style=color:#e6db74>)&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><p>And get the following result:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>__getitem__(<span style=color:#e6db74>&#34;A&#34;</span>)
</span></span><span style=display:flex><span>__getitem__(<span style=color:#e6db74>&#34;A&#34;</span>)
</span></span><span style=display:flex><span>__setitem__(<span style=color:#e6db74>&#34;B&#34;</span>, <span style=color:#66d9ef>None</span>)
</span></span></code></pre></td></tr></table></div></div><p>As we can see - the <code>__setitem__</code> calls only give us the name of the <em>target</em> variable.
We may be tempted to say this is enough, but consider the following code:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>A <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>E1</span>(ScopedEnum):
</span></span><span style=display:flex><span>	B <span style=color:#f92672>=</span> A <span style=color:#f92672>+</span> A
</span></span></code></pre></td></tr></table></div></div><p>This is a valid enum definition, and it gives the exact same get-set sequence.
We need more information.</p><p>The missing piece, as visible in the output, is the variable inputs into assignments.
We need to have the names of all the variables used in an assignment visible to us when we call <code>__setitem__</code>.</p><h3 id=placeholders><a href=#placeholders>Placeholders<span hidden class=anchor aria-hidden=true href=#placeholders>#</span></a></h3><p>The value passed into <code>__setitem__</code> is going to be controlled by:</p><ol><li>The values we return from <code>__getitem__</code> calls in out namespace</li><li>The literals used in the assignments</li><li>The operations used to combine the above.</li></ol><p>And constrained by the need to produce the correct result, and not just a list of names.</p><p>Among those 3 inputs (<code>__getitem__</code> results, literals, operations) we have full control over <code>__getitem__</code> results.
With that, we need to somehow preserve both the names provided and the values calculated.
We&rsquo;re going to do this by cheating.</p><p>We&rsquo;re going to change our <code>__getitem__</code> to return a special object - a placeholder object - that holds the name of the variable we read.
We don&rsquo;t need (and actually can&rsquo;t) return the &ldquo;true&rdquo; value of the named variable, as that requires telling definitions and assignments apart.
In addition to holding the name, our placeholder objects will also implement <em>all</em> the operators we want to allow in our enum definitions.
Once more - we can&rsquo;t calculate actual values.
Instead, we&rsquo;ll construct a tree of operations.</p><p>A simplistic implementation of a placeholder, allowing only addition, will look something like this:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> operator
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> typing <span style=color:#f92672>import</span> Any
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> dataclasses <span style=color:#f92672>import</span> dataclass
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@dataclass</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Placeholder</span>:
</span></span><span style=display:flex><span>    names: list[str]
</span></span><span style=display:flex><span>    lhs: Any
</span></span><span style=display:flex><span>    op: Any
</span></span><span style=display:flex><span>    rhs: Any
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __add__(self, other):
</span></span><span style=display:flex><span>        names <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>names[:]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> isinstance(other, Placeholder):
</span></span><span style=display:flex><span>            names <span style=color:#f92672>+=</span> other<span style=color:#f92672>.</span>names
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Placeholder(names, self, operator<span style=color:#f92672>.</span>add, other)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __radd__(self, other):
</span></span><span style=display:flex><span>        names <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>names
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> isinstance(other, Placeholder):
</span></span><span style=display:flex><span>            names <span style=color:#f92672>=</span> other<span style=color:#f92672>.</span>names[:] <span style=color:#f92672>+</span> names
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Placeholder(names, other, operator<span style=color:#f92672>.</span>add, self)
</span></span></code></pre></td></tr></table></div></div><p>Note that we are maintaining a <em>list</em> of names, as we want to be able to count occurrences.
Additionally, be mindful of the reverse order in <code>__add__</code> and <code>__radd__</code>, as it is critical for calculating the correct values later.</p><p>Literals will always appear in an operation, so always within <code>.lhs</code> or <code>.rhs</code>.
Named variables, however, need a &ldquo;trick&rdquo;.
So we&rsquo;ll represent them by assigning the name to the <code>.lhs</code>, and <code>None</code> as the operator.</p><p>With the placeholder mechanism in place, we can now tell which reads go to define new members, and which are assignment uses.
This allows us to translate any sequence of calls to <code>__getitem__</code> followed by a call to <code>__setitem__</code> (or not, if we reached the end of the enum definition) into a sequence of member definitions and assignments.</p><h2 id=post-processing><a href=#post-processing>Post Processing<span hidden class=anchor aria-hidden=true href=#post-processing>#</span></a></h2><p>A part that I only alluded to before, is that we&rsquo;re about to have a post-processing step.
Due to the way we differentiate member definitions from assignments, we cannot define our members &ldquo;as-we-go&rdquo;.
Instead, our <code>__getitem__</code> and <code>__setitem__</code> implementations only collect information, without creating any new variables.
When the class definition is done, our <code>ScopedEnumMeta.__new__</code> method will be called, and we&rsquo;ll get our namespace object as an input.
At that point, we&rsquo;ll be able to convert the information we collected into a proper enum.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ScopedEnumMeta</span>(type):
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@classmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __prepare__(metacls, name, bases):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Namespace()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __new__(cls, name, bases, namespace):
</span></span><span style=display:flex><span>		classdict <span style=color:#f92672>=</span> populate_enum(namespace<span style=color:#f92672>.</span>member_info)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> type<span style=color:#f92672>.</span>__new__(cls, name, bases, classdict)
</span></span></code></pre></td></tr></table></div></div><h3 id=calculating-values><a href=#calculating-values>Calculating Values<span hidden class=anchor aria-hidden=true href=#calculating-values>#</span></a></h3><p>There are 2 types of members we need to handle.
The first type is member definitions.
They will work just as they did before - take the last assigned value, and increment it by one.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>populate_enum</span>(member_info):
</span></span><span style=display:flex><span>	last_value <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	members <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> member <span style=color:#f92672>in</span> member_info:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> isinstance(member, Definition)
</span></span><span style=display:flex><span>			last_value <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>			members[member<span style=color:#f92672>.</span>name] <span style=color:#f92672>=</span> last_value
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span></code></pre></td></tr></table></div></div><p>The second type - assignments - are a bit more involved.
An assignment can either be a regular value (if only literals were used), or it can be a <code>Placeholder</code>.
If it is a placeholder, we need to traverse our tree of operations, and calculate a value:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>calculate</span>(value):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> isinstance(value, Placeholder):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> value<span style=color:#f92672>.</span>op(
</span></span><span style=display:flex><span>        calculate(value<span style=color:#f92672>.</span>lhs),
</span></span><span style=display:flex><span>        calculate(value<span style=color:#f92672>.</span>rhs), 
</span></span><span style=display:flex><span>    )
</span></span></code></pre></td></tr></table></div></div><p>But we&rsquo;re missing a piece - recall that the operation for named variables is <code>None</code>, and the stored value is a name, not an actual value.
To get those, we need to do an extra step, and perform a lookup:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>calculate</span>(value, namespace):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> isinstance(value, Placeholder):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> value<span style=color:#f92672>.</span>op <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> namespace[value<span style=color:#f92672>.</span>names[<span style=color:#ae81ff>0</span>]]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> value<span style=color:#f92672>.</span>op(
</span></span><span style=display:flex><span>        calculate(value<span style=color:#f92672>.</span>lhs, namespace),
</span></span><span style=display:flex><span>        calculate(value<span style=color:#f92672>.</span>rhs, namespace), 
</span></span><span style=display:flex><span>    )
</span></span></code></pre></td></tr></table></div></div><p>As for getting the namespace - we&rsquo;ll have to use the <code>inspect</code> module and peek at our parent stack-frames.
But I won&rsquo;t get into this here.</p><p>And with this, we&rsquo;re done.</p><p><a href=https://gist.github.com/tmr232/7e640c9515c6f148d901d0707fd974d5>Read the full implementation here</a>.</p><h2 id=parting-words><a href=#parting-words>Parting Words<span hidden class=anchor aria-hidden=true href=#parting-words>#</span></a></h2><p>Python is a wonderful language.
It allows us to ask whether we can, without worrying about whether we should.
In this post, I shared the implementation details and some of the thought process of implementing C++ Scoped Enums in Python.
I hope you found this entertaining, and maybe learned a thing or two.
And I sincerely hope you&rsquo;ll never use this in any production code.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://tamir.dev/tags/python/>python</a></li><li><a href=https://tamir.dev/tags/c++/>C++</a></li><li><a href=https://tamir.dev/tags/misguided/>misguided</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://tamir.dev/>Tamir Bahar</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>