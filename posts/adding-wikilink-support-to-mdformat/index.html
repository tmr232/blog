<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Adding Wikilink Support To Mdformat | Tamir Bahar</title><meta name=keywords content><meta name=description content="Extending mdformat to not destroy wikilinks."><meta name=author content="Tamir Bahar"><link rel=canonical href=https://tamir.dev/posts/adding-wikilink-support-to-mdformat/><link crossorigin=anonymous href=/assets/css/stylesheet.0b7a6a59f13c612205962144f1a8f43a859c4d814d43709a9e3e2b0e9353224b.css integrity="sha256-C3pqWfE8YSIFliFE8aj0OoWcTYFNQ3Canj4rDpNTIks=" rel="preload stylesheet" as=style><link rel=icon href=https://tamir.dev/images/profilepic.jpg><link rel=icon type=image/png sizes=16x16 href=https://tamir.dev/images/profilepic.jpg><link rel=icon type=image/png sizes=32x32 href=https://tamir.dev/images/profilepic.jpg><link rel=apple-touch-icon href=https://tamir.dev/images/profilepic.jpg><link rel=mask-icon href=https://tamir.dev/images/profilepic.jpg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Adding Wikilink Support To Mdformat"><meta property="og:description" content="Extending mdformat to not destroy wikilinks."><meta property="og:type" content="article"><meta property="og:url" content="https://tamir.dev/posts/adding-wikilink-support-to-mdformat/"><meta property="og:image" content="https://tamir.dev/images/profilepic.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-14T00:00:00+00:00"><meta property="article:modified_time" content="2023-04-14T00:00:00+00:00"><meta property="og:site_name" content="Tamir Bahar"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://tamir.dev/images/profilepic.jpg"><meta name=twitter:title content="Adding Wikilink Support To Mdformat"><meta name=twitter:description content="Extending mdformat to not destroy wikilinks."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://tamir.dev/posts/"},{"@type":"ListItem","position":2,"name":"Adding Wikilink Support To Mdformat","item":"https://tamir.dev/posts/adding-wikilink-support-to-mdformat/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Adding Wikilink Support To Mdformat","name":"Adding Wikilink Support To Mdformat","description":"Extending mdformat to not destroy wikilinks.","keywords":[],"articleBody":"Why? The first question you should ask yourself when seeing this title is ‚Äúwhy?‚Äù. Why would we want to add wikilink1 support to a Markdown formatting library?\nWell, recently I started using Obsidian (a Markdown-based personal wiki). Since my writing is mostly code-related, it includes a lot of code-snippets. As I like having my code neatly formatted, and hate formatting it by hand, I wanted a tool to do that for me. The best tool I found was mdformat. It‚Äôs Python based, formats Python, Rust, and Go code snippets, and even formats the Markdown itself.\nThe only problem being: it formats a lovely wiki [[link]] as \\[\\[link\\]\\], breaking it in the process. To mitigate that, I had to add wikilink support2.\nIf you just want to see the code, go to mdformat-wikilink.\nMdformat Plugins mdformat is a markdown formatting tool written in Python. It is based on the wonderful markdown-it-py library, and has plugin support.\nThere are 2 types of mdformat plugins:\nCode formatter plugins, used for formatting the code inside fenced blocks; Parser extension plugins, used to add support for new nodes. Since we‚Äôre adding support for a new type of syntax, a wikilink, we‚Äôll be writing a parser extension plugin. To do so, we‚Äôll follow the mdformat guide for developing plugins.\nThat said, our mdformat plugin will only do the rendering. For parsing, we need to write a markdown-it-py plugin.\nMarkdown-it-py Plugins Luckily for us, markdown-it-py has very good support for plugins as well. Documentation includes design principles (which make for a good architecture overview), API documentation, and existing plugins. You can also check the markdown-it live demo (using the Javascript library that was later ported to Python) to interactively see a token stream.\nActual Code After a bit of reading, experimenting, and finding out - it seems that we only need very little code to make things work. We can do something more complex, but for our needs (ensuring mdformat doesn‚Äôt modify wikilinks) we can hack something quick. We‚Äôre going to create a new parser token for wikilinks, and make mdformat render it as-is.\nThe code will consist of 3 parts:\nmarkdown-it-py plugin, to parse the wikilinks as a new token mdformat plugin, to use the previous plugin, and render the new token as-is A bit of pyproject.toml config to make mdformat recognize the plugin. Parsing Wikilinks Since we‚Äôre only parsing wikilinks to keep them unmodified, we‚Äôre not going to break them up into parts. Instead, we‚Äôll just keep them as a block of text. This means that we can write a simplistic parser that does the following:\nUsing regex, we check whether the string currently fed to the parser is a link If it isn‚Äôt, we do nothing and report that it isn‚Äôt. If it is, we push a wikilink token with the entire link as its content, and increment the parser position part the link. The last (and most important) part of the code is registering the parser we just wrote. We register it as an ‚Äúinline‚Äù rule (as it is an inline element, not a block), and we register it last, as it doesn‚Äôt replace any other elements (well, plain text‚Ä¶).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 import re from markdown_it import MarkdownIt from markdown_it.rules_inline import StateInline LINK_PATTERN = re.compile(r\"\\[\\[([^[|\\]\\n])+(\\|[^]\\n]+)?]]\") def _wikilink_inline(state: StateInline, silent: bool) -\u003e bool: match = LINK_PATTERN.match(state.src[state.pos :]) if not match: # Not a wikilink! return False # Push the wikilink token token = state.push(\"wikilink\", \"\", 0) token.content = match.group() # Increment parser location state.pos += match.end() # Found a wikilink! return True def wikilink_plugin(md: MarkdownIt) -\u003e None: # Register the parser! md.inline.ruler.push(\"wikilink\", _wikilink_inline) Formatting Wikilinks Our mdformat plugin is even more simplistic.\nThe update_mdit function is used to load our wikilink-parsing plugin into the current instance of markdown-it-py The _render_wikilink function returns the content of the wikilink token (or node, in mdformat terminology) that we pushed That‚Äôs it.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 from collections.abc import Mapping from markdown_it import MarkdownIt from mdformat.renderer import RenderContext, RenderTreeNode from mdformat.renderer.typing import Render from mdformat_wikilink.mdit_wikilink_plugin import wikilink_plugin def update_mdit(mdit: MarkdownIt) -\u003e None: # Load the markdown-it wikilink plugin to parse wikilinks mdit.use(wikilink_plugin) def _render_wikilink(node: RenderTreeNode, context: RenderContext) -\u003e str: # Render as-is. return node.content # Register the render function RENDERERS: Mapping[str, Render] = {\"wikilink\": _render_wikilink} A Tiny Bit of Config The last thing we need to do is register the right entry-point for our plugin, so that mdformat will know to load and use it. We can do it in our pyproject.toml file (I‚Äôm using Poetry, other tools have similar options).\n1 2 [tool.poetry.plugins.\"mdformat.parser_extension\"] \"wikilink\" = \"mdformat_wikilink.mdformat_plugin\" And with that, we‚Äôre done.\nYou can see the whole project at mdformat-wikilink.\nWikilinks the link markup you see in wikis like Wikipedia. They are of the form [[Target]] or [[Target|Alias]], and generally create links inside the wiki.¬†‚Ü©Ô∏é\nAnd a blog post documenting it, for future reference. Which you are now reading.¬†‚Ü©Ô∏é\n","wordCount":"852","inLanguage":"en","datePublished":"2023-04-14T00:00:00Z","dateModified":"2023-04-14T00:00:00Z","author":{"@type":"Person","name":"Tamir Bahar"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://tamir.dev/posts/adding-wikilink-support-to-mdformat/"},"publisher":{"@type":"Organization","name":"Tamir Bahar","logo":{"@type":"ImageObject","url":"https://tamir.dev/images/profilepic.jpg"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tamir.dev/ accesskey=h title="Tamir Bahar (Alt + H)">Tamir Bahar</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://tamir.dev/blogvent/ title=blogventüéÑ><span>blogventüéÑ</span></a></li><li><a href=https://tamir.dev/posts/ title=posts><span>posts</span></a></li><li><a href=https://tamir.dev/archives/ title=archives><span>archives</span></a></li><li><a href=https://tamir.dev/index.xml title=rss><span>rss</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" height="13"><g transform="scale(1)"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></g></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://tamir.dev/>Home</a>&nbsp;¬ª&nbsp;<a href=https://tamir.dev/posts/>Posts</a></div><h1 class=post-title>Adding Wikilink Support To Mdformat</h1><div class=post-description>Extending mdformat to not destroy wikilinks.</div><div class=post-meta><span title='2023-04-14 00:00:00 +0000 UTC'>Apr 14, 2023</span>&nbsp;¬∑&nbsp;Tamir Bahar</div></header><div class=post-content><h2 id=why><a href=#why>Why?<span hidden class=anchor aria-hidden=true href=#why>#</span></a></h2><p>The first question you should ask yourself when seeing this title is &ldquo;why?&rdquo;.
Why would we want to add wikilink<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> support to a <a href=https://mdformat.readthedocs.io/en/stable/>Markdown formatting library</a>?</p><p>Well, recently I started using <a href=https://obsidian.md/>Obsidian</a> (a Markdown-based personal wiki).
Since my writing is mostly code-related, it includes a lot of code-snippets.
As I like having my code neatly formatted, and hate formatting it by hand, I wanted a tool to do that for me.
The best tool I found was <a href=https://mdformat.readthedocs.io/en/stable/>mdformat</a>.
It&rsquo;s Python based, formats Python, Rust, and Go code snippets, and even formats the Markdown itself.</p><p>The only problem being: it formats a lovely wiki <code>[[link]]</code> as <code>\[\[link\]\]</code>, breaking it in the process.
To mitigate that, I had to add wikilink support<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>.</p><p>If you just want to see the code, go to <a href=https://github.com/tmr232/mdformat-wikilink>mdformat-wikilink</a>.</p><h2 id=mdformat-plugins><a href=#mdformat-plugins>Mdformat Plugins<span hidden class=anchor aria-hidden=true href=#mdformat-plugins>#</span></a></h2><p><a href=https://mdformat.readthedocs.io/en/stable/>mdformat</a> is a markdown formatting tool written in Python.
It is based on the wonderful <a href=https://github.com/executablebooks/markdown-it-py>markdown-it-py</a> library, and has plugin support.</p><p>There are 2 types of <a href=https://mdformat.readthedocs.io/en/stable/users/plugins.html>mdformat plugins</a>:</p><ol><li>Code formatter plugins, used for formatting the code inside fenced blocks;</li><li>Parser extension plugins, used to add support for new nodes.</li></ol><p>Since we&rsquo;re adding support for a new type of syntax, a wikilink, we&rsquo;ll be writing a parser extension plugin.
To do so, we&rsquo;ll follow the <a href=https://mdformat.readthedocs.io/en/stable/contributors/contributing.html>mdformat guide for developing plugins</a>.</p><p>That said, our mdformat plugin will only do the rendering.
For parsing, we need to write a markdown-it-py plugin.</p><h2 id=markdown-it-py-plugins><a href=#markdown-it-py-plugins>Markdown-it-py Plugins<span hidden class=anchor aria-hidden=true href=#markdown-it-py-plugins>#</span></a></h2><p>Luckily for us, <a href=https://github.com/executablebooks/markdown-it-py>markdown-it-py</a> has very good support for plugins as well.
Documentation includes <a href=https://markdown-it-py.readthedocs.io/en/latest/architecture.html>design principles</a> (which make for a good architecture overview), <a href=https://markdown-it-py.readthedocs.io/en/latest/api/markdown_it.html>API documentation</a>, and <a href=https://mdit-py-plugins.readthedocs.io/en/latest/>existing plugins</a>.
You can also check the <a href=https://markdown-it.github.io/>markdown-it live demo</a> (using the Javascript library that was later ported to Python) to interactively see a token stream.</p><h2 id=actual-code><a href=#actual-code>Actual Code<span hidden class=anchor aria-hidden=true href=#actual-code>#</span></a></h2><p>After a bit of reading, experimenting, and finding out - it seems that we only need very little code to make things work.
We can do something more complex, but for our needs (ensuring mdformat doesn&rsquo;t modify wikilinks) we can hack something quick.
We&rsquo;re going to create a new parser token for wikilinks, and make mdformat render it as-is.</p><p>The code will consist of 3 parts:</p><ol><li>markdown-it-py plugin, to parse the wikilinks as a new token</li><li>mdformat plugin, to use the previous plugin, and render the new token as-is</li><li>A bit of <code>pyproject.toml</code> config to make <code>mdformat</code> recognize the plugin.</li></ol><h3 id=parsing-wikilinks><a href=#parsing-wikilinks>Parsing Wikilinks<span hidden class=anchor aria-hidden=true href=#parsing-wikilinks>#</span></a></h3><p>Since we&rsquo;re only parsing wikilinks to keep them unmodified, we&rsquo;re not going to break them up into parts.
Instead, we&rsquo;ll just keep them as a block of text.
This means that we can write a simplistic parser that does the following:</p><ol><li>Using regex, we check whether the string currently fed to the parser is a link</li><li>If it isn&rsquo;t, we do nothing and report that it isn&rsquo;t.</li><li>If it is, we push a <code>wikilink</code> token with the entire link as its content, and increment the parser position part the link.</li></ol><p>The last (and most important) part of the code is registering the parser we just wrote.
We register it as an &ldquo;inline&rdquo; rule (as it is an inline element, not a block), and we register it last, as it doesn&rsquo;t replace any other elements (well, plain text&mldr;).</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> re
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> markdown_it <span style=color:#f92672>import</span> MarkdownIt
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> markdown_it.rules_inline <span style=color:#f92672>import</span> StateInline
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>LINK_PATTERN <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>compile(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#34;\[\[([^[|\]\n])+(\|[^]\n]+)?]]&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_wikilink_inline</span>(state: StateInline, silent: bool) <span style=color:#f92672>-&gt;</span> bool:
</span></span><span style=display:flex><span>    match <span style=color:#f92672>=</span> LINK_PATTERN<span style=color:#f92672>.</span>match(state<span style=color:#f92672>.</span>src[state<span style=color:#f92672>.</span>pos :])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> match:
</span></span><span style=display:flex><span>	    <span style=color:#75715e># Not a wikilink!</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># Push the wikilink token</span>
</span></span><span style=display:flex><span>    token <span style=color:#f92672>=</span> state<span style=color:#f92672>.</span>push(<span style=color:#e6db74>&#34;wikilink&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    token<span style=color:#f92672>.</span>content <span style=color:#f92672>=</span> match<span style=color:#f92672>.</span>group()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># Increment parser location</span>
</span></span><span style=display:flex><span>    state<span style=color:#f92672>.</span>pos <span style=color:#f92672>+=</span> match<span style=color:#f92672>.</span>end()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># Found a wikilink!</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wikilink_plugin</span>(md: MarkdownIt) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>	<span style=color:#75715e># Register the parser!</span>
</span></span><span style=display:flex><span>    md<span style=color:#f92672>.</span>inline<span style=color:#f92672>.</span>ruler<span style=color:#f92672>.</span>push(<span style=color:#e6db74>&#34;wikilink&#34;</span>, _wikilink_inline)
</span></span></code></pre></td></tr></table></div></div><h3 id=formatting-wikilinks><a href=#formatting-wikilinks>Formatting Wikilinks<span hidden class=anchor aria-hidden=true href=#formatting-wikilinks>#</span></a></h3><p>Our mdformat plugin is even more simplistic.</p><ol><li>The <code>update_mdit</code> function is used to load our wikilink-parsing plugin into the current instance of markdown-it-py</li><li>The <code>_render_wikilink</code> function returns the content of the wikilink token (or node, in mdformat terminology) that we pushed</li></ol><p>That&rsquo;s it.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> collections.abc <span style=color:#f92672>import</span> Mapping
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> markdown_it <span style=color:#f92672>import</span> MarkdownIt
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> mdformat.renderer <span style=color:#f92672>import</span> RenderContext, RenderTreeNode
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> mdformat.renderer.typing <span style=color:#f92672>import</span> Render
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> mdformat_wikilink.mdit_wikilink_plugin <span style=color:#f92672>import</span> wikilink_plugin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>update_mdit</span>(mdit: MarkdownIt) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>	<span style=color:#75715e># Load the markdown-it wikilink plugin to parse wikilinks</span>
</span></span><span style=display:flex><span>    mdit<span style=color:#f92672>.</span>use(wikilink_plugin)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_render_wikilink</span>(node: RenderTreeNode, context: RenderContext) <span style=color:#f92672>-&gt;</span> str:
</span></span><span style=display:flex><span>	<span style=color:#75715e># Render as-is.</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> node<span style=color:#f92672>.</span>content
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Register the render function</span>
</span></span><span style=display:flex><span>RENDERERS: Mapping[str, Render] <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;wikilink&#34;</span>: _render_wikilink}
</span></span></code></pre></td></tr></table></div></div><h3 id=a-tiny-bit-of-config><a href=#a-tiny-bit-of-config>A Tiny Bit of Config<span hidden class=anchor aria-hidden=true href=#a-tiny-bit-of-config>#</span></a></h3><p>The last thing we need to do is register the right entry-point for our plugin, so that mdformat will know to load and use it.
We can do it in our <code>pyproject.toml</code> file (I&rsquo;m using <a href=https://python-poetry.org/>Poetry</a>, other tools have similar options).</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>tool</span>.<span style=color:#a6e22e>poetry</span>.<span style=color:#a6e22e>plugins</span>.<span style=color:#e6db74>&#34;mdformat.parser_extension&#34;</span>]
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;wikilink&#34;</span> = <span style=color:#e6db74>&#34;mdformat_wikilink.mdformat_plugin&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>And with that, we&rsquo;re done.</p><p>You can see the whole project at <a href=https://github.com/tmr232/mdformat-wikilink>mdformat-wikilink</a>.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Wikilinks the link markup you see in wikis like Wikipedia. They are of the form <code>[[Target]]</code> or <code>[[Target|Alias]]</code>, and generally create links <em>inside</em> the wiki.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>And a blog post documenting it, for future reference. Which you are now reading.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://tamir.dev/>Tamir Bahar</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>