<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Implementing C++ Semantics in Python - a writeup | Tamir Bahar</title><meta name=keywords content><meta name=description content="A writeup of my 2021 talk Implementing C++ Semantics in Python"><meta name=author content="Tamir Bahar"><link rel=canonical href=https://tamir.dev/posts/cpppy/><link crossorigin=anonymous href=/assets/css/stylesheet.0b7a6a59f13c612205962144f1a8f43a859c4d814d43709a9e3e2b0e9353224b.css integrity="sha256-C3pqWfE8YSIFliFE8aj0OoWcTYFNQ3Canj4rDpNTIks=" rel="preload stylesheet" as=style><link rel=icon href=https://tamir.dev/images/profilepic.jpg><link rel=icon type=image/png sizes=16x16 href=https://tamir.dev/images/profilepic.jpg><link rel=icon type=image/png sizes=32x32 href=https://tamir.dev/images/profilepic.jpg><link rel=apple-touch-icon href=https://tamir.dev/images/profilepic.jpg><link rel=mask-icon href=https://tamir.dev/images/profilepic.jpg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=webmention href=https://webmention.io/tamir.dev/webmention><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Implementing C++ Semantics in Python - a writeup"><meta property="og:description" content="A writeup of my 2021 talk Implementing C++ Semantics in Python"><meta property="og:type" content="article"><meta property="og:url" content="https://tamir.dev/posts/cpppy/"><meta property="og:image" content="https://tamir.dev/images/profilepic.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-10-22T00:00:00+00:00"><meta property="article:modified_time" content="2023-10-22T00:00:00+00:00"><meta property="og:site_name" content="Tamir Bahar"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://tamir.dev/images/profilepic.jpg"><meta name=twitter:title content="Implementing C++ Semantics in Python - a writeup"><meta name=twitter:description content="A writeup of my 2021 talk Implementing C++ Semantics in Python"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://tamir.dev/posts/"},{"@type":"ListItem","position":2,"name":"Implementing C++ Semantics in Python - a writeup","item":"https://tamir.dev/posts/cpppy/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Implementing C++ Semantics in Python - a writeup","name":"Implementing C\u002b\u002b Semantics in Python - a writeup","description":"A writeup of my 2021 talk Implementing C++ Semantics in Python","keywords":[],"articleBody":"Writeup of my talk about the cpppy library\nA few years ago I gave a talk about implementing C++ semantics (namely, destructors) in Python. After giving the talk, I published my speaker notes and slides, to make it as accessible as possible, even to people who don’t wanna watch a video. I was quite pleased with myself, until a few weeks ago when I wanted to look up a detail so that I can reference it in a new blogpost. I went to the speaker notes, started reading, and oh. Oh no. I could get through it, but it really doesn’t hold up on its own despite my memory of it being “everything I said during the talk”. That’s quite unfortunate, as I am very pleased with the work I done for this talk, and want people to happen upon it. Which brings us here - this is that talk, but as a blogpost.\nBut Why? When coming to implement C++ semantics in Python, the first question we need to ask ourselves is “why?”. Why would we want to take anything (other than performance) from C++ into Python? After all, C++ is a low-level language, mostly “expert oriented”, and is slowly becoming more “Pythonic”. And on the other hand, Python is a high-level language, it is beginner friendly, and has far fewer footguns than C++.\nThe answer to that question is resource-management. In C++, all resources are handled the same way. Be it allocated memory; a file; a lock; or your own resource - they are all handled using the same mechanism. In Python, on the other hand, different resources are handled differently. While memory is managed for you by the garbage collector, all other resources must be managed by the programmer.\nBefore you say anything - no. Python is not C. We don’t have to call the cleanup functions manually. Instead, Python gives us context managers.\nContext Managers Context-managers are relatively straight-forward. To use them, we use the with statement as follows:\n1 2 with FileReader(path) as f: print(f.read()) Then, the language uses our FileReader object to wrap the indented block, roughly as follows:\n1 2 3 4 5 6 7 8 9 _tmp = FileReader(path) f = _tmp.__enter__() try: print(f.read()) except: if not _tmp.__exit__(\u003cexception info\u003e): raise finally: _tmp.__exit__(\u003cNone exception info\u003e) Before entering the indented block, we create our FileReader and call its __enter__ method. Then, we run the contents of the block. Then, on leaving the block, we call __exit__. If an exception was raised from the block, we’ll get the exception info and have a choice to either silence it (by returning a True value) or re-raise it (by returning False). If no exception was raised - we’ll get get no exception information.\nTo define a context manager, all we have to do is add an __enter__ method and an __exit__ method to our class:\n1 2 3 4 5 6 7 8 class FileReader: def __enter__(self): return self def __exit__(self, exc_type, exc_val, exc_tb): self.close() ... Real Code This is well and nice, but let’s look at some real code, a redacted version of something we had running in production:\n1 2 3 4 5 6 7 8 9 10 class ArchiveReader: def __init__(self, path: str): self.data = {} with ZipFile(path) as zipfile: for name in zipfile.namelist(): with zipfile.open(name) as f: self.data[name] = f.read() def read(self, name): return self.data[name] We had a zip file containing many small files. So to make reading fast and simple, we read all the files into memory when initializing the reader. Then, when we needed a specific file - we just accessed it in the data dict. This way we only unzip once, which was a significant performance gain.\nThe usage of the class was also very straightforward:\n1 2 3 4 5 reader = ArchiveReader(\"corecpp.zip\") print(reader.read(\"2021\")) # Prints: # Hello, CoreC++! We were fairly pleased.\nBut, as time went by, we ran into issues. The data files we were reading changed from being tiny (\u003c10MiB) to huge (\u003e5GiB). As a result, we could no longer keep the files unzipped in memory.\nThe “easy” solution would keep the path, and open the zip file whenever we read a file, unzipping only the desired file. This works, but due to the need to parse zip metadata, it adds a significant overhead in execution time.\nThe solution we went with was to create the ZipFile object (thus parsing the metadata) and hold it in our ArchiveReader class. Then, when we read a file, we open and unzip only the said file:\n1 2 3 4 5 6 7 class BigArchiveReader: def __init__(self, path: str): self.zipfile = ZipFile(path) def read(self, name: str): with self.zipfile.open(name) as f: return f.read() Unfortunately, now that we hold a ZipFile object, we need to manage it. To do that, we had to make our archive reader a context-manager:\n1 2 3 4 5 6 7 8 class BigArchiveReader: ... def __enter__(self): return self def __exit__(self, exc_type, exc_val, exc_tb): self.zipfile.close() Which, in turn, changes the usage of our reader:\n1 2 with BigArchiveReader(\"corecpp.zip\") as big_reader: print(big_reader.read(\"2021\")) In turn, this demonstrates a bigger issue. Holding a context manager as a member changes the interface of our objects, forcing them to be context managers as well. This change propagates up to all respective owners, and up the stack to the point where the top-level object is created. As this is a breaking change, we must be able to change the code that uses our object. In the general case, this is not possible.\nC++ Destructors C++, however, has a solution to those issues - destructors. Destructors are what makes C++ resource management work, and they have 3 key properties we’re interested in. They are:\nAutomatic Composable Implicit. Automatic Invocation The invocation of a destructor is automatic. When we leave a scope, they are called automatically, no matter how we leave the scope.\n1 2 3 4 5 { auto reader = FileReader(path); std::cout \u003c\u003c reader.read() \u003c\u003c '\\n'; } // \u003c-- The destructor is called here! Seamless Composition Destructors of member fields are called automatically, making composition easier. If we add a new member, we know that it’s destructor will be called when it is needed.\n1 2 3 4 5 6 7 8 9 class ArchiveReader { ... }; ... auto reader = ArchiveReader(path); } // \u003c-- Destructor is called! // ~ArchiveReader(); 1 2 3 4 5 6 7 8 9 10 11 12 class BigArchiveReader { ZipFile zipfile; ... }; ... auto big_reader = BigArchiveReader(path); } // \u003c-- Destructor is called! // ~BigArchiveReader(); // Followed by member destructor: // ~ZipFile(); Implicit Interfaces Last but not least - destructors are implicit in object interfaces. Objects with user defined destructors and objects without them are all used the same way.\n1 2 3 4 5 6 7 8 9 // Object with no destructor { auto object = ObjectWithoutDtor(); } // Object with destructor { auto object = ObjectWithDtor(); } This is even if we don’t define them, they always exist, for all objects. This means that when we write our own destructors, our interfaces don’t change, and no change is propagated.\nOur Goal With that in mind, we want to bring destructors from C++ to Python. Converting our archive reader from this (11 lines of code, 4 are dedicated to resource management):\n1 2 3 4 5 6 7 8 9 10 11 12 13 class BigArchiveReader: def __init__(self, path: str): self.zipfile = ZipFile(path) def read(self, name: str): with self.zipfile.open(name) as f: return f.read() def __enter__(self): return self def __exit__(self, exc_type, exc_val, exc_tb): self.zipfile.close() To this (7 lines of code, 0 dedicated to resource management):\n1 2 3 4 5 6 7 8 class BestArchiveReader: zipfile: ZipFile def __init__(self, path: str): self.zipfile = ZipFile(path) def read(self, name: str): with self.zipfile.open(name) as f: return f.read() And ensure that our usage remains the same as the original ArchiveReader, with no context-managers and no interface pollution:\n1 2 reader = BestArchiveReader(\"corecpp.zip\") print(reader.read(\"2021\")) Don’t Try This At Work Seriously, just don’t.\nIt’s all fun, and standard, and truly painful in a code review or debugging session.\nWith that in mind, let’s start!\nImplementing C++ Destructors in Python Automatic Since our target class is a bit complicated, we’ll be joined in our implementation journey by a simple class called Greeter. The greeter is a simple class. It takes a name on construction, and says “Hello”. On destruction, it says “Goodbye”\nThis will allow us to keep track of ctors and dtors as we progress through this post.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 class Greeter: def __init__(self, name): self.name = name print(f\"Hello, {self.name}!\") def close(self): print(f\"Goodbye, {self.name}.\") def main(): greeter = Greeter(1) print(\"We have a greeter!\") greeter.close() main() Hello, 1! We have a greeter! Goodbye, 1. Our first implementation is as straight-forward as can be. With a constructor and a “close” method to act like our dtor.\nThe next step is pretty straight-forward. Since Python already provides us with context-manages and the with statement, we’ll use them and see where it gets us.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 class Greeter: def __init__(self, name): self.name = name print(f\"Hello, {self.name}!\") def __enter__(self): return self def __exit__(self, exc_type, exc_val, exc_tb): print(f\"Goodbye, {self.name}.\") return False def main(): with Greeter(1): print(\"We have a greeter!\") main() Hello, 1! We have a greeter! Goodbye, 1. Stacking Dtors What if we want more than one Greeter? No problem! Just stack the context-managers!\n1 2 3 4 5 6 7 8 def main(): with Greeter(1): print(\"First\") with Greeter(2): print(\"Second\") main() Hello, 1! First Hello, 2! Second Goodbye, 2. Goodbye, 1. Then again, this type of nesting can get unwieldy quick. We need something better.\nSince we’re already stacking context-managers, we can use a proper stack:\n1 2 3 4 5 6 7 8 9 10 11 12 13 class DtorScope: def __init__(self): self.stack = [] def __enter__(self): return self def __exit__(self, exc_type, exc_val, exc_tb): while self.stack: self.stack.pop().__exit__(exc_type, exc_val, exc_tb) def push(self, cm): self.stack.append(cm) The DtorScope will hold all of our Greeter objects in place, then call their __exit__ methods when we leave the with context:\n1 2 3 4 5 6 7 8 9 10 def main(): with DtorScope() as dtor_stack: greeter1 = Greeter(1) dtor_stack.push(greeter1) greeter2 = Greeter(2) dtor_stack.push(greeter2) main() Hello, 1! Hello, 2! Goodbye, 2. Goodbye, 1. And with that, we’ve rid ourselves of the nesting issue. It works, destruction is automatic, it’s fairly straight-forward, and all too explicit.\nImplicit Now that our destructors get called automatically on scope exit, we want to make sure that we don’t need to write any code to make it happen.\nIf we could, we’d like our function to look like this:\n1 2 3 def main(): greeter1 = Greeter(1) greeter2 = Greeter(2) And have it implicitly do all the plumbing we managed earlier.\nFirst, since we always want to push our objects onto the dtor stack, let’s make it part of their construction.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 class Greeter: def __init__(self, name, dtor_stack): dtor_stack.push(self) self.name = name print(f\"Hello, {self.name}!\") def __enter__(self): return self def __exit__(self, exc_type, exc_val, exc_tb): print(f\"Goodbye, {self.name}.\") return False def main(): with DtorScope() as dtor_stack: greeter1 = Greeter(1, dtor_stack) greeter2 = Greeter(2, dtor_stack) main() That’s a good start. We can no longer forget to push our greeters onto the DtorScope, and we saved a couple of lines.\nThat said, we’re explicitly repeating and passing around a construct that should be implicit.\nTo pass the dtor_stack implicitly to the Greeter class, we need to store it somewhere. In our case, we’ll use a global variable! And just like function calls go into a stack so that we know where to return, so will our DtorScopes. So instead of a single global variable, we’ll have to use a global stack.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 _dtor_stack = [] def get_dtor_stack(): return _dtor_stack class DtorScope: def __init__(self): self.stack = [] # Push current scope onto global scope stack get_dtor_stack().append(self) def __enter__(self): return self def __exit__(self, exc_type, exc_val, exc_tb): # Pop current scope from global scope stack get_dtor_stack().pop() while self.stack: self.stack.pop().__exit__(exc_type, exc_val, exc_tb) def push(self, cm): self.stack.append(cm) def push_dtor(cm): return get_dtor_stack()[-1].push(cm) This is the same as our previous dtor-scope, but now we keep a global stack of scopes. This allows us to always tell which dtor-stack to push our instances into without naming the stack.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 class Greeter: def __init__(self, name): self.name = name print(f\"Hello, {self.name}!\") # Push the greeter onto the current dtor-scope push_dtor(self) def __enter__(self): return self def __exit__(self, exc_type, exc_val, exc_tb): print(f\"Goodbye, {self.name}.\") return False def main(): with DtorScope(): greeter1 = Greeter(1) greeter2 = Greeter(2) main() Much better, but we still need to explicitly create the scope inside every function.\nDecorators However, since the dtor scoping mechanism has nothing to do with the function itself, we can use it at the callsite instead of inside the function, and it’d work exactly the same.\n1 2 3 4 5 6 def main(): greeter1 = Greeter(1) greeter2 = Greeter(2) with DtorScope(): main() This will have to be done on every callsite, so we add a utility function to help with that.\nThe *args, **kwargs syntax is there to pass along any and all function arguments unchanged. Think of it as Python’s version of perfect-forwarding.\n1 2 3 4 5 def call(f, *args, **kwargs): with DtorScope(): return f(*args, **kwargs) call(main) Alternatively, we can take the function and return a closure that includes the scoping.\n1 2 3 4 5 6 7 8 9 def cpp_function(f): def _wrapper(*args, **kwargs): with DtorScope(): return f(*args, **kwargs) return _wrapper scoped_main = cpp_function(main) scoped_main() Inside _wrapper we capture f from the parent scope. As Python is reference-based, we don’t need to specify how to capture.\nNext, since Python is dynamic, we can replace the original main function with the scoped one.\n1 2 3 4 5 6 7 def main(): greeter1 = Greeter(1) greeter2 = Greeter(2) main = cpp_function(main) main() Here the wrapper holds the previous version of the function, while the name main is bound to the wrapped version.\nIn Python, wrapping a function and replacing its original is a common operation. Because of that, we have some syntactic sugar called “decorators”.\n1 2 3 4 5 6 @cpp_function def main(): greeter1 = Greeter(1) greeter2 = Greeter(2) main() This is functionally equivalent to the previous snippet, but is cleaner and more expressive. And with that, the inside of main looks the way we want it.\nImport Hacks We still have a problem, though. Even if main looks nice, we had to decorate it with cpp_function. Having to do that to every function we write for it to work is not very “implicit”, is it?\nWhat if instead, we could just write from cpp import magic, and have that “magic” decorate our functions for us?\n1 2 3 4 5 from cpp import magic def main(): greeter1 = Greeter(1) greeter2 = Greeter(2) Nice, isn’t it? So let’s get to it!\nThe Magic Function As a first step, we’ll call a function at the end of our module to decorate everything:\n1 2 3 4 5 6 7 8 9 10 11 from cpp import magic from greeter import Greeter def main(): greeter1 = Greeter(1) greeter2 = Greeter(2) magic() main() Our magic() function needs to do 2 things:\nGet the module it was called in; and decorate all the functions. 1 2 3 def magic(): calling_module = get_calling_module() decorate_module_functions(calling_module) To get the calling module, we use inspect.stack to traverse the callstack and find the right module\n1 2 3 4 5 6 7 import inspect def get_calling_module(): # Use 2 here because we need to go 2 frames up. stack_frame = inspect.stack()[2].frame module = inspect.getmodule(stack_frame) return module We get the callstack, take the frame 2 level above us (the caller to magic()), and use inspect.getmodule to get the relevant module.\nThen we decorate our functions.\n1 2 3 4 5 6 7 8 9 10 11 def decorate_module_functions(module): for name, value in inspect.getmembers(module): if not inspect.isroutine(value): continue # Only convert functions that were defined in the importing file. # We don't want to convert library imports and the likes of those. if inspect.getmodule(value) != module: continue setattr(module, name, cpp_function(value)) Our function takes a module and modifies it.\nTo do this, we’re using some of Python’s reflection capabilities. inspect.getmembers(obj) returns all the member variables of a given object. In our case - a module. inspect.isroutine(obj) tells us whether a value is a function. inspect.getmodule(obj) returns the module an object was defined in. setattr(obj, name, value) sets an object attribute named name to value.\nAnd with that our magic() function is operational!\nFor our next trick, we’ll make the call to magic() disappear as well. This means that we need to somehow make the from cpp import magic line do the actual magic.\n“But Tamir! An import is not a function call!” you might say. Well, let’s see what a Python import actually does.\nImport Internals When we run from cpp import magic we go through the following steps.\nFirst, we look for a module named cpp in the global module cache, sys.modules. If it is present, the module is already loaded, and we can skip to name binding.\nIf it is not present in the cache, we find it on disk, create a module object from it, place the module object in the cache, and then execute the module.\nNote that we first store it in the cache, and only then execute the module. This is important as Python allows for cyclic imports, and we want to avoid recursion. It will also come in handy later.\nOnce we finish executing the module, we need to bind the relevant names. In this case - magic.\nPython takes the cpp module from sys.modules and looks for magic inside it. If it finds it, it binds that to the name magic.\nLastly, Python modules may define a __getattr__(name) function. If it is defined, it is called whenever we try to import a name that isn’t present in the module.\n1 magic = cpp.__getattr__(\"magic\") So, as you can see - import can be a function call!\n1 2 3 4 5 6 7 8 9 def _magic(): calling_module = get_calling_module() decorate_module_functions(calling_module) def __getattr__(name): if name != \"magic\": raise AttributeError() _magic() This converts the import to a call and allows C++ to work it’s magic.\n1 2 3 4 5 6 7 8 9 from cpp import magic from greeter import Greeter def main(): greeter1 = Greeter(1) greeter2 = Greeter(2) main() Well, almost…\nYou see, since we’re imported on the first line of the module, the module is empty. The functions we want to decorate are not yet defined. To fix this, we can do one of two things.\nThe first option is to import our magic at the end of the file\n1 2 3 4 5 6 7 8 9 from greeter import Greeter def main(): greeter1 = Greeter(1) greeter2 = Greeter(2) from cpp import magic main() This works, but feels far from magical.\nThe other option, then, is to import the modules ourselves! With the fully imported module at hand, we can modify it as we wish.\nImport Cycles This means that our _magic() function is going to change a little:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 import importlib.util import sys def import_by_path(name: str, path: str): spec = importlib.util.spec_from_file_location(name, path) module = importlib.util.module_from_spec(spec) sys.modules[name] = module spec.loader.exec_module(module) return module def _magic(): calling_module = get_calling_module() name = calling_module.__name__ path = calling_module.__file__ imported_module = import_by_path(name, path) decorate_module_functions(imported_module) Using Python’s import mechanisms, we import another instance of the module that imported us.\nWe use it’s name and path to import it again, then store it in the global module cache instead of the original.\nThis is where the fact that the cache is filled prior to module execution comes in handy!\nWe execute the module, to define all the types, and then decorate the functions.\nWith this change, we can now write the import at the top again:\n1 2 3 4 5 6 7 8 9 from cpp import magic from greeter import Greeter def main(): greeter1 = Greeter(1) greeter2 = Greeter(2) main() And recurse infinitely.\nOur module runs the magic() function. The magic() function imports our module. The module runs the magic() function. The magic() function imports our module.\nAnd so on and so forth.\nTo fix that, we add a flag to all the modules we import, before executing them. Then, in our magic() function, we check for the flag.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 IMPORT_FLAG = \"__magically_imported__\" def import_by_path(name: str, path: str): spec = importlib.util.spec_from_file_location(name, path) module = importlib.util.module_from_spec(spec) sys.modules[name] = module setattr(module, IMPORT_FLAG, True) spec.loader.exec_module(module) return module def _magic(): calling_module = get_calling_module() name = calling_module.__name__ path = calling_module.__file__ if hasattr(calling_module, IMPORT_FLAG): return imported_module = import_by_path(name, path) decorate_module_functions(imported_module) This breaks the recursion, but we still have an issue.\nOnce we finish all of our import magic, we return to the module that triggered the magic. This module has not yet been modified. Once we return to it, it’ll run to completion. In the case of our main module - main() will run twice. First, when we import it inside magic(). Second, when we return to the main module and let it execute. In both cases, we’ll be running the non-decorated version. This is not at all what we want.\nTo avoid this sort of thing, Python code usually uses the following:\n1 2 if __name__ == \"__main__\": main() __name__ always holds the name of the current module. In the case of the main module, it’ll be \"__main__\".\nThis ensures that when a module is imported (and used as a library) it will not run the main() function.\nIn our case, this will not be enough. First, we actually do import the module. Second, we need to ensure that once we’re done, the original doesn’t run.\nSo once again, we modify our magic function!\n1 2 3 4 5 6 7 8 9 10 11 12 13 def _magic(): calling_module = get_calling_module() name = calling_module.__name__ path = calling_module.__file__ if hasattr(calling_module, IMPORT_FLAG): return imported_module = import_by_path(name, path) decorate_module_functions(imported_module) if imported_module.__name__ == \"__main__\": sys.exit(imported_module.main()) Instead of preventing main() from running, we call it explicitly. That means that, like in C++ code, we don’t need to call main() explicitly in our code.\n1 2 3 4 5 6 7 from cpp import magic from greeter import Greeter def main(): greeter1 = Greeter(1) greeter2 = Greeter(2) When we’re done, we call sys.exit to terminate the process, and never actually reach the module that initially imported us.\nClass Boilerplate Another thing we want to address is the code inside our Greeter. We are currently writing a lot of boilerplate there. We have the __enter__ method, the unused __exit__ arguments, and pushing the instance into the dtor stack.\nWith a bit of inheritance, we can move all that boilerplate out of Greeter.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 from cpp import magic class CppClass: def __init__(self, *args, **kwargs): push_dtor(self) ctor = getattr(self, self.__class__.__name__, None) if ctor: ctor(*args, **kwargs) def __enter__(self): return self def __exit__(self, exc_type, exc_val, exc_tb): dtor = getattr(self, \"_\" + self.__class__.__name__, None) if dtor: dtor() class Greeter(CppClass): def Greeter(self, name): self.name = name print(f\"Hello, {self.name}!\") def _Greeter(self): print(f\"Goodbye, {self.name}.\") def main(): greeter1 = Greeter(1) greeter2 = Greeter(2) That’s great. Now as we add more classes, we don’t need to handle all that annoying dtor-stack stuff. As a bonus - our constructor is now named Greeter, as it would be in C++; and our destructor is _Greeter, as ~ is not valid in Python identifiers.\nBut… We’re still missing something. We decorated all free functions with cpp_function, but we still need to decorate all of our member functions.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 def decorate_object_methods(obj): for name, value in inspect.getmembers(obj): # Ignore magic methods if name.startswith(\"__\"): continue if not inspect.isroutine(value): continue setattr(self, name, cpp_function(value)) class CppClass: def __init__(self, *args, **kwargs): push_dtor(self) decorate_object_methods(self) ctor = getattr(self, self.__class__.__name__, None) if ctor: ctor(*args, **kwargs) def __enter__(self): return self def __exit__(self, exc_type, exc_val, exc_tb): dtor = getattr(self, \"_\" + self.__class__.__name__, None) if dtor: dtor() This is similar to what we did with the modules, but this time we check for magic methods, as we don’t wanna decorate them.\nLast but not least - we want to make it truly implicit.\nCurrently, we use inheritance explicitly to extend our Greeter class with the CppClass methods. In essence, we’re injecting 3 methods into our Greeter class - __init__, __enter__, and __exit__. We’re using inheritance, but we can use a decorator just as well. We take the class, make the relevant modifications, then return the modified version.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 def cpp_class(cls): def __init__(self, *args, **kwargs): ... def __enter__(self): ... def __exit__(self, exc_type, exc_val, exc_tb): ... cls.__init__ = __init__ cls.__enter__ = __enter__ cls.__exit__ = __exit__ return cls @cpp_class class Greeter: ... This might look a bit funky, but it integrates well with our previous work decorating all free functions.\nA few extra touches are moving the method decoration out of the __init__ method, so that it only happens once; and adding a __cpp_class__ attribute so that our code can tell it’s actually a C++-style class.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 def cpp_class(cls): decorate_object_methods(cls) def __init__(self, *args, **kwargs): ... def __enter__(self): ... def __exit__(self, exc_type, exc_val, exc_tb): ... cls.__init__ = __init__ cls.__enter__ = __enter__ cls.__exit__ = __exit__ cls.__cpp_class__ = True return cls @cpp_class class Greeter: ... Lastly, we modify _magic to decorate classes as well:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 def decorate_module_classes(module): for name, value in inspect.getmembers(module): if not inspect.isclass(value): continue # Only convert functions that were defined in the importing file. # We don't want to convert library imports and the likes of those. if inspect.getmodule(value) != module: continue setattr(module, name, cpp_class(value)) def _magic(): ... decorate_module_classes(module) ... And with that, are classes are automatically converted to C++ classes!\n1 2 3 4 5 6 7 8 9 10 11 12 13 from cpp import magic class Greeter: def Greeter(self, name): self.name = name print(f\"Hello, {self.name}!\") def _Greeter(self): print(f\"Goodbye, {self.name}.\") def main(): greeter1 = Greeter(1) greeter2 = Greeter(2) Composable We’ve come a long way so far, and our destructors are called automatically and implicitly. The next step is making our classes composable. Or, more specifically - handling members properly.\nBefore we do that, let’s see where we are now:\n1 2 3 4 5 6 7 8 9 10 11 12 class BetterArchiveReader: zipfile: ZipFile # This is a type annotation, it does nothing. def BetterArchiveReader(self, path: str): self.zipfile = ZipFile(path) def read(self, name: str): with self.zipfile.open(name) as f: # Resource management return f.read() def _BetterArchiveReader(self): self.zipfile.close() # More resource management We have fewer lines, and fewer resource-management lines. That’s great. But we also have a new issue - double free! When we create the ZipFile object, it gets pushed into the dtor-scope of the BetterArchiveReader ctor. Later, when we get to the dtor and call .close() on it, it is already closed!\nTo fix that, we need to somehow remove the ZipFile from the function scope, and let the BetterArchiveReader handle it instead. So something like:\n1 2 3 4 5 6 7 8 class BetterArchiveReader: ... def BetterArchiveReader(self, path: str): self.zipfile = ZipFile(path) remove_dtor(self.zipfile) ... Which would call a .remove method on the current DtorScope:\n1 2 3 4 5 class DtorScope: stack: list ... def remove(self, cm): self.stack.remove(cm) Which will, unfortunately, fail. list.remove() checks for equality, not identity. So if we have multiple object that compare equal - we’re in for some painful debugging. To remedy this, we’ll borrow a trick from the C++ playbook and use a comparison object:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 class IdentityComparator: def __init__(self, obj): self.obj = obj def __eq__(self, other): return self.obj is other class DtorScope: ... def remove(self, cm): self.stack.remove(IdentityComparator(cm)) def remove_dtor(cm): get_dtor_stack()[-1].remove(cm) IdentityComparator wraps the object we provide, replacing the equality check with an identity check, resolving the issue.\nAnd while ZipFile does have a .close method, not all context-managers do. So we’ll make our code a bit more generic with a call to __exit__:\n1 2 3 ... def _BetterArchiveReader(self): self.zipfile.__exit__(None, None, None) That’s better, but we’re back to managing the dtors of our objects manually again. Instead, we want assignment to a class member to handle all that automatically.\nDescriptors Unlike C++, Python does not have any form of assignment operators. So we can’t use those. It does, however, have setters and getters. Before we dive into that bit of syntax, let’s look at what we want them to do:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 def is_cpp_class(cls): # Use the flag we set earlier to detect C++ classes return getattr(cls, \"__cpp_class__\", False) def get_zipfile(self): # Nothing to do on get - the class maintains ownership. return getattr(self, \"zipfile\") def set_zipfile(self, zipfile): old = getattr(self, \"zipfile\", None) # If the old object a C++ class, we destruct it if is_cpp_class(old): old.__exit__(None, None, None) # Then we remove the new object from the scope of the # function it was assigned in. if is_cpp_class(zipfile): remove_dtor(zipfile) setattr(self, \"zipfile\", zipfile) Naturally, we don’t wanna be writing and calling those methods everywhere. To circumvent that, we’ll use “descriptors”, Python’s flavour of getters and setters.\nAny class member variable (class, not instance) that implements __set__ and __get__ is a descriptor. When we later access those variables through an instance, those methods are called to set or get the value from the member. Adjusting our code to use them, we get:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 class CppMember: def __set_name__(self, owner, name): # Called on class creation self.private_name = \"_\" + name def __get__(self, instance, owner=None): # Called on an instance, when getting the value return getattr(instance, self.private_name) def __set__(self, instance, value): # Called on an instance, when setting the value old = getattr(instance, self.private_name, None) if is_cpp_class(old): old.__exit__(None, None, None) if is_cpp_class(value): remove_dtor(value) setattr(instance, self.private_name, value) class Reader: # Create zipfile as a class member variable zipfile = CppMember() def Reader(self, path): self.zipfile = ZipFile(path) __set_name__ is another descriptor method. It is called on class creation (when Python creates the class object, not an instance) to pass the variable name to the descriptor. Then, the descriptor can derive a unique name from it and use it to store the actual value in the instance.\nThis takes care of the function-scope. The next thing to do is make sure when our destructor is called, we call all the member destructors as well. So in cpp_class, we add a call the member destructors after dealing with the class destructor.\n1 2 3 4 5 6 7 8 9 10 11 12 13 def __exit__(self, exc_type, exc_val, exc_tb): ... # Handle class dtor first # Then handle member dtors in reversed definition order for name, value in reversed(inspect.getmembers(self)): if name.startswith(\"_\"): continue if not is_cpp_class(value): continue value.__exit__(None, None, None) This leaves us with much nicer code:\n1 2 3 4 5 6 7 8 class BetterArchiveReader: zipfile = CppMember() def BetterArchiveReader(self, path): self.zipfile = ZipFile(path) def read(self, name: str): ... We just assign a ZipFile to a member, and we’re good to go. Our member destructors are called automatically.\nAnnotations But… That zipfile = CppMember() still bothers me. It shows some plumbing that is better hidden. And we can do better.\nPython has type annotations. They look something like:\n1 2 class SomeClass: name: SomeType They don’t really do anything, but once we use them, Python stores a mapping between name and SomeType inside our SomeClass object. And if we have a mapping, we can query it:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 def create_members(cls): # Query the the member variable annotations for the given class member_names = list(getattr(cls, '__annotations__', {})) for name in member_names: # Create a new CppMember Descriptor object member = CppMember() # Since we're modifying an already-created class, # we need to call `__set_name__` manually here member.__set_name__(cls, name) # Assign the newly created descriptor to the class member. setattr(cls, name, member) # This will be useful later setattr(cls, '__member_names__', member_names) def cpp_class(cls): ... create_members(cls) ... def __exit__(self, exc_type, exc_val, exc_tb): ... # We have a list of all members now, so no need # to use reflection to get it. for name in reversed(self.__member_names__): value = getattr(self, name, None) if is_cpp_class(value): value.__exit__(None, None, None) And with that, we’ve reached our goal! We can now write our BestArchiveReader as if it was a C++ class:\n1 2 3 4 5 6 7 8 9 class BestArchiveReader: zipfile: ZipFile def BestArchiveReader(self, path: str): self.zipfile = ZipFile(path) def read(self, name: str): with self.zipfile.open(name) as f: return f.read() Wrapping Up We started by looking at Python’s take on destructors, and the issues it poses. Then, we took inspiration from C++ and gradually built a “better” solution. We focused on 3 main goals, and achieved them:\nAutomatic: destructors are called when / where they are needed. Composable: members work automatically, with no added boilerplate. Implicit: no extra code; no changes to interfaces; no interface pollution. But… Some of you may have noticed a glaring issue. Once a value is created in a function, or assigned to a member variable - we can no longer move it. See, we have ownership, but no move semantics.\nThere are some extra tricks we can use (and are used in the library) for returning values, but I don’t think the general case is elegantly solvable.\nFurther Reading First, thank you for reading this entire post. If you want to play with the concepts I presented here, check the full implementation, you can check it out on my Github. You’ll also find there an implementation of access specifiers, which you’re sure to enjoy.\nThis was a fun experiment when I first started playing with this, and a fun talk to present. I hope you have fun with this too.\n","wordCount":"5891","inLanguage":"en","datePublished":"2023-10-22T00:00:00Z","dateModified":"2023-10-22T00:00:00Z","author":{"@type":"Person","name":"Tamir Bahar"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://tamir.dev/posts/cpppy/"},"publisher":{"@type":"Organization","name":"Tamir Bahar","logo":{"@type":"ImageObject","url":"https://tamir.dev/images/profilepic.jpg"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tamir.dev/ accesskey=h title="Tamir Bahar (Alt + H)">Tamir Bahar</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://tamir.dev/blogvent/ title=blogvent🎄><span>blogvent🎄</span></a></li><li><a href=https://tamir.dev/posts/ title=posts><span>posts</span></a></li><li><a href=https://tamir.dev/archives/ title=archives><span>archives</span></a></li><li><a href=https://tamir.dev/index.xml title=rss><span>rss</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" height="13"><g transform="scale(1)"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></g></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://tamir.dev/>Home</a>&nbsp;»&nbsp;<a href=https://tamir.dev/posts/>Posts</a></div><h1 class=post-title>Implementing C++ Semantics in Python - a writeup</h1><div class=post-description>A writeup of my 2021 talk Implementing C++ Semantics in Python</div><div class=post-meta><span title='2023-10-22 00:00:00 +0000 UTC'>Oct 22, 2023</span>&nbsp;·&nbsp;Tamir Bahar</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#but-why>But Why?</a><ul><li><a href=#context-managers>Context Managers</a></li><li><a href=#real-code>Real Code</a></li><li><a href=#c-destructors>C++ Destructors</a></li><li><a href=#our-goal>Our Goal</a></li></ul></li></ul><ul><li><a href=#automatic>Automatic</a><ul><li><a href=#stacking-dtors>Stacking Dtors</a></li></ul></li><li><a href=#implicit>Implicit</a><ul><li><a href=#decorators>Decorators</a></li><li><a href=#import-hacks>Import Hacks</a></li><li><a href=#class-boilerplate>Class Boilerplate</a></li></ul></li><li><a href=#composable>Composable</a><ul><li><a href=#descriptors>Descriptors</a></li><li><a href=#annotations>Annotations</a></li></ul></li><li><a href=#wrapping-up>Wrapping Up</a><ul><li><a href=#but>But&mldr;</a></li></ul></li><li><a href=#further-reading>Further Reading</a></li></ul></nav></div></details></div><div class=post-content><p><em>Writeup of my talk about the <a href=https://github.com/tmr232/cpppy>cpppy library</a></em></p><p>A few years ago I <a href="https://www.youtube.com/watch?v=U74sqQGqZzk">gave a talk</a> about implementing C++ semantics (namely, destructors) in Python.
After giving the talk, I published my <a href=https://github.com/tmr232/talks/tree/main/CoreCpp2021>speaker notes and slides</a>, to make it as accessible as possible, even to people who don&rsquo;t wanna watch a video.
I was quite pleased with myself, until a few weeks ago when I wanted to look up a detail so that I can reference it in a new blogpost.
I went to the speaker notes, started reading, and oh. Oh no.
I could get through it, but it really doesn&rsquo;t hold up on its own despite my memory of it being &ldquo;everything I said during the talk&rdquo;.
That&rsquo;s quite unfortunate, as I am very pleased with the work I done for this talk, and want people to happen upon it.
Which brings us here - this is that talk, but as a blogpost.</p><h2 id=but-why><a href=#but-why>But Why?<span hidden class=anchor aria-hidden=true href=#but-why>#</span></a></h2><p>When coming to implement C++ semantics in Python, the first question we need to ask ourselves is &ldquo;why?&rdquo;.
Why would we want to take anything (other than performance) from C++ into Python?
After all, C++ is a low-level language, mostly &ldquo;expert oriented&rdquo;, and is slowly becoming more &ldquo;Pythonic&rdquo;.
And on the other hand, Python is a high-level language, it is beginner friendly, and has far fewer footguns than C++.</p><p>The answer to that question is resource-management.
In C++, all resources are handled the same way.
Be it allocated memory; a file; a lock; or your own resource - they are all handled using the same mechanism.
In Python, on the other hand, different resources are handled differently.
While memory is managed for you by the garbage collector, all other resources must be managed by the programmer.</p><p>Before you say anything - no.
Python is not C.
We don&rsquo;t have to call the cleanup functions manually.
Instead, Python gives us context managers.</p><h3 id=context-managers><a href=#context-managers>Context Managers<span hidden class=anchor aria-hidden=true href=#context-managers>#</span></a></h3><p>Context-managers are relatively straight-forward.
To use them, we use the <code>with</code> statement as follows:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>with</span> FileReader(path) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>    print(f<span style=color:#f92672>.</span>read())
</span></span></code></pre></td></tr></table></div></div><p>Then, the language uses our <code>FileReader</code> object to wrap the indented block, roughly as follows:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>_tmp <span style=color:#f92672>=</span> FileReader(path)
</span></span><span style=display:flex><span>f <span style=color:#f92672>=</span> _tmp<span style=color:#f92672>.</span>__enter__()
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>	print(f<span style=color:#f92672>.</span>read())
</span></span><span style=display:flex><span><span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> _tmp<span style=color:#f92672>.</span>__exit__(<span style=color:#f92672>&lt;</span>exception info<span style=color:#f92672>&gt;</span>):
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>raise</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>finally</span>:
</span></span><span style=display:flex><span>	_tmp<span style=color:#f92672>.</span>__exit__(<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>None</span> exception info<span style=color:#f92672>&gt;</span>)
</span></span></code></pre></td></tr></table></div></div><p>Before entering the indented block, we create our <code>FileReader</code> and call its <code>__enter__</code> method.
Then, we run the contents of the block.
Then, on leaving the block, we call <code>__exit__</code>.
If an exception was raised from the block, we&rsquo;ll get the exception info and have a choice to either silence it (by returning a <code>True</code> value) or re-raise it (by returning <code>False</code>).
If no exception was raised - we&rsquo;ll get get no exception information.</p><p>To define a context manager, all we have to do is add an <code>__enter__</code> method and an <code>__exit__</code> method to our class:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FileReader</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __enter__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __exit__(self, exc_type, exc_val, exc_tb):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=real-code><a href=#real-code>Real Code<span hidden class=anchor aria-hidden=true href=#real-code>#</span></a></h3><p>This is well and nice, but let&rsquo;s look at some real code, a redacted version of something we had running in production:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ArchiveReader</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, path: str):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>data <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> ZipFile(path) <span style=color:#66d9ef>as</span> zipfile:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> name <span style=color:#f92672>in</span> zipfile<span style=color:#f92672>.</span>namelist():
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>with</span> zipfile<span style=color:#f92672>.</span>open(name) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>                    self<span style=color:#f92672>.</span>data[name] <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>read()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read</span>(self, name):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>data[name]
</span></span></code></pre></td></tr></table></div></div><p>We had a zip file containing many small files.
So to make reading fast and simple, we read <em>all</em> the files into memory when initializing the reader.
Then, when we needed a specific file - we just accessed it in the <code>data</code> dict.
This way we only unzip once, which was a significant performance gain.</p><p>The usage of the class was also very straightforward:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>reader <span style=color:#f92672>=</span> ArchiveReader(<span style=color:#e6db74>&#34;corecpp.zip&#34;</span>)
</span></span><span style=display:flex><span>print(reader<span style=color:#f92672>.</span>read(<span style=color:#e6db74>&#34;2021&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Prints:</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Hello, CoreC++!</span>
</span></span></code></pre></td></tr></table></div></div><p>We were fairly pleased.</p><p>But, as time went by, we ran into issues.
The data files we were reading changed from being tiny (&lt;10MiB) to huge (>5GiB).
As a result, we could no longer keep the files unzipped in memory.</p><p>The &ldquo;easy&rdquo; solution would keep the path, and open the zip file whenever we read a file, unzipping only the desired file.
This works, but due to the need to parse zip metadata, it adds a significant overhead in execution time.</p><p>The solution we went with was to create the <code>ZipFile</code> object (thus parsing the metadata) and hold it in our <code>ArchiveReader</code> class.
Then, when we read a file, we open and unzip only the said file:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BigArchiveReader</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, path: str):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>zipfile <span style=color:#f92672>=</span> ZipFile(path)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read</span>(self, name: str):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> self<span style=color:#f92672>.</span>zipfile<span style=color:#f92672>.</span>open(name) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> f<span style=color:#f92672>.</span>read()
</span></span></code></pre></td></tr></table></div></div><p>Unfortunately, now that we hold a <code>ZipFile</code> object, we need to manage it.
To do that, we had to make our archive reader a context-manager:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BigArchiveReader</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __enter__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __exit__(self, exc_type, exc_val, exc_tb):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>zipfile<span style=color:#f92672>.</span>close()
</span></span></code></pre></td></tr></table></div></div><p>Which, in turn, changes the usage of our reader:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>with</span> BigArchiveReader(<span style=color:#e6db74>&#34;corecpp.zip&#34;</span>) <span style=color:#66d9ef>as</span> big_reader:
</span></span><span style=display:flex><span>	print(big_reader<span style=color:#f92672>.</span>read(<span style=color:#e6db74>&#34;2021&#34;</span>))
</span></span></code></pre></td></tr></table></div></div><p>In turn, this demonstrates a bigger issue.
Holding a context manager as a member changes the interface of our objects, forcing them to be context managers as well.
This change propagates up to all respective owners, and up the stack to the point where the top-level object is created.
As this is a breaking change, we must be able to change the code that uses our object.
In the general case, this is not possible.</p><h3 id=c-destructors><a href=#c-destructors>C++ Destructors<span hidden class=anchor aria-hidden=true href=#c-destructors>#</span></a></h3><p>C++, however, has a solution to those issues - destructors.
Destructors are what makes C++ resource management work, and they have 3 key properties we&rsquo;re interested in.
They are:</p><ol><li>Automatic</li><li>Composable</li><li>Implicit.</li></ol><h4 id=automatic-invocation><a href=#automatic-invocation>Automatic Invocation<span hidden class=anchor aria-hidden=true href=#automatic-invocation>#</span></a></h4><p>The invocation of a destructor is automatic.
When we leave a scope, they are called automatically, no matter how we leave the scope.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>auto</span> reader <span style=color:#f92672>=</span> FileReader(path);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>cout <span style=color:#f92672>&lt;&lt;</span> reader.read() <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;\n&#39;</span>;
</span></span><span style=display:flex><span>} <span style=color:#75715e>// &lt;-- The destructor is called here!
</span></span></span></code></pre></td></tr></table></div></div><h4 id=seamless-composition><a href=#seamless-composition>Seamless Composition<span hidden class=anchor aria-hidden=true href=#seamless-composition>#</span></a></h4><p>Destructors of member fields are called automatically, making composition easier.
If we add a new member, we know that it&rsquo;s destructor will be called when it is needed.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ArchiveReader</span> {
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>auto</span> reader <span style=color:#f92672>=</span> ArchiveReader(path);
</span></span><span style=display:flex><span>} <span style=color:#75715e>// &lt;-- Destructor is called!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>//         ~ArchiveReader();
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BigArchiveReader</span> {
</span></span><span style=display:flex><span>    ZipFile zipfile;
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>auto</span> big_reader <span style=color:#f92672>=</span> BigArchiveReader(path);
</span></span><span style=display:flex><span>} <span style=color:#75715e>// &lt;-- Destructor is called!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>//         ~BigArchiveReader();
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>//     Followed by member destructor:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>//         ~ZipFile();
</span></span></span></code></pre></td></tr></table></div></div><h4 id=implicit-interfaces><a href=#implicit-interfaces>Implicit Interfaces<span hidden class=anchor aria-hidden=true href=#implicit-interfaces>#</span></a></h4><p>Last but not least - destructors are implicit in object interfaces.
Objects with user defined destructors and objects without them are all used the same way.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#75715e>// Object with no destructor
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>auto</span> object <span style=color:#f92672>=</span> ObjectWithoutDtor();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Object with destructor
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>auto</span> object <span style=color:#f92672>=</span> ObjectWithDtor();
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>This is even if we don&rsquo;t define them, they always exist, for all objects.
This means that when we write our own destructors, our interfaces don&rsquo;t change, and no change is propagated.</p><h3 id=our-goal><a href=#our-goal>Our Goal<span hidden class=anchor aria-hidden=true href=#our-goal>#</span></a></h3><p>With that in mind, we want to bring destructors from C++ to Python.
Converting our archive reader from this (11 lines of code, 4 are dedicated to resource management):</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BigArchiveReader</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, path: str):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>zipfile <span style=color:#f92672>=</span> ZipFile(path)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read</span>(self, name: str):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> self<span style=color:#f92672>.</span>zipfile<span style=color:#f92672>.</span>open(name) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> f<span style=color:#f92672>.</span>read()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __enter__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __exit__(self, exc_type, exc_val, exc_tb):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>zipfile<span style=color:#f92672>.</span>close()
</span></span></code></pre></td></tr></table></div></div><p>To this (7 lines of code, 0 dedicated to resource management):</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BestArchiveReader</span>:
</span></span><span style=display:flex><span>    zipfile: ZipFile
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, path: str):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>zipfile <span style=color:#f92672>=</span> ZipFile(path)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read</span>(self, name: str):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> self<span style=color:#f92672>.</span>zipfile<span style=color:#f92672>.</span>open(name) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> f<span style=color:#f92672>.</span>read()
</span></span></code></pre></td></tr></table></div></div><p>And ensure that our usage remains the same as the original <code>ArchiveReader</code>, with no context-managers and no interface pollution:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>reader <span style=color:#f92672>=</span> BestArchiveReader(<span style=color:#e6db74>&#34;corecpp.zip&#34;</span>)
</span></span><span style=display:flex><span>print(reader<span style=color:#f92672>.</span>read(<span style=color:#e6db74>&#34;2021&#34;</span>))
</span></span></code></pre></td></tr></table></div></div><h4 id=dont-try-this-at-work><a href=#dont-try-this-at-work>Don&rsquo;t Try This At Work<span hidden class=anchor aria-hidden=true href=#dont-try-this-at-work>#</span></a></h4><p>Seriously, just don&rsquo;t.</p><p>It&rsquo;s all fun, and standard, and truly painful in a code review or debugging session.</p><p>With that in mind, let&rsquo;s start!</p><h1 id=implementing-c-destructors-in-python><a href=#implementing-c-destructors-in-python>Implementing C++ Destructors in Python<span hidden class=anchor aria-hidden=true href=#implementing-c-destructors-in-python>#</span></a></h1><h2 id=automatic><a href=#automatic>Automatic<span hidden class=anchor aria-hidden=true href=#automatic>#</span></a></h2><p>Since our target class is a bit complicated, we&rsquo;ll be joined in our implementation
journey by a simple class called <code>Greeter</code>.
The greeter is a simple class.
It takes a name on construction, and says &ldquo;Hello&rdquo;.
On destruction, it says &ldquo;Goodbye&rdquo;</p><p>This will allow us to keep track of ctors and dtors as we progress through this post.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Greeter</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Hello, </span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>!&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>close</span>(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Goodbye, </span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>.&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    greeter <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;We have a greeter!&#34;</span>)
</span></span><span style=display:flex><span>    greeter<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>main()
</span></span></code></pre></td></tr></table></div></div><pre tabindex=0><code>Hello, 1!
We have a greeter!
Goodbye, 1.
</code></pre><p>Our first implementation is as straight-forward as can be.
With a constructor and a &ldquo;close&rdquo; method to act like our dtor.</p><p>The next step is pretty straight-forward.
Since Python already provides us with context-manages and the <code>with</code> statement, we&rsquo;ll use them and see where it gets us.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Greeter</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Hello, </span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>!&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __enter__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __exit__(self, exc_type, exc_val, exc_tb):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Goodbye, </span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>.&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> Greeter(<span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;We have a greeter!&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>main()
</span></span></code></pre></td></tr></table></div></div><pre tabindex=0><code>Hello, 1!
We have a greeter!
Goodbye, 1.
</code></pre><h3 id=stacking-dtors><a href=#stacking-dtors>Stacking Dtors<span hidden class=anchor aria-hidden=true href=#stacking-dtors>#</span></a></h3><p>What if we want more than one <code>Greeter</code>? No problem!
Just stack the context-managers!</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> Greeter(<span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;First&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> Greeter(<span style=color:#ae81ff>2</span>):
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#34;Second&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>main()
</span></span></code></pre></td></tr></table></div></div><pre tabindex=0><code>Hello, 1!
First
Hello, 2!
Second
Goodbye, 2.
Goodbye, 1.
</code></pre><p>Then again, this type of nesting can get unwieldy quick.
We need something better.</p><p>Since we&rsquo;re already stacking context-managers, we can use a proper stack:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DtorScope</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>stack <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __enter__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __exit__(self, exc_type, exc_val, exc_tb):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> self<span style=color:#f92672>.</span>stack:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>stack<span style=color:#f92672>.</span>pop()<span style=color:#f92672>.</span>__exit__(exc_type, exc_val, exc_tb)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>push</span>(self, cm):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>stack<span style=color:#f92672>.</span>append(cm)
</span></span></code></pre></td></tr></table></div></div><p>The <code>DtorScope</code> will hold all of our <code>Greeter</code> objects in place, then call their <code>__exit__</code> methods when we leave the <code>with</code> context:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> DtorScope() <span style=color:#66d9ef>as</span> dtor_stack:
</span></span><span style=display:flex><span>        greeter1 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        dtor_stack<span style=color:#f92672>.</span>push(greeter1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        greeter2 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>        dtor_stack<span style=color:#f92672>.</span>push(greeter2)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>main()
</span></span></code></pre></td></tr></table></div></div><pre tabindex=0><code>Hello, 1!
Hello, 2!
Goodbye, 2.
Goodbye, 1.
</code></pre><p>And with that, we&rsquo;ve rid ourselves of the nesting issue.
It works, destruction is automatic, it&rsquo;s fairly straight-forward, and all too explicit.</p><h2 id=implicit><a href=#implicit>Implicit<span hidden class=anchor aria-hidden=true href=#implicit>#</span></a></h2><p>Now that our destructors get called automatically on scope exit, we want to
make sure that we don&rsquo;t need to write any code to make it happen.</p><p>If we could, we&rsquo;d like our function to look like this:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    greeter1 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    greeter2 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>2</span>)
</span></span></code></pre></td></tr></table></div></div><p>And have it implicitly do all the plumbing we managed earlier.</p><p>First, since we always want to push our objects onto the dtor stack, let&rsquo;s
make it part of their construction.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Greeter</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name, dtor_stack):
</span></span><span style=display:flex><span>        dtor_stack<span style=color:#f92672>.</span>push(self)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Hello, </span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>!&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __enter__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __exit__(self, exc_type, exc_val, exc_tb):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Goodbye, </span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>.&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> DtorScope() <span style=color:#66d9ef>as</span> dtor_stack:
</span></span><span style=display:flex><span>        greeter1 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>1</span>, dtor_stack)
</span></span><span style=display:flex><span>        greeter2 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>2</span>, dtor_stack)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>main()
</span></span></code></pre></td></tr></table></div></div><p>That&rsquo;s a good start.
We can no longer forget to push our greeters onto the <code>DtorScope</code>, and we saved a couple of lines.</p><p>That said, we&rsquo;re explicitly repeating and passing around a construct that should be implicit.</p><p>To pass the <code>dtor_stack</code> implicitly to the <code>Greeter</code> class, we need to store it <em>somewhere</em>.
In our case, we&rsquo;ll use a global variable!
And just like function calls go into a stack so that we know where to return, so will our <code>DtorScope</code>s.
So instead of a single global variable, we&rsquo;ll have to use a global stack.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>_dtor_stack <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_dtor_stack</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> _dtor_stack
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DtorScope</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>stack <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#75715e># Push current scope onto global scope stack</span>
</span></span><span style=display:flex><span>        get_dtor_stack()<span style=color:#f92672>.</span>append(self)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __enter__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __exit__(self, exc_type, exc_val, exc_tb):
</span></span><span style=display:flex><span>	    <span style=color:#75715e># Pop current scope from global scope stack</span>
</span></span><span style=display:flex><span>        get_dtor_stack()<span style=color:#f92672>.</span>pop()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> self<span style=color:#f92672>.</span>stack:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>stack<span style=color:#f92672>.</span>pop()<span style=color:#f92672>.</span>__exit__(exc_type, exc_val, exc_tb)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>push</span>(self, cm):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>stack<span style=color:#f92672>.</span>append(cm)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>push_dtor</span>(cm):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> get_dtor_stack()[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]<span style=color:#f92672>.</span>push(cm)
</span></span></code></pre></td></tr></table></div></div><p>This is the same as our previous dtor-scope, but now we keep a global stack of scopes.
This allows us to always tell which dtor-stack to push our instances into without naming the stack.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Greeter</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, name):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Hello, </span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>!&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Push the greeter onto the current dtor-scope</span>
</span></span><span style=display:flex><span>        push_dtor(self)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __enter__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __exit__(self, exc_type, exc_val, exc_tb):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Goodbye, </span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>.&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> DtorScope():
</span></span><span style=display:flex><span>        greeter1 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        greeter2 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>main()
</span></span></code></pre></td></tr></table></div></div><p>Much better, but we still need to explicitly create the scope inside every function.</p><h3 id=decorators><a href=#decorators>Decorators<span hidden class=anchor aria-hidden=true href=#decorators>#</span></a></h3><p>However, since the dtor scoping mechanism has nothing to do with the function itself, we can use it at the callsite instead of inside the function, and it&rsquo;d work exactly the same.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    greeter1 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    greeter2 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> DtorScope():
</span></span><span style=display:flex><span>    main()
</span></span></code></pre></td></tr></table></div></div><p>This will have to be done on <em>every</em> callsite, so we add a utility function
to help with that.</p><p>The <code>*args, **kwargs</code> syntax is there to pass along any and all function arguments unchanged. Think of it as Python&rsquo;s version of perfect-forwarding.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>call</span>(f, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> DtorScope():
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> f(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>call(main)
</span></span></code></pre></td></tr></table></div></div><p>Alternatively, we can take the function and return a closure that includes the scoping.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>cpp_function</span>(f):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_wrapper</span>(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> DtorScope():
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> f(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> _wrapper
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>scoped_main <span style=color:#f92672>=</span> cpp_function(main)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>scoped_main()
</span></span></code></pre></td></tr></table></div></div><p>Inside <code>_wrapper</code> we capture <code>f</code> from the parent scope.
As Python is reference-based, we don&rsquo;t need to specify how to capture.</p><p>Next, since Python is dynamic, we can replace the original <code>main</code> function with the scoped one.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    greeter1 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    greeter2 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>main <span style=color:#f92672>=</span> cpp_function(main)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>main()
</span></span></code></pre></td></tr></table></div></div><p>Here the wrapper holds the previous version of the function, while the name <code>main</code> is bound to the wrapped version.</p><p>In Python, wrapping a function and replacing its original is a common operation.
Because of that, we have some syntactic sugar called &ldquo;decorators&rdquo;.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@cpp_function</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    greeter1 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    greeter2 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>main()
</span></span></code></pre></td></tr></table></div></div><p>This is functionally equivalent to the previous snippet, but is cleaner and more expressive.
And with that, the <em>inside</em> of <code>main</code> looks the way we want it.</p><h3 id=import-hacks><a href=#import-hacks>Import Hacks<span hidden class=anchor aria-hidden=true href=#import-hacks>#</span></a></h3><p>We still have a problem, though.
Even if <code>main</code> looks nice, we had to decorate it with <code>cpp_function</code>.
Having to do that to every function we write for it to work is not very &ldquo;implicit&rdquo;, is it?</p><p>What if instead, we could just write <code>from cpp import magic</code>, and have that &ldquo;magic&rdquo; decorate our functions for us?</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> cpp <span style=color:#f92672>import</span> magic
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    greeter1 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    greeter2 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>2</span>)
</span></span></code></pre></td></tr></table></div></div><p>Nice, isn&rsquo;t it? So let&rsquo;s get to it!</p><h4 id=the-magic-function><a href=#the-magic-function>The Magic Function<span hidden class=anchor aria-hidden=true href=#the-magic-function>#</span></a></h4><p>As a first step, we&rsquo;ll call a function at the end of our module to decorate everything:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> cpp <span style=color:#f92672>import</span> magic
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> greeter <span style=color:#f92672>import</span> Greeter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    greeter1 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    greeter2 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>magic()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>main()
</span></span></code></pre></td></tr></table></div></div><p>Our <code>magic()</code> function needs to do 2 things:</p><ul><li>Get the module it was called in;</li><li>and decorate all the functions.</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>magic</span>():
</span></span><span style=display:flex><span>    calling_module <span style=color:#f92672>=</span> get_calling_module()
</span></span><span style=display:flex><span>    decorate_module_functions(calling_module)
</span></span></code></pre></td></tr></table></div></div><p>To get the calling module, we use <code>inspect.stack</code> to traverse the callstack and find the right module</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> inspect
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_calling_module</span>():
</span></span><span style=display:flex><span>    <span style=color:#75715e># Use 2 here because we need to go 2 frames up.</span>
</span></span><span style=display:flex><span>    stack_frame <span style=color:#f92672>=</span> inspect<span style=color:#f92672>.</span>stack()[<span style=color:#ae81ff>2</span>]<span style=color:#f92672>.</span>frame
</span></span><span style=display:flex><span>    module <span style=color:#f92672>=</span> inspect<span style=color:#f92672>.</span>getmodule(stack_frame)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> module
</span></span></code></pre></td></tr></table></div></div><p>We get the callstack, take the frame 2 level above us (the caller to <code>magic()</code>), and use <code>inspect.getmodule</code> to get the relevant module.</p><p>Then we decorate our functions.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>decorate_module_functions</span>(module):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> name, value <span style=color:#f92672>in</span> inspect<span style=color:#f92672>.</span>getmembers(module):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> inspect<span style=color:#f92672>.</span>isroutine(value):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Only convert functions that were defined in the importing file.</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># We don&#39;t want to convert library imports and the likes of those.</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> inspect<span style=color:#f92672>.</span>getmodule(value) <span style=color:#f92672>!=</span> module:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        setattr(module, name, cpp_function(value))
</span></span></code></pre></td></tr></table></div></div><p>Our function takes a module and modifies it.</p><p>To do this, we&rsquo;re using some of Python&rsquo;s reflection capabilities.
<code>inspect.getmembers(obj)</code> returns all the member variables of a given object.
In our case - a module.
<code>inspect.isroutine(obj)</code> tells us whether a value is a function.
<code>inspect.getmodule(obj)</code> returns the module an object was defined in.
<code>setattr(obj, name, value)</code> sets an object attribute named <code>name</code> to <code>value</code>.</p><p>And with that our <code>magic()</code> function is operational!</p><p>For our next trick, we&rsquo;ll make the call to magic() disappear as well.
This means that we need to somehow make the <code>from cpp import magic</code> line
do the actual magic.</p><p>&ldquo;But Tamir! An import is not a function call!&rdquo; you might say.
Well, let&rsquo;s see what a Python import actually does.</p><h4 id=import-internals><a href=#import-internals>Import Internals<span hidden class=anchor aria-hidden=true href=#import-internals>#</span></a></h4><p>When we run <code>from cpp import magic</code> we go through the following steps.</p><p><img src=python-import-mechanism.png alt="Diagram outlining Python&amp;rsquo;s import mechanism, as described below."></p><p>First, we look for a module named <code>cpp</code> in the global module cache,
<code>sys.modules</code>.
If it is present, the module is already loaded, and we can skip to name binding.</p><p>If it is not present in the cache, we find it on disk, create a module object from it, place the module object in the cache, and then execute the module.</p><p>Note that we first store it in the cache, and only then execute the module.
This is important as Python allows for cyclic imports, and we want to avoid recursion.
It will also come in handy later.</p><p>Once we finish executing the module, we need to bind the relevant names.
In this case - <code>magic</code>.</p><p>Python takes the <code>cpp</code> module from <code>sys.modules</code> and looks for <code>magic</code>
inside it.
If it finds it, it binds that to the name <code>magic</code>.</p><p>Lastly, Python modules may define a <code>__getattr__(name)</code> function.
If it is defined, it is called whenever we try to import a name that isn&rsquo;t present in the module.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>magic <span style=color:#f92672>=</span> cpp<span style=color:#f92672>.</span>__getattr__(<span style=color:#e6db74>&#34;magic&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><p>So, as you can see - <code>import</code> <em>can</em> be a function call!</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_magic</span>():
</span></span><span style=display:flex><span>    calling_module <span style=color:#f92672>=</span> get_calling_module()
</span></span><span style=display:flex><span>    decorate_module_functions(calling_module)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> __getattr__(name):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> name <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;magic&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>AttributeError</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    _magic()
</span></span></code></pre></td></tr></table></div></div><p>This converts the import to a call and allows C++ to work it&rsquo;s magic.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> cpp <span style=color:#f92672>import</span> magic
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> greeter <span style=color:#f92672>import</span> Greeter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    greeter1 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    greeter2 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>main()
</span></span></code></pre></td></tr></table></div></div><p>Well, almost&mldr;</p><p>You see, since we&rsquo;re imported on the first line of the module, the module is empty.
The functions we want to decorate are not yet defined.
To fix this, we can do one of two things.</p><p>The first option is to import our magic at the end of the file</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> greeter <span style=color:#f92672>import</span> Greeter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    greeter1 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    greeter2 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> cpp <span style=color:#f92672>import</span> magic
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>main()
</span></span></code></pre></td></tr></table></div></div><p>This works, but feels far from magical.</p><p>The other option, then, is to import the modules ourselves!
With the fully imported module at hand, we can modify it as we wish.</p><h4 id=import-cycles><a href=#import-cycles>Import Cycles<span hidden class=anchor aria-hidden=true href=#import-cycles>#</span></a></h4><p>This means that our <code>_magic()</code> function is going to change a little:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> importlib.util
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>import_by_path</span>(name: str, path: str):
</span></span><span style=display:flex><span>    spec <span style=color:#f92672>=</span> importlib<span style=color:#f92672>.</span>util<span style=color:#f92672>.</span>spec_from_file_location(name, path)
</span></span><span style=display:flex><span>    module <span style=color:#f92672>=</span> importlib<span style=color:#f92672>.</span>util<span style=color:#f92672>.</span>module_from_spec(spec)
</span></span><span style=display:flex><span>    sys<span style=color:#f92672>.</span>modules[name] <span style=color:#f92672>=</span> module
</span></span><span style=display:flex><span>    spec<span style=color:#f92672>.</span>loader<span style=color:#f92672>.</span>exec_module(module)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> module
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_magic</span>():
</span></span><span style=display:flex><span>    calling_module <span style=color:#f92672>=</span> get_calling_module()
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> calling_module<span style=color:#f92672>.</span>__name__
</span></span><span style=display:flex><span>    path <span style=color:#f92672>=</span> calling_module<span style=color:#f92672>.</span>__file__
</span></span><span style=display:flex><span>    imported_module <span style=color:#f92672>=</span> import_by_path(name, path)
</span></span><span style=display:flex><span>    decorate_module_functions(imported_module)
</span></span></code></pre></td></tr></table></div></div><p>Using Python&rsquo;s import mechanisms, we import another instance of the
module that imported us.</p><p>We use it&rsquo;s name and path to import it again, then store it in the
global module cache instead of the original.</p><p>This is where the fact that the cache is filled <em>prior</em> to module execution
comes in handy!</p><p>We execute the module, to define all the types,
and then decorate the functions.</p><p>With this change, we can now write the import at the top again:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> cpp <span style=color:#f92672>import</span> magic
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> greeter <span style=color:#f92672>import</span> Greeter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    greeter1 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    greeter2 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>main()
</span></span></code></pre></td></tr></table></div></div><p>And recurse infinitely.</p><p>Our module runs the <code>magic()</code> function.
The <code>magic()</code> function imports our module.
The module runs the <code>magic()</code> function.
The <code>magic()</code> function imports our module.</p><p>And so on and so forth.</p><p>To fix that, we add a flag to all the modules we import, before executing them.
Then, in our <code>magic()</code> function, we check for the flag.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>IMPORT_FLAG <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;__magically_imported__&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>import_by_path</span>(name: str, path: str):
</span></span><span style=display:flex><span>    spec <span style=color:#f92672>=</span> importlib<span style=color:#f92672>.</span>util<span style=color:#f92672>.</span>spec_from_file_location(name, path)
</span></span><span style=display:flex><span>    module <span style=color:#f92672>=</span> importlib<span style=color:#f92672>.</span>util<span style=color:#f92672>.</span>module_from_spec(spec)
</span></span><span style=display:flex><span>    sys<span style=color:#f92672>.</span>modules[name] <span style=color:#f92672>=</span> module
</span></span><span style=display:flex><span>    setattr(module, IMPORT_FLAG, <span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    spec<span style=color:#f92672>.</span>loader<span style=color:#f92672>.</span>exec_module(module)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> module
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_magic</span>():
</span></span><span style=display:flex><span>    calling_module <span style=color:#f92672>=</span> get_calling_module()
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> calling_module<span style=color:#f92672>.</span>__name__
</span></span><span style=display:flex><span>    path <span style=color:#f92672>=</span> calling_module<span style=color:#f92672>.</span>__file__
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> hasattr(calling_module, IMPORT_FLAG):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    imported_module <span style=color:#f92672>=</span> import_by_path(name, path)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    decorate_module_functions(imported_module)
</span></span></code></pre></td></tr></table></div></div><p>This breaks the recursion, but we still have an issue.</p><p>Once we finish all of our import magic, we return to the module that triggered the magic.
This module has not yet been modified.
Once we return to it, it&rsquo;ll run to completion.
In the case of our main module - <code>main()</code> will run twice.
First, when we import it inside <code>magic()</code>.
Second, when we return to the main module and let it execute.
In both cases, we&rsquo;ll be running the non-decorated version.
This is not at all what we want.</p><p>To avoid this sort of thing, Python code usually uses the following:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    main()
</span></span></code></pre></td></tr></table></div></div><p><code>__name__</code> always holds the name of the current module.
In the case of the main module, it&rsquo;ll be <code>"__main__"</code>.</p><p>This ensures that when a module is imported (and used as a library) it will not run the <code>main()</code> function.</p><p>In our case, this will not be enough.
First, we actually do import the module.
Second, we need to ensure that once we&rsquo;re done, the original doesn&rsquo;t run.</p><p>So once again, we modify our magic function!</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_magic</span>():
</span></span><span style=display:flex><span>    calling_module <span style=color:#f92672>=</span> get_calling_module()
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> calling_module<span style=color:#f92672>.</span>__name__
</span></span><span style=display:flex><span>    path <span style=color:#f92672>=</span> calling_module<span style=color:#f92672>.</span>__file__
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> hasattr(calling_module, IMPORT_FLAG):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    imported_module <span style=color:#f92672>=</span> import_by_path(name, path)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    decorate_module_functions(imported_module)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> imported_module<span style=color:#f92672>.</span>__name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>        sys<span style=color:#f92672>.</span>exit(imported_module<span style=color:#f92672>.</span>main())
</span></span></code></pre></td></tr></table></div></div><p>Instead of <em>preventing</em> <code>main()</code> from running, we call it explicitly.
That means that, like in C++ code, we don&rsquo;t need to call <code>main()</code> explicitly in our code.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> cpp <span style=color:#f92672>import</span> magic
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> greeter <span style=color:#f92672>import</span> Greeter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    greeter1 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    greeter2 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>2</span>)
</span></span></code></pre></td></tr></table></div></div><p>When we&rsquo;re done, we call <code>sys.exit</code> to terminate the process, and never actually reach the module that initially imported us.</p><h3 id=class-boilerplate><a href=#class-boilerplate>Class Boilerplate<span hidden class=anchor aria-hidden=true href=#class-boilerplate>#</span></a></h3><p>Another thing we want to address is the code inside our <code>Greeter</code>.
We are currently writing a lot of boilerplate there.
We have the <code>__enter__</code> method, the unused <code>__exit__</code> arguments, and pushing
the instance into the dtor stack.</p><p>With a bit of inheritance, we can move all that boilerplate out of <code>Greeter</code>.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> cpp <span style=color:#f92672>import</span> magic
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CppClass</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        push_dtor(self)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ctor <span style=color:#f92672>=</span> getattr(self, self<span style=color:#f92672>.</span>__class__<span style=color:#f92672>.</span>__name__, <span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ctor:
</span></span><span style=display:flex><span>            ctor(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __enter__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __exit__(self, exc_type, exc_val, exc_tb):
</span></span><span style=display:flex><span>        dtor <span style=color:#f92672>=</span> getattr(self, <span style=color:#e6db74>&#34;_&#34;</span> <span style=color:#f92672>+</span> self<span style=color:#f92672>.</span>__class__<span style=color:#f92672>.</span>__name__, <span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> dtor:
</span></span><span style=display:flex><span>            dtor()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Greeter</span>(CppClass):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>Greeter</span>(self, name):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Hello, </span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>!&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_Greeter</span>(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Goodbye, </span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>.&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    greeter1 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    greeter2 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>2</span>)
</span></span></code></pre></td></tr></table></div></div><p>That&rsquo;s great.
Now as we add more classes, we don&rsquo;t need to handle all that annoying dtor-stack stuff.
As a bonus - our constructor is now named <code>Greeter</code>, as it would be in C++; and our destructor is <code>_Greeter</code>, as <code>~</code> is not valid in Python identifiers.</p><p>But&mldr; We&rsquo;re still missing something.
We decorated all free functions with <code>cpp_function</code>, but we still need to decorate all of our member functions.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>decorate_object_methods</span>(obj):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> name, value <span style=color:#f92672>in</span> inspect<span style=color:#f92672>.</span>getmembers(obj):
</span></span><span style=display:flex><span>        <span style=color:#75715e># Ignore magic methods</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> name<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#34;__&#34;</span>):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> inspect<span style=color:#f92672>.</span>isroutine(value):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        setattr(self, name, cpp_function(value))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CppClass</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        push_dtor(self)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        decorate_object_methods(self)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ctor <span style=color:#f92672>=</span> getattr(self, self<span style=color:#f92672>.</span>__class__<span style=color:#f92672>.</span>__name__, <span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ctor:
</span></span><span style=display:flex><span>            ctor(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __enter__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __exit__(self, exc_type, exc_val, exc_tb):
</span></span><span style=display:flex><span>        dtor <span style=color:#f92672>=</span> getattr(self, <span style=color:#e6db74>&#34;_&#34;</span> <span style=color:#f92672>+</span> self<span style=color:#f92672>.</span>__class__<span style=color:#f92672>.</span>__name__, <span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> dtor:
</span></span><span style=display:flex><span>            dtor()
</span></span></code></pre></td></tr></table></div></div><p>This is similar to what we did with the modules, but this time we check for magic methods, as we don&rsquo;t wanna decorate them.</p><p>Last but not least - we want to make it truly implicit.</p><p>Currently, we use inheritance explicitly to extend our <code>Greeter</code> class with the <code>CppClass</code> methods.
In essence, we&rsquo;re injecting 3 methods into our <code>Greeter</code> class - <code>__init__</code>, <code>__enter__</code>, and <code>__exit__</code>.
We&rsquo;re using inheritance, but we can use a decorator just as well.
We take the class, make the relevant modifications, then return the modified version.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>cpp_class</span>(cls):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __enter__(self):
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __exit__(self, exc_type, exc_val, exc_tb):
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    cls<span style=color:#f92672>.</span>__init__ <span style=color:#f92672>=</span> __init__
</span></span><span style=display:flex><span>    cls<span style=color:#f92672>.</span>__enter__ <span style=color:#f92672>=</span> __enter__
</span></span><span style=display:flex><span>    cls<span style=color:#f92672>.</span>__exit__ <span style=color:#f92672>=</span> __exit__
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> cls
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@cpp_class</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Greeter</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span></code></pre></td></tr></table></div></div><p>This might look a bit funky, but it integrates well with our previous work decorating all free functions.</p><p>A few extra touches are moving the method decoration out of the <code>__init__</code> method, so that it only happens once; and adding a <code>__cpp_class__</code> attribute so that our code can tell it&rsquo;s actually a C++-style class.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>cpp_class</span>(cls):
</span></span><span style=display:flex><span>    decorate_object_methods(cls)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __enter__(self):
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __exit__(self, exc_type, exc_val, exc_tb):
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    cls<span style=color:#f92672>.</span>__init__ <span style=color:#f92672>=</span> __init__
</span></span><span style=display:flex><span>    cls<span style=color:#f92672>.</span>__enter__ <span style=color:#f92672>=</span> __enter__
</span></span><span style=display:flex><span>    cls<span style=color:#f92672>.</span>__exit__ <span style=color:#f92672>=</span> __exit__
</span></span><span style=display:flex><span>    cls<span style=color:#f92672>.</span>__cpp_class__ <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> cls
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@cpp_class</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Greeter</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span></code></pre></td></tr></table></div></div><p>Lastly, we modify <code>_magic</code> to decorate classes as well:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>decorate_module_classes</span>(module):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> name, value <span style=color:#f92672>in</span> inspect<span style=color:#f92672>.</span>getmembers(module):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> inspect<span style=color:#f92672>.</span>isclass(value):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Only convert functions that were defined in the importing file.</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># We don&#39;t want to convert library imports and the likes of those.</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> inspect<span style=color:#f92672>.</span>getmodule(value) <span style=color:#f92672>!=</span> module:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        setattr(module, name, cpp_class(value))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_magic</span>():
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    decorate_module_classes(module)
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span></code></pre></td></tr></table></div></div><p>And with that, are classes are automatically converted to C++ classes!</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> cpp <span style=color:#f92672>import</span> magic
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Greeter</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>Greeter</span>(self, name):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> name
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Hello, </span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>!&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_Greeter</span>(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Goodbye, </span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>.&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    greeter1 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    greeter2 <span style=color:#f92672>=</span> Greeter(<span style=color:#ae81ff>2</span>)
</span></span></code></pre></td></tr></table></div></div><h2 id=composable><a href=#composable>Composable<span hidden class=anchor aria-hidden=true href=#composable>#</span></a></h2><p>We&rsquo;ve come a long way so far, and our destructors are called automatically and implicitly.
The next step is making our classes composable.
Or, more specifically - handling members properly.</p><p>Before we do that, let&rsquo;s see where we are now:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BetterArchiveReader</span>:
</span></span><span style=display:flex><span>    zipfile: ZipFile <span style=color:#75715e># This is a type annotation, it does nothing.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>BetterArchiveReader</span>(self, path: str):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>zipfile <span style=color:#f92672>=</span> ZipFile(path)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read</span>(self, name: str):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> self<span style=color:#f92672>.</span>zipfile<span style=color:#f92672>.</span>open(name) <span style=color:#66d9ef>as</span> f:  <span style=color:#75715e># Resource management</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> f<span style=color:#f92672>.</span>read()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_BetterArchiveReader</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>zipfile<span style=color:#f92672>.</span>close()  <span style=color:#75715e># More resource management</span>
</span></span></code></pre></td></tr></table></div></div><p>We have fewer lines, and fewer resource-management lines.
That&rsquo;s great.
But we also have a new issue - double free!
When we create the <code>ZipFile</code> object, it gets pushed into the dtor-scope of the <code>BetterArchiveReader</code> ctor.
Later, when we get to the dtor and call <code>.close()</code> on it, it is already closed!</p><p>To fix that, we need to somehow remove the <code>ZipFile</code> from the function scope, and let the <code>BetterArchiveReader</code> handle it instead.
So something like:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BetterArchiveReader</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>BetterArchiveReader</span>(self, path: str):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>zipfile <span style=color:#f92672>=</span> ZipFile(path)
</span></span><span style=display:flex><span>        remove_dtor(self<span style=color:#f92672>.</span>zipfile)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span></code></pre></td></tr></table></div></div><p>Which would call a <code>.remove</code> method on the current <code>DtorScope</code>:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DtorScope</span>:
</span></span><span style=display:flex><span>    stack: list
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>remove</span>(self, cm):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>stack<span style=color:#f92672>.</span>remove(cm)
</span></span></code></pre></td></tr></table></div></div><p>Which will, unfortunately, fail.
<code>list.remove()</code> checks for equality, not identity.
So if we have multiple object that compare equal - we&rsquo;re in for some painful debugging.
To remedy this, we&rsquo;ll borrow a trick from the C++ playbook and use a comparison object:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>IdentityComparator</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, obj):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>obj <span style=color:#f92672>=</span> obj
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __eq__(self, other):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>obj <span style=color:#f92672>is</span> other
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DtorScope</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>remove</span>(self, cm):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>stack<span style=color:#f92672>.</span>remove(IdentityComparator(cm))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>remove_dtor</span>(cm):
</span></span><span style=display:flex><span>    get_dtor_stack()[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]<span style=color:#f92672>.</span>remove(cm)
</span></span></code></pre></td></tr></table></div></div><p><code>IdentityComparator</code> wraps the object we provide, replacing the equality check with an identity check, resolving the issue.</p><p>And while <code>ZipFile</code> <em>does</em> have a <code>.close</code> method, not all context-managers do.
So we&rsquo;ll make our code a bit more generic with a call to <code>__exit__</code>:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_BetterArchiveReader</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>zipfile<span style=color:#f92672>.</span>__exit__(<span style=color:#66d9ef>None</span>, <span style=color:#66d9ef>None</span>, <span style=color:#66d9ef>None</span>)
</span></span></code></pre></td></tr></table></div></div><p>That&rsquo;s better, but we&rsquo;re back to managing the dtors of our objects manually again.
Instead, we want assignment to a class member to handle all that automatically.</p><h3 id=descriptors><a href=#descriptors>Descriptors<span hidden class=anchor aria-hidden=true href=#descriptors>#</span></a></h3><p>Unlike C++, Python does not have any form of assignment operators.
So we can&rsquo;t use those.
It does, however, have setters and getters.
Before we dive into that bit of syntax, let&rsquo;s look at what we want them to do:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>is_cpp_class</span>(cls):
</span></span><span style=display:flex><span>    <span style=color:#75715e># Use the flag we set earlier to detect C++ classes</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> getattr(cls, <span style=color:#e6db74>&#34;__cpp_class__&#34;</span>, <span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_zipfile</span>(self):
</span></span><span style=display:flex><span>	<span style=color:#75715e># Nothing to do on get - the class maintains ownership.</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> getattr(self, <span style=color:#e6db74>&#34;zipfile&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>set_zipfile</span>(self, zipfile):
</span></span><span style=display:flex><span>    old <span style=color:#f92672>=</span> getattr(self, <span style=color:#e6db74>&#34;zipfile&#34;</span>, <span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># If the old object a C++ class, we destruct it</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> is_cpp_class(old):
</span></span><span style=display:flex><span>        old<span style=color:#f92672>.</span>__exit__(<span style=color:#66d9ef>None</span>, <span style=color:#66d9ef>None</span>, <span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># Then we remove the new object from the scope of the</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># function it was assigned in.</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> is_cpp_class(zipfile):
</span></span><span style=display:flex><span>        remove_dtor(zipfile)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    setattr(self, <span style=color:#e6db74>&#34;zipfile&#34;</span>, zipfile)
</span></span></code></pre></td></tr></table></div></div><p>Naturally, we don&rsquo;t wanna be writing and calling those methods everywhere.
To circumvent that, we&rsquo;ll use &ldquo;descriptors&rdquo;, Python&rsquo;s flavour of getters and setters.</p><p>Any <em>class</em> member variable (class, not instance) that implements <code>__set__</code> and <code>__get__</code> is a descriptor.
When we later access those variables through an instance, those methods are called to set or get the value from the member.
Adjusting our code to use them, we get:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CppMember</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__set_name__</span>(self, owner, name):
</span></span><span style=display:flex><span>	    <span style=color:#75715e># Called on class creation</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>private_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;_&#34;</span> <span style=color:#f92672>+</span> name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __get__(self, instance, owner<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>        <span style=color:#75715e># Called on an instance, when getting the value</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> getattr(instance, self<span style=color:#f92672>.</span>private_name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __set__(self, instance, value):
</span></span><span style=display:flex><span>        <span style=color:#75715e># Called on an instance, when setting the value</span>
</span></span><span style=display:flex><span>        old <span style=color:#f92672>=</span> getattr(instance, self<span style=color:#f92672>.</span>private_name, <span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> is_cpp_class(old):
</span></span><span style=display:flex><span>            old<span style=color:#f92672>.</span>__exit__(<span style=color:#66d9ef>None</span>, <span style=color:#66d9ef>None</span>, <span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> is_cpp_class(value):
</span></span><span style=display:flex><span>            remove_dtor(value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        setattr(instance, self<span style=color:#f92672>.</span>private_name, value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Reader</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># Create zipfile as a class member variable</span>
</span></span><span style=display:flex><span>    zipfile <span style=color:#f92672>=</span> CppMember()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>Reader</span>(self, path):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>zipfile <span style=color:#f92672>=</span> ZipFile(path)
</span></span></code></pre></td></tr></table></div></div><p><code>__set_name__</code> is another descriptor method.
It is called on class creation (when Python creates the <em>class</em> object, not an instance) to pass the variable name to the descriptor.
Then, the descriptor can derive a unique name from it and use it to store the actual value in the instance.</p><p>This takes care of the function-scope.
The next thing to do is make sure when our destructor is called, we call all the member destructors as well.
So in <code>cpp_class</code>, we add a call the member destructors after dealing with the class destructor.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> __exit__(self, exc_type, exc_val, exc_tb):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>  <span style=color:#75715e># Handle class dtor first</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Then handle member dtors in reversed definition order</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> name, value <span style=color:#f92672>in</span> reversed(inspect<span style=color:#f92672>.</span>getmembers(self)):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> name<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#34;_&#34;</span>):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> is_cpp_class(value):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        value<span style=color:#f92672>.</span>__exit__(<span style=color:#66d9ef>None</span>, <span style=color:#66d9ef>None</span>, <span style=color:#66d9ef>None</span>)
</span></span></code></pre></td></tr></table></div></div><p>This leaves us with much nicer code:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BetterArchiveReader</span>:
</span></span><span style=display:flex><span>    zipfile <span style=color:#f92672>=</span> CppMember()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>BetterArchiveReader</span>(self, path):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>zipfile <span style=color:#f92672>=</span> ZipFile(path)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read</span>(self, name: str):
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span></code></pre></td></tr></table></div></div><p>We just assign a <code>ZipFile</code> to a member, and we&rsquo;re good to go.
Our member destructors are called automatically.</p><h3 id=annotations><a href=#annotations>Annotations<span hidden class=anchor aria-hidden=true href=#annotations>#</span></a></h3><p>But&mldr; That <code>zipfile = CppMember()</code> still bothers me.
It shows some plumbing that is better hidden.
And we can do better.</p><p>Python has type annotations.
They look something like:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SomeClass</span>:
</span></span><span style=display:flex><span>    name: SomeType
</span></span></code></pre></td></tr></table></div></div><p>They don&rsquo;t really do anything, but once we use them, Python stores a mapping between <code>name</code> and <code>SomeType</code> inside our <code>SomeClass</code> object.
And if we have a mapping, we can query it:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>create_members</span>(cls):
</span></span><span style=display:flex><span>    <span style=color:#75715e># Query the the member variable annotations for the given class</span>
</span></span><span style=display:flex><span>    member_names <span style=color:#f92672>=</span> list(getattr(cls, <span style=color:#e6db74>&#39;__annotations__&#39;</span>, {}))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> name <span style=color:#f92672>in</span> member_names:
</span></span><span style=display:flex><span>	    <span style=color:#75715e># Create a new CppMember Descriptor object</span>
</span></span><span style=display:flex><span>        member <span style=color:#f92672>=</span> CppMember()
</span></span><span style=display:flex><span>        <span style=color:#75715e># Since we&#39;re modifying an already-created class,</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># we need to call `__set_name__` manually here</span>
</span></span><span style=display:flex><span>        member<span style=color:#f92672>.</span>__set_name__(cls, name)
</span></span><span style=display:flex><span>        <span style=color:#75715e># Assign the newly created descriptor to the class member.</span>
</span></span><span style=display:flex><span>        setattr(cls, name, member)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># This will be useful later</span>
</span></span><span style=display:flex><span>    setattr(cls, <span style=color:#e6db74>&#39;__member_names__&#39;</span>, member_names)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>cpp_class</span>(cls):
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    create_members(cls)
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>def</span> __exit__(self, exc_type, exc_val, exc_tb):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e># We have a list of all members now, so no need</span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e># to use reflection to get it.</span>
</span></span><span style=display:flex><span>	    <span style=color:#66d9ef>for</span> name <span style=color:#f92672>in</span> reversed(self<span style=color:#f92672>.</span>__member_names__):
</span></span><span style=display:flex><span>	        value <span style=color:#f92672>=</span> getattr(self, name, <span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	        <span style=color:#66d9ef>if</span> is_cpp_class(value):
</span></span><span style=display:flex><span>	            value<span style=color:#f92672>.</span>__exit__(<span style=color:#66d9ef>None</span>, <span style=color:#66d9ef>None</span>, <span style=color:#66d9ef>None</span>)
</span></span></code></pre></td></tr></table></div></div><p>And with that, we&rsquo;ve reached our goal!
We can now write our <code>BestArchiveReader</code> as if it was a C++ class:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BestArchiveReader</span>:
</span></span><span style=display:flex><span>    zipfile: ZipFile
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>BestArchiveReader</span>(self, path: str):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>zipfile <span style=color:#f92672>=</span> ZipFile(path)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read</span>(self, name: str):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> self<span style=color:#f92672>.</span>zipfile<span style=color:#f92672>.</span>open(name) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> f<span style=color:#f92672>.</span>read()
</span></span></code></pre></td></tr></table></div></div><h2 id=wrapping-up><a href=#wrapping-up>Wrapping Up<span hidden class=anchor aria-hidden=true href=#wrapping-up>#</span></a></h2><p>We started by looking at Python&rsquo;s take on destructors, and the issues it poses.
Then, we took inspiration from C++ and gradually built a &ldquo;better&rdquo; solution.
We focused on 3 main goals, and achieved them:</p><ol><li>Automatic: destructors are called when / where they are needed.</li><li>Composable: members work automatically, with no added boilerplate.</li><li>Implicit: no extra code; no changes to interfaces; no interface pollution.</li></ol><h3 id=but><a href=#but>But&mldr;<span hidden class=anchor aria-hidden=true href=#but>#</span></a></h3><p>Some of you may have noticed a glaring issue.
Once a value is created in a function, or assigned to a member variable - we can no longer move it.
See, we have ownership, but no move semantics.</p><p>There are some extra tricks we can use (and are used in the library) for returning values, but I don&rsquo;t think the general case is elegantly solvable.</p><h2 id=further-reading><a href=#further-reading>Further Reading<span hidden class=anchor aria-hidden=true href=#further-reading>#</span></a></h2><p>First, thank you for reading this entire post.
If you want to play with the concepts I presented here, check the full implementation, you can check it out <a href=https://github.com/tmr232/cpppy>on my Github</a>.
You&rsquo;ll also find there an implementation of access specifiers, which you&rsquo;re sure to enjoy.</p><p>This was a fun experiment when I first started playing with this, and a fun talk to present.
I hope you have fun with this too.</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://tamir.dev/>Tamir Bahar</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>